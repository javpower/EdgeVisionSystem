name: Build Native Applications

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [ created ]
  workflow_dispatch:

env:
  JAVA_VERSION: "17"

jobs:
  build-windows-cpu:
    runs-on: windows-latest
    name: Build Windows (CPU)

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up GraalVM
      uses: graalvm/setup-graalvm@v1
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'graalvm-community'
        github-token: ${{ secrets.GITHUB_TOKEN }}
        native-image: true

    - name: Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Build Native Image (CPU)
      shell: cmd
      run: |
        mvn clean package "-Pnative" -DskipTests

    - name: Package Application
      shell: pwsh
      run: |
        mkdir dist-cpu
        mkdir dist-cpu\models

        copy target\edge-vision.exe dist-cpu\
        copy src\main\resources\application.yml dist-cpu\
        if (Test-Path "models\*.onnx") { copy models\*.onnx dist-cpu\models\ }

        # OpenCV (x64)
        Get-ChildItem -Path target\native -Recurse -File -Filter "*.dll" |
          Where-Object { $_.Directory -like "*windows\x86_64*" -and $_.Name -like "opencv*.dll" } |
          ForEach-Object { copy $_.FullName dist-cpu\ }

        # ONNX Runtime CPU
        Get-ChildItem -Path target\native -Recurse -File -Filter "*.dll" |
          Where-Object { $_.Name -like "onnxruntime.dll" -and $_.Name -notlike "*gpu*" } |
          ForEach-Object { copy $_.FullName dist-cpu\ }

        # Run script
        "@echo off
        edge-vision.exe --spring.config.additional-location=application.yml
        pause" | Out-File -FilePath dist-cpu\run.bat -Encoding ASCII

    - name: Upload Windows CPU Artifact
      uses: actions/upload-artifact@v4
      with:
        name: edge-vision-windows-cpu
        path: dist-cpu/
        compression-level: 9

  build-windows-gpu:
    runs-on: windows-latest
    name: Build Windows (GPU)

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up GraalVM
      uses: graalvm/setup-graalvm@v1
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'graalvm-community'
        github-token: ${{ secrets.GITHUB_TOKEN }}
        native-image: true

    - name: Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Build Native Image (GPU)
      shell: cmd
      run: |
        mvn clean package "-Pnative,gpu" -DskipTests

    - name: Package Application
      shell: pwsh
      run: |
        mkdir dist-gpu
        mkdir dist-gpu\models

        copy target\edge-vision.exe dist-gpu\
        copy src\main\resources\application.yml dist-gpu\
        if (Test-Path "models\*.onnx") { copy models\*.onnx dist-gpu\models\ }

        # OpenCV (x64)
        Get-ChildItem -Path target\native -Recurse -File -Filter "*.dll" |
          Where-Object { $_.Directory -like "*windows\x86_64*" -and $_.Name -like "opencv*.dll" } |
          ForEach-Object { copy $_.FullName dist-gpu\ }

        # ONNX Runtime GPU
        Get-ChildItem -Path target\native -Recurse -File -Filter "*.dll" |
          Where-Object { $_.Directory -like "*win-x64*" } |
          ForEach-Object { copy $_.FullName dist-gpu\ }

        # Run script
        "@echo off
        echo This version requires NVIDIA GPU with CUDA
        edge-vision.exe --spring.config.additional-location=application.yml
        pause" | Out-File -FilePath dist-gpu\run.bat -Encoding ASCII

    - name: Upload Windows GPU Artifact
      uses: actions/upload-artifact@v4
      with:
        name: edge-vision-windows-gpu
        path: dist-gpu/
        compression-level: 9

  build-linux-cpu:
    runs-on: ubuntu-latest
    name: Build Linux (CPU)

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up GraalVM
      uses: graalvm/setup-graalvm@v1
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'graalvm-community'
        github-token: ${{ secrets.GITHUB_TOKEN }}
        native-image: true

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libstdc++-12-dev

    - name: Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Build Native Image (CPU)
      run: |
        mvn clean package -Pnative -DskipTests

    - name: Package Application
      run: |
        mkdir -p dist-cpu/models

        cp target/edge-vision dist-cpu/
        cp src/main/resources/application.yml dist-cpu/
        if compgen -G "models/*.onnx" > /dev/null; then
          cp models/*.onnx dist-cpu/models/
        fi

        # OpenCV + ONNX Runtime CPU
        find target/native -path "*/linux/x86_64/*.so" -name "libopencv*.so" -exec cp {} dist-cpu/ \;
        find target/native -name "libonnxruntime.so" -exec cp {} dist-cpu/ \;
        find target/native -name "libonnxruntime4j_jni.so" -exec cp {} dist-cpu/ \;

        # 创建符号链接
        cd dist-cpu
        ln -sf libonnxruntime.so libonnxruntime.so.1.17.3

        # Run script
        cat > run.sh << 'EOF'
        #!/bin/bash
        DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
        cd "$DIR"
        ./edge-vision --spring.config.additional-location=application.yml
        EOF
        chmod +x run.sh
        cd ..

    - name: Show file sizes
      run: |
        echo "CPU Build File sizes:"
        du -h dist-cpu/*

    - name: Upload Linux CPU Artifact
      uses: actions/upload-artifact@v4
      with:
        name: edge-vision-linux-cpu
        path: dist-cpu/
        compression-level: 9

  build-linux-gpu:
    runs-on: ubuntu-latest
    name: Build Linux (GPU)

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up GraalVM
      uses: graalvm/setup-graalvm@v1
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'graalvm-community'
        github-token: ${{ secrets.GITHUB_TOKEN }}
        native-image: true

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libstdc++-12-dev

    - name: Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Build Native Image (GPU)
      run: |
        mvn clean package -Pnative,gpu -DskipTests

    - name: Package Application
      run: |
        mkdir -p dist-gpu/models

        cp target/edge-vision dist-gpu/
        cp src/main/resources/application.yml dist-gpu/
        if compgen -G "models/*.onnx" > /dev/null; then
          cp models/*.onnx dist-gpu/models/
        fi

        # OpenCV + ONNX Runtime GPU
        find target/native -path "*/linux/x86_64/*.so" -name "libopencv*.so" -exec cp {} dist-gpu/ \;
        find target/native -path "*/linux-x64/*.so" -exec cp {} dist-gpu/ \;

        # 创建符号链接
        cd dist-gpu
        ln -sf libonnxruntime.so libonnxruntime.so.1.17.3

        # Run script
        cat > run.sh << 'EOF'
        #!/bin/bash
        DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

        # 检查 GPU
        if ! command -v nvidia-smi &> /dev/null; then
            echo "ERROR: nvidia-smi not found. This version requires NVIDIA GPU."
            echo "Please use the CPU version instead."
            exit 1
        fi

        # CUDA 库路径
        if [ -d "/usr/local/cuda/lib64" ]; then
            export LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH
        fi

        cd "$DIR"
        ./edge-vision --spring.config.additional-location=application.yml
        EOF
        chmod +x run.sh
        cd ..

    - name: Show file sizes
      run: |
        echo "GPU Build File sizes:"
        du -h dist-gpu/*

    - name: Upload Linux GPU Artifact
      uses: actions/upload-artifact@v4
      with:
        name: edge-vision-linux-gpu
        path: dist-gpu/
        compression-level: 9

  create-release:
    needs: [build-windows-cpu, build-windows-gpu, build-linux-cpu, build-linux-gpu]
    runs-on: ubuntu-latest
    if: github.event_name == 'release'

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Create release archives
      run: |
        # Windows
        cd edge-vision-windows-cpu
        zip -r ../edge-vision-windows-cpu.zip .
        cd ../edge-vision-windows-gpu
        zip -r ../edge-vision-windows-gpu.zip .
        cd ..

        # Linux
        cd edge-vision-linux-cpu
        tar -czf ../edge-vision-linux-cpu.tar.gz .
        cd ../edge-vision-linux-gpu
        tar -czf ../edge-vision-linux-gpu.tar.gz .
        cd ..

    - name: Show archive sizes
      run: |
        echo "Archive sizes:"
        du -h *.zip *.tar.gz

    - name: Upload release assets
      uses: softprops/action-gh-release@v1
      with:
        files: |
          edge-vision-windows-cpu.zip
          edge-vision-windows-gpu.zip
          edge-vision-linux-cpu.tar.gz
          edge-vision-linux-gpu.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
