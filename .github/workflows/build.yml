name: Build Application

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [ created ]
  workflow_dispatch:

env:
  JAVA_VERSION: "17"

jobs:
  build-cpu:
    runs-on: ${{ matrix.os }}
    name: Build CPU (${{ matrix.os }})

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Build Spring Boot JAR (CPU)
      run: mvn clean package -DskipTests

    - name: Create custom JRE with jlink (Windows)
      if: runner.os == 'Windows'
      shell: cmd
      run: |
        jlink --add-modules java.base,java.sql,java.naming,java.desktop,java.management,java.net.http,java.xml,jdk.unsupported,jdk.security.jgss,java.instrument,jdk.crypto.cryptoki,jdk.charsets --output jre --compress 2 --no-header-files --no-man-pages
        if exist jre\bin\java.exe (echo JRE created successfully) else (echo JRE creation failed && exit /b 1)
        dir jre\bin

    - name: Create custom JRE with jlink (Unix)
      if: runner.os != 'Windows'
      run: |
        echo "Creating JRE with jlink..."
        jlink --add-modules java.base,java.sql,java.naming,java.desktop,java.management,java.net.http,java.xml,jdk.unsupported,jdk.security.jgss,java.instrument,jdk.crypto.cryptoki,jdk.charsets \
              --output jre \
              --compress 2 \
              --no-header-files \
              --no-man-pages

        # Verify JRE was created
        if [ ! -f "jre/bin/java" ]; then
          echo "ERROR: jre/bin/java not found after jlink!"
          ls -la
          if [ -d "jre" ]; then
            echo "JRE directory exists but bin/java not found:"
            ls -la jre/
          fi
          exit 1
        fi
        echo "JRE created successfully"
        ls -la jre/bin/

    - name: Prepare distribution (Windows)
      if: runner.os == 'Windows'
      shell: cmd
      run: |
        mkdir dist
        if not exist jre\bin\java.exe (
          echo ERROR: jre\bin\java.exe not found!
          dir jre
          exit /b 1
        )

        # Copy JAR
        copy target\edge-vision-system-*.jar dist\edge-vision.jar

        # Copy config
        copy src\main\resources\application.yml dist\

        # Copy custom JRE
        xcopy jre dist\jre\ /E /I /Y

        # Verify JRE was copied
        if not exist dist\jre\bin\java.exe (
          echo ERROR: dist\jre\bin\java.exe not found after copy!
          exit /b 1
        )

        # Copy models if exist
        if exist models\*.onnx (
          mkdir dist\models
          copy models\*.onnx dist\models\
        )

        # Show final structure
        echo.
        echo Final dist structure:
        dir /s /b dist

    - name: Prepare distribution (Unix)
      if: runner.os != 'Windows'
      run: |
        mkdir -p dist

        # Verify JRE exists before copying
        if [ ! -f "jre/bin/java" ]; then
          echo "ERROR: jre/bin/java not found!"
          echo "Current directory contents:"
          ls -la
          if [ -d "jre" ]; then
            echo "JRE directory contents:"
            ls -la jre/
            if [ -d "jre/bin" ]; then
              echo "JRE bin contents:"
              ls -la jre/bin/
            fi
          fi
          exit 1
        fi

        echo "JRE verified, copying to dist..."

        # Copy JAR
        cp target/edge-vision-system-*.jar dist/edge-vision.jar

        # Copy config
        cp src/main/resources/application.yml dist/

        # Copy custom JRE
        cp -r jre dist/

        # Verify JRE was copied
        if [ ! -f "dist/jre/bin/java" ]; then
          echo "ERROR: dist/jre/bin/java not found after copy!"
          exit 1
        fi

        # Copy models if exist
        if compgen -G "models/*.onnx" > /dev/null; then
          mkdir -p dist/models
          cp models/*.onnx dist/models/
        fi

        # Show final structure
        echo ""
        echo "Final dist structure:"
        find dist -type f | head -20

    - name: Create run script (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        "@echo off
        jre\bin\java.exe -jar edge-vision.jar --spring.config.additional-location=application.yml
        pause" | Out-File -FilePath dist\run.bat -Encoding ASCII

    - name: Create run script (Unix)
      if: runner.os != 'Windows'
      run: |
        cat > dist/run.sh << 'EOF'
        #!/bin/bash
        DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
        cd "$DIR"
        exec "$DIR/jre/bin/java" -jar edge-vision.jar --spring.config.additional-location=application.yml
        EOF
        chmod +x dist/run.sh

    - name: Verify package (Windows)
      if: runner.os == 'Windows'
      shell: cmd
      run: |
        cd dist
        if not exist edge-vision.jar (
          echo ERROR: edge-vision.jar not found!
          dir
          exit /b 1
        )
        if not exist jre\bin\java.exe (
          echo ERROR: jre\bin\java.exe not found!
          dir jre\bin
          exit /b 1
        )
        echo Files verified, starting application...
        start /B jre\bin\java.exe -jar edge-vision.jar --server.port=8888 > app.log 2>&1
        echo Waiting for application to start...
        timeout /t 45 /nobreak
        echo.
        echo Application log:
        type app.log
        echo.
        echo Testing health endpoint...
        curl http://localhost:8888/actuator/health
        echo.
        echo Stopping application...
        for /f "tokens=2" %%a in ('tasklist /FI "IMAGENAME eq java.exe" ^| find "java.exe"') do taskkill /F /PID %%a 2>nul
        timeout /t 2 /nobreak
        echo Verification complete

    - name: Verify package (Unix)
      if: runner.os != 'Windows'
      run: |
        echo "Starting application..."
        cd dist
        ./jre/bin/java -jar edge-vision.jar --spring.config.additional-location=application.yml --server.port=8888 &
        JAVA_PID=$!
        echo "Waiting for application to start (PID: $JAVA_PID)..."
        sleep 30
        echo "Testing health endpoint..."
        curl -s http://localhost:8888/actuator/health
        echo "Stopping application..."
        kill $JAVA_PID 2>/dev/null || true
        wait $JAVA_PID 2>/dev/null || true

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: edge-vision-cpu-${{ runner.os }}
        path: dist/
        compression-level: 9

  build-gpu:
    runs-on: ${{ matrix.os }}
    name: Build GPU (${{ matrix.os }})

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Build Spring Boot JAR (GPU)
      run: mvn clean package -Pgpu -DskipTests

    - name: Create custom JRE with jlink (Windows)
      if: runner.os == 'Windows'
      shell: cmd
      run: |
        jlink --add-modules java.base,java.sql,java.naming,java.desktop,java.management,java.net.http,java.xml,jdk.unsupported,jdk.security.jgss,java.instrument,jdk.crypto.cryptoki,jdk.charsets --output jre --compress 2 --no-header-files --no-man-pages
        if exist jre\bin\java.exe (echo JRE created successfully) else (echo JRE creation failed && exit /b 1)
        dir jre\bin

    - name: Create custom JRE with jlink (Unix)
      if: runner.os != 'Windows'
      run: |
        echo "Creating JRE with jlink..."
        jlink --add-modules java.base,java.sql,java.naming,java.desktop,java.management,java.net.http,java.xml,jdk.unsupported,jdk.security.jgss,java.instrument,jdk.crypto.cryptoki,jdk.charsets \
              --output jre \
              --compress 2 \
              --no-header-files \
              --no-man-pages

        # Verify JRE was created
        if [ ! -f "jre/bin/java" ]; then
          echo "ERROR: jre/bin/java not found after jlink!"
          ls -la
          if [ -d "jre" ]; then
            echo "JRE directory exists but bin/java not found:"
            ls -la jre/
          fi
          exit 1
        fi
        echo "JRE created successfully"
        ls -la jre/bin/

    - name: Prepare distribution (Windows)
      if: runner.os == 'Windows'
      shell: cmd
      run: |
        mkdir dist
        if not exist jre\bin\java.exe (
          echo ERROR: jre\bin\java.exe not found!
          dir jre
          exit /b 1
        )

        # Copy JAR
        copy target\edge-vision-system-*.jar dist\edge-vision.jar

        # Copy config
        copy src\main\resources\application.yml dist\

        # Copy custom JRE
        xcopy jre dist\jre\ /E /I /Y

        # Verify JRE was copied
        if not exist dist\jre\bin\java.exe (
          echo ERROR: dist\jre\bin\java.exe not found after copy!
          exit /b 1
        )

        # Copy models if exist
        if exist models\*.onnx (
          mkdir dist\models
          copy models\*.onnx dist\models\
        )

        # Show final structure
        echo.
        echo Final dist structure:
        dir /s /b dist

    - name: Prepare distribution (Unix)
      if: runner.os != 'Windows'
      run: |
        mkdir -p dist

        # Verify JRE exists before copying
        if [ ! -f "jre/bin/java" ]; then
          echo "ERROR: jre/bin/java not found!"
          echo "Current directory contents:"
          ls -la
          if [ -d "jre" ]; then
            echo "JRE directory contents:"
            ls -la jre/
            if [ -d "jre/bin" ]; then
              echo "JRE bin contents:"
              ls -la jre/bin/
            fi
          fi
          exit 1
        fi

        echo "JRE verified, copying to dist..."

        # Copy JAR
        cp target/edge-vision-system-*.jar dist/edge-vision.jar

        # Copy config
        cp src/main/resources/application.yml dist/

        # Copy custom JRE
        cp -r jre dist/

        # Verify JRE was copied
        if [ ! -f "dist/jre/bin/java" ]; then
          echo "ERROR: dist/jre/bin/java not found after copy!"
          exit 1
        fi

        # Copy models if exist
        if compgen -G "models/*.onnx" > /dev/null; then
          mkdir -p dist/models
          cp models/*.onnx dist/models/
        fi

        # Show final structure
        echo ""
        echo "Final dist structure:"
        find dist -type f | head -20

    - name: Create run script (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        "@echo off
        echo This version requires NVIDIA GPU with CUDA
        jre\bin\java.exe -jar edge-vision.jar --spring.config.additional-location=application.yml
        pause" | Out-File -FilePath dist\run.bat -Encoding ASCII

    - name: Create run script (Unix)
      if: runner.os != 'Windows'
      run: |
        cat > dist/run.sh << 'EOF'
        #!/bin/bash
        DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

        # Check for NVIDIA GPU
        if ! command -v nvidia-smi &> /dev/null; then
            echo "ERROR: nvidia-smi not found. This version requires NVIDIA GPU."
            echo "Please use the CPU version instead."
            exit 1
        fi

        cd "$DIR"
        exec "$DIR/jre/bin/java" -jar edge-vision.jar --spring.config.additional-location=application.yml
        EOF
        chmod +x dist/run.sh

    - name: Verify package (Windows)
      if: runner.os == 'Windows'
      shell: cmd
      run: |
        cd dist
        if not exist edge-vision.jar (
          echo ERROR: edge-vision.jar not found!
          dir
          exit /b 1
        )
        if not exist jre\bin\java.exe (
          echo ERROR: jre\bin\java.exe not found!
          dir jre\bin
          exit /b 1
        )
        echo Files verified, starting application...
        start /B jre\bin\java.exe -jar edge-vision.jar --server.port=8888 > app.log 2>&1
        echo Waiting for application to start...
        timeout /t 45 /nobreak
        echo.
        echo Application log:
        type app.log
        echo.
        echo Testing health endpoint...
        curl http://localhost:8888/actuator/health
        echo.
        echo Stopping application...
        for /f "tokens=2" %%a in ('tasklist /FI "IMAGENAME eq java.exe" ^| find "java.exe"') do taskkill /F /PID %%a 2>nul
        timeout /t 2 /nobreak
        echo Verification complete

    - name: Verify package (Unix)
      if: runner.os != 'Windows'
      run: |
        echo "Starting application..."
        cd dist
        ./jre/bin/java -jar edge-vision.jar --spring.config.additional-location=application.yml --server.port=8888 &
        JAVA_PID=$!
        echo "Waiting for application to start (PID: $JAVA_PID)..."
        sleep 30
        echo "Testing health endpoint..."
        curl -s http://localhost:8888/actuator/health
        echo "Stopping application..."
        kill $JAVA_PID 2>/dev/null || true
        wait $JAVA_PID 2>/dev/null || true

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: edge-vision-gpu-${{ runner.os }}
        path: dist/
        compression-level: 9

  create-release:
    needs: [build-cpu, build-gpu]
    runs-on: ubuntu-latest
    if: github.event_name == 'release'

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Create release archives
      run: |
        for dir in edge-vision-*/; do
          name="${dir%/}"
          if [[ "$name" == *Linux* ]]; then
            tar -czf "${name}.tar.gz" "$dir"
          else
            zip -r "${name}.zip" "$dir"
          fi
        done

    - name: Show archive sizes
      run: |
        echo "Archive sizes:"
        du -h *.zip *.tar.gz 2>/dev/null || true

    - name: Upload release assets
      uses: softprops/action-gh-release@v1
      with:
        files: |
          *.zip
          *.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
