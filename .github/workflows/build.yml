name: Build Native Applications

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [ created ]

jobs:
  build-windows:
    runs-on: windows-latest
    name: Build Windows Native Executable
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Set up GraalVM
      uses: graalvm/setup-graalvm@v1
      with:
        java-version: '17'
        distribution: 'graalvm-community'
        github-token: ${{ secrets.GITHUB_TOKEN }}
        native-image: true
        
    - name: Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Build with Maven
      shell: pwsh
      run: |
        mvn clean compile

    - name: Build Native Image
      shell: pwsh
      run: |
        mvn '-Pnative,gpu' package -DskipTests

    - name: Package Application
      shell: pwsh
      run: |
        mkdir dist
        mkdir dist\models
        copy target\edge-vision.exe dist\edge-vision.exe
        copy src\main\resources\application.yml dist\
        if (Test-Path "models\*.onnx") {
          copy models\*.onnx dist\models\
        }

        Write-Host "Copying native libraries from Maven-extracted files..."

        # 复制 OpenCV 库 (openpnp 路径)
        $opencvPath = "target\native\nu\pattern\opencv\windows\x86_64\opencv_java470.dll"
        if (Test-Path $opencvPath) {
          copy $opencvPath dist\
          Write-Host "OpenCV library copied successfully"
        } else {
          Write-Host "Warning: OpenCV library not found at $opencvPath"
        }

        # 复制 ONNX Runtime GPU 库（使用 -Pgpu 时）
        # 复制所有 ONNX Runtime 相关的 DLL 文件
        $onnxCopied = $false
        $dllFiles = Get-ChildItem -Path target\native -Filter "*onnx*.dll" -Recurse -ErrorAction SilentlyContinue
        foreach ($dll in $dllFiles) {
          copy $dll.FullName dist\
          Write-Host "ONNX Runtime library copied: $($dll.Name)"
          $onnxCopied = $true
        }

        if (-not $onnxCopied) {
          Write-Host "Warning: No ONNX Runtime libraries found"
        }

        # 如果还是没有找到，列出可用文件
        if (-not (Test-Path "dist\opencv_java470.dll") -or -not (Test-Path "dist\onnxruntime.dll")) {
          Write-Host "Available files in target\native:"
          Get-ChildItem -Path target\native -Recurse -File | Select-Object -First 20 FullName
        }

        "@echo off" | Out-File -FilePath dist\run.bat -Encoding ASCII
        "" | Out-File -FilePath dist\run.bat -Append -Encoding ASCII
        "echo Starting Edge Vision System..." | Out-File -FilePath dist\run.bat -Append -Encoding ASCII
        "echo." | Out-File -FilePath dist\run.bat -Append -Encoding ASCII
        "echo Note: To use GPU acceleration, ensure NVIDIA drivers and CUDA are installed." | Out-File -FilePath dist\run.bat -Append -Encoding ASCII
        "echo." | Out-File -FilePath dist\run.bat -Append -Encoding ASCII
        "edge-vision.exe --spring.config.additional-location=application.yml" | Out-File -FilePath dist\run.bat -Append -Encoding ASCII
        "pause" | Out-File -FilePath dist\run.bat -Append -Encoding ASCII

    - name: Upload Windows Artifact
      uses: actions/upload-artifact@v4
      with:
        name: edge-vision-windows
        path: dist/
        
  build-linux:
    runs-on: ubuntu-latest
    name: Build Linux Native Executable
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Set up GraalVM
      uses: graalvm/setup-graalvm@v1
      with:
        java-version: '17'
        distribution: 'graalvm-community'
        github-token: ${{ secrets.GITHUB_TOKEN }}
        native-image: true
        
    - name: Install OpenCV dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libopencv-dev libopencv-contrib-dev
        
    - name: Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Build with Maven
      run: |
        mvn clean compile

    - name: Build Native Image
      run: |
        mvn -Pnative,gpu package -DskipTests

    - name: Create AppImage
      run: |
        set +e
        mkdir -p dist
        mkdir -p dist/models
        cp target/edge-vision dist/
        cp src/main/resources/application.yml dist/
        if compgen -G "models/*.onnx" > /dev/null; then cp models/*.onnx dist/models/; fi

        # 复制 Maven 已提取的 native 库
        echo "Copying native libraries from Maven-extracted files..."

        # 复制 OpenCV 库 (openpnp 路径)
        if [ -f "target/native/nu/pattern/opencv/linux/x86_64/libopencv_java470.so" ]; then
            cp target/native/nu/pattern/opencv/linux/x86_64/libopencv_java470.so dist/
            echo "OpenCV library copied successfully"
        else
            echo "Warning: OpenCV library not found"
        fi

        # 复制 ONNX Runtime GPU 库（使用 -Pgpu 时）
        # 复制所有 ONNX Runtime 相关的 .so 文件
        onnx_copied=false
        for onnx_file in $(find target/native -name "*onnx*.so" 2>/dev/null); do
            cp "$onnx_file" dist/
            echo "ONNX Runtime library copied: $(basename $onnx_file)"
            onnx_copied=true
        done

        if [ "$onnx_copied" = false ]; then
            echo "Warning: No ONNX Runtime libraries found"
        fi

        # 列出可用文件（用于调试）
        if [ ! -f "dist/libopencv_java470.so" ] || [ ! -f "dist/libonnxruntime.so" ] && [ ! -f "dist/libonnxruntime_gpu.so" ]; then
            echo "Available files in target/native:"
            find target/native -type f 2>/dev/null | head -20 || echo "target/native directory not found"
        fi

        # Create AppImage structure
        mkdir -p dist/AppDir/usr/bin
        mkdir -p dist/AppDir/usr/share/applications
        mkdir -p dist/AppDir/usr/share/icons

        cp target/edge-vision dist/AppDir/usr/bin/

        # Create desktop file
        cat > dist/AppDir/edge-vision.desktop << 'EOF'
        [Desktop Entry]
        Name=Edge Vision System
        Exec=edge-vision
        Icon=edge-vision
        Type=Application
        Categories=Development;
        EOF

        # Download AppImage tool (固定版本)
        wget -q https://github.com/AppImage/AppImageKit/releases/download/13/appimagetool-x86_64.AppImage
        chmod +x appimagetool-x86_64.AppImage

        # Create AppImage (可能失败，继续执行)
        ./appimagetool-x86_64.AppImage dist/AppDir dist/edge-vision-x86_64.AppImage || true

        # Create run script with CUDA support
        cat > dist/run.sh << 'EOF'
#!/bin/bash
# 添加 CUDA 库路径（如果存在）
if [ -d "/usr/local/cuda/lib64" ]; then
    export LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH
fi

# 检查 NVIDIA 驱动
if ! command -v nvidia-smi &> /dev/null; then
    echo "Warning: nvidia-smi not found. GPU acceleration will not be available."
    echo "To use GPU, ensure NVIDIA drivers are installed."
fi

# 运行应用
./edge-vision --spring.config.additional-location=application.yml
EOF
        chmod +x dist/run.sh

    - name: Upload Linux Artifact
      uses: actions/upload-artifact@v4
      with:
        name: edge-vision-linux
        path: dist/
        
  build-macos:
    runs-on: macos-latest
    name: Build macOS Native Executable
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Set up GraalVM
      uses: graalvm/setup-graalvm@v1
      with:
        java-version: '17'
        distribution: 'graalvm-community'
        github-token: ${{ secrets.GITHUB_TOKEN }}
        native-image: true
        
    - name: Install OpenCV
      run: |
        brew install opencv

    - name: Free up disk space
      run: |
        df -h
        sudo rm -rf /Users/runner/work/_temp
        df -h

    - name: Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Build with Maven
      run: |
        export JAVA_HOME=$GRAALVM_HOME
        mvn clean compile

    - name: Build Native Image
      run: |
        export JAVA_HOME=$GRAALVM_HOME
        mvn -Pnative package -DskipTests

    - name: Create DMG
      run: |
        set +e
        mkdir -p dist
        mkdir -p dist/models
        cp target/edge-vision dist/
        cp src/main/resources/application.yml dist/
        if compgen -G "models/*.onnx" > /dev/null; then cp models/*.onnx dist/models/; fi

        # 复制 Maven 已提取的 native 库
        echo "Copying native libraries from Maven-extracted files..."

        # 复制 OpenCV 库 (openpnp 路径，使用 osx 而不是 macosx)
        # 尝试 ARM64 (ARMv8)，回退到 x86_64
        if [ -f "target/native/nu/pattern/opencv/osx/ARMv8/libopencv_java470.dylib" ]; then
            cp target/native/nu/pattern/opencv/osx/ARMv8/libopencv_java470.dylib dist/libopencv_java470.dylib
            echo "OpenCV library (ARM64) copied successfully"
        elif [ -f "target/native/nu/pattern/opencv/osx/x86_64/libopencv_java470.dylib" ]; then
            cp target/native/nu/pattern/opencv/osx/x86_64/libopencv_java470.dylib dist/libopencv_java470.dylib
            echo "OpenCV library (x86_64) copied successfully"
        else
            echo "Warning: OpenCV library not found"
        fi

        # 复制 ONNX Runtime 库 (CPU版本)
        # 复制所有 ONNX Runtime 相关的 .dylib 文件
        onnx_copied=false
        for onnx_file in $(find target/native -name "*onnx*.dylib" -o -name "*onnxruntime*.dylib" 2>/dev/null); do
            cp "$onnx_file" dist/
            echo "ONNX Runtime library copied: $(basename $onnx_file)"
            onnx_copied=true
        done

        # 特别查找 JNI 库 (可能不符合上面的命名模式)
        if [ ! -f "dist/libonnxruntime4j_jni.dylib" ]; then
            jni_file=$(find target/native -name "libonnxruntime4j_jni.dylib" 2>/dev/null | head -1)
            if [ -n "$jni_file" ]; then
                cp "$jni_file" dist/
                echo "ONNX Runtime JNI library copied: $(basename $jni_file)"
                onnx_copied=true
            fi
        fi

        if [ "$onnx_copied" = false ]; then
            echo "Warning: No ONNX Runtime libraries found"
        fi

        # 列出可用文件（用于调试）
        if [ ! -f "dist/libopencv_java470.dylib" ] || [ ! -f "dist/libonnxruntime.dylib" ]; then
            echo "Available files in target/native:"
            find target/native -type f 2>/dev/null | head -20 || echo "target/native directory not found"
        fi

        # Create app bundle
        mkdir -p "dist/Edge Vision.app/Contents/MacOS"
        mkdir -p "dist/Edge Vision.app/Contents/Resources"

        cp target/edge-vision "dist/Edge Vision.app/Contents/MacOS/edge-vision"

        # 复制 native 库到 .app 包内（与可执行文件同目录）
        # 从 dist/ 复制（之前已经从 target/native 复制到 dist）
        if [ -f "dist/libopencv_java470.dylib" ]; then
            cp dist/libopencv_java470.dylib "dist/Edge Vision.app/Contents/MacOS/"
            echo "OpenCV library copied to .app bundle"
        else
            echo "Warning: OpenCV library not found in dist/"
        fi

        # 复制所有 ONNX Runtime 库到 .app 包
        for onnx_lib in dist/*onnx*.dylib; do
            if [ -f "$onnx_lib" ]; then
                cp "$onnx_lib" "dist/Edge Vision.app/Contents/MacOS/"
                echo "ONNX Runtime library copied to .app bundle: $(basename $onnx_lib)"
            fi
        done

        # Create Info.plist
        cat > "dist/Edge Vision.app/Contents/Info.plist" << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>edge-vision</string>
            <key>CFBundleIdentifier</key>
            <string>com.edge.vision</string>
            <key>CFBundleName</key>
            <string>Edge Vision System</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleShortVersionString</key>
            <string>1.0.0</string>
            <key>LSMinimumSystemVersion</key>
            <string>10.15</string>
        </dict>
        </plist>
        EOF

        chmod +x "dist/Edge Vision.app/Contents/MacOS/edge-vision"

        # 验证 .app 包内的文件
        echo "Verifying .app bundle contents:"
        ls -la "dist/Edge Vision.app/Contents/MacOS/"

        # Create run script
        echo "#!/bin/bash" > dist/run.sh
        echo "./edge-vision --spring.config.additional-location=application.yml" >> dist/run.sh
        chmod +x dist/run.sh

        # 验证
        ls -la "dist/Edge Vision.app/Contents/MacOS/"
        echo "DMG creation skipped to save disk space"
        
    - name: Upload macOS Artifact
      uses: actions/upload-artifact@v4
      with:
        name: edge-vision-macos
        path: dist/
        
  create-release:
    needs: [build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      
    - name: Create release archives
      run: |
        cd edge-vision-windows
        zip -r ../edge-vision-windows.zip .
        cd ..
        
        cd edge-vision-linux
        tar -czf ../edge-vision-linux.tar.gz .
        cd ..
        
        cd edge-vision-macos
        zip -r ../edge-vision-macos.zip .
        cd ..
        
    - name: Upload release assets
      uses: softprops/action-gh-release@v1
      with:
        files: |
          edge-vision-windows.zip
          edge-vision-linux.tar.gz
          edge-vision-macos.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}