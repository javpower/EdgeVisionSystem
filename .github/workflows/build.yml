name: Build Native Applications

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [ created ]
  workflow_dispatch:

env:
  JAVA_VERSION: "17"

jobs:
  build-windows:
    runs-on: windows-latest
    name: Build Windows Native Executable

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up GraalVM
      uses: graalvm/setup-graalvm@v1
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'graalvm-community'
        github-token: ${{ secrets.GITHUB_TOKEN }}
        native-image: true

    - name: Verify GraalVM
      shell: pwsh
      run: |
        native-image --version

    - name: Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Build Native Image with GPU support
      shell: cmd
      run: |
        mvn clean package "-Pnative,gpu" -DskipTests

    - name: Package Application
      shell: pwsh
      run: |
        mkdir dist
        mkdir dist\models

        # 复制可执行文件
        copy target\edge-vision.exe dist\

        # 复制配置文件
        copy src\main\resources\application.yml dist\

        # 复制模型文件
        if (Test-Path "models\*.onnx") {
          copy models\*.onnx dist\models\
        }

        # 复制 Native 库
        Write-Host "Copying native libraries..."
        Get-ChildItem -Path target\native -Recurse -File | ForEach-Object {
          if ($_.Extension -in '.dll', '.so', '.dylib') {
            copy $_.FullName dist\
            Write-Host "Copied: $($_.Name)"
          }
        }

        # 创建启动脚本
        @"
        @echo off
        echo Starting Edge Vision System...
        echo Note: GPU acceleration requires NVIDIA drivers and CUDA
        edge-vision.exe --spring.config.additional-location=application.yml
        pause
        "@ | Out-File -FilePath dist\run.bat -Encoding ASCII

    - name: Show file sizes
      shell: pwsh
      run: |
        Write-Host "File sizes:"
        Get-ChildItem -Path dist -Recurse -File | Format-Table Name, Length -AutoSize

    - name: Upload Windows Artifact
      uses: actions/upload-artifact@v4
      with:
        name: edge-vision-windows
        path: dist/
        compression-level: 9

  build-linux:
    runs-on: ubuntu-latest
    name: Build Linux Native Executable

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up GraalVM
      uses: graalvm/setup-graalvm@v1
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'graalvm-community'
        github-token: ${{ secrets.GITHUB_TOKEN }}
        native-image: true

    - name: Verify GraalVM
      run: |
        native-image --version

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libstdc++-12-dev

    - name: Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Build Native Image with GPU support
      run: |
        mvn clean package -Pnative,gpu -DskipTests

    - name: Package Application
      run: |
        mkdir -p dist/models

        # 复制可执行文件
        cp target/edge-vision dist/

        # 复制配置文件
        cp src/main/resources/application.yml dist/

        # 复制模型文件
        if compgen -G "models/*.onnx" > /dev/null; then
          cp models/*.onnx dist/models/
        fi

        # 复制 Native 库
        echo "Copying native libraries..."
        find target/native -type f \( -name "*.so" -o -name "*.dll" -o -name "*.dylib" \) -exec cp {} dist/ \;

        # 创建启动脚本
        cat > dist/run.sh << 'EOF'
        #!/bin/bash
        # 添加 CUDA 库路径（如果存在）
        if [ -d "/usr/local/cuda/lib64" ]; then
            export LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH
        fi
        # 检查 NVIDIA 驱动
        if ! command -v nvidia-smi &> /dev/null; then
            echo "Warning: nvidia-smi not found. GPU acceleration will not be available."
            echo "To use GPU, ensure NVIDIA drivers are installed."
        fi
        # 运行应用
        ./edge-vision --spring.config.additional-location=application.yml
        EOF
        chmod +x dist/run.sh

    - name: Show file sizes
      run: |
        echo "File sizes:"
        du -h dist/*

    - name: Upload Linux Artifact
      uses: actions/upload-artifact@v4
      with:
        name: edge-vision-linux
        path: dist/
        compression-level: 9

  create-release:
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    if: github.event_name == 'release'

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Create release archives
      run: |
        cd edge-vision-windows
        zip -r ../edge-vision-windows.zip .
        cd ..

        cd edge-vision-linux
        tar -czf ../edge-vision-linux.tar.gz .
        cd ..

    - name: Show archive sizes
      run: |
        echo "Archive sizes:"
        du -h *.zip *.tar.gz

    - name: Upload release assets
      uses: softprops/action-gh-release@v1
      with:
        files: |
          edge-vision-windows.zip
          edge-vision-linux.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
