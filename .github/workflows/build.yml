name: Build Application

on:
  workflow_dispatch:
    inputs:
      build_version:
        description: 'Build version (optional)'
        required: false
        type: string
      release:
        description: 'Create release'
        required: false
        type: boolean
        default: false
  release:
    types: [ created ]

env:
  JAVA_VERSION: "17"

jobs:
  build-cpu:
    runs-on: ${{ matrix.os }}
    name: Build CPU (${{ matrix.os }})

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Build Spring Boot JAR (CPU)
      run: mvn clean package -DskipTests

    - name: Create custom JRE with jlink (Windows)
      if: runner.os == 'Windows'
      shell: cmd
      run: |
        jlink --add-modules java.base,java.sql,java.naming,java.desktop,java.management,java.net.http,java.xml,jdk.unsupported,jdk.security.jgss,java.instrument,jdk.crypto.cryptoki,jdk.charsets --output jre --compress 2 --no-header-files --no-man-pages
        if exist jre\bin\java.exe (echo JRE created successfully) else (echo JRE creation failed && exit /b 1)
        dir jre\bin

    - name: Create custom JRE with jlink (Unix)
      if: runner.os != 'Windows'
      run: |
        echo "Creating JRE with jlink..."
        jlink --add-modules java.base,java.sql,java.naming,java.desktop,java.management,java.net.http,java.xml,jdk.unsupported,jdk.security.jgss,java.instrument,jdk.crypto.cryptoki,jdk.charsets \
              --output jre \
              --compress 2 \
              --no-header-files \
              --no-man-pages

        # Verify JRE was created
        if [ ! -f "jre/bin/java" ]; then
          echo "ERROR: jre/bin/java not found after jlink!"
          ls -la
          if [ -d "jre" ]; then
            echo "JRE directory exists but bin/java not found:"
            ls -la jre/
          fi
          exit 1
        fi
        echo "JRE created successfully"
        ls -la jre/bin/

    - name: Prepare distribution (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        Write-Host "Preparing distribution..."
        New-Item -ItemType Directory -Force -Path "dist" | Out-Null

        # Check JRE exists
        if (-not (Test-Path "jre\bin\java.exe")) {
          Write-Host "ERROR: jre\bin\java.exe not found!"
          Get-ChildItem -Path "jre" -Recurse | Select-Object FullName
          exit 1
        }

        # Check and copy JAR
        $jarFiles = Get-ChildItem -Path "target" -Filter "edge-vision-system-*.jar"
        if ($jarFiles.Count -eq 0) {
          Write-Host "ERROR: No JAR file found in target directory!"
          Get-ChildItem -Path "target" | Select-Object Name, Length
          exit 1
        }

        $jarFile = $jarFiles[0].FullName
        $jarSize = $jarFiles[0].Length
        Write-Host "Found JAR: $($jarFiles[0].Name) with size $jarSize bytes"

        if ($jarSize -lt 1MB) {
          Write-Host "ERROR: JAR file is too small ($jarSize bytes), build may have failed!"
          exit 1
        }

        Copy-Item -Path $jarFile -Destination "dist\edge-vision.jar" -Force
        Write-Host "Copied JAR to dist\edge-vision.jar"

        # Verify JAR was copied
        $copiedJar = Get-Item "dist\edge-vision.jar"
        Write-Host "Verified JAR size: $($copiedJar.Length) bytes"

        # Copy config
        if (Test-Path "src\main\resources\application.yml") {
          Copy-Item -Path "src\main\resources\application.yml" -Destination "dist\" -Force
        }

        # Copy custom JRE
        Copy-Item -Path "jre" -Destination "dist\jre" -Recurse -Force

        # Verify JRE was copied
        if (-not (Test-Path "dist\jre\bin\java.exe")) {
          Write-Host "ERROR: dist\jre\bin\java.exe not found after copy!"
          exit 1
        }

        # Copy models if exist
        if (Test-Path "models\*.onnx") {
          New-Item -ItemType Directory -Force -Path "dist\models" | Out-Null
          Copy-Item -Path "models\*.onnx" -Destination "dist\models\" -Force
        }

        # Copy MVS camera SDK libraries (complete lib directory with all dependencies)
        if (Test-Path "mvs\lib\win64\MvCameraControl.dll") {
          Copy-Item -Path "mvs\lib" -Destination "dist\mvs" -Recurse -Force
          Write-Host "Copied MVS Windows libraries to dist/mvs/lib"
        }

        # Show final structure
        Write-Host ""
        Write-Host "Final dist structure:"
        Get-ChildItem -Path "dist" -Recurse | Select-Object FullName, Length

    - name: Prepare distribution (Unix)
      if: runner.os != 'Windows'
      run: |
        mkdir -p dist

        # Verify JRE exists before copying
        if [ ! -f "jre/bin/java" ]; then
          echo "ERROR: jre/bin/java not found!"
          echo "Current directory contents:"
          ls -la
          if [ -d "jre" ]; then
            echo "JRE directory contents:"
            ls -la jre/
            if [ -d "jre/bin" ]; then
              echo "JRE bin contents:"
              ls -la jre/bin/
            fi
          fi
          exit 1
        fi

        echo "JRE verified, copying to dist..."

        # Copy JAR
        cp target/edge-vision-system-*.jar dist/edge-vision.jar

        # Copy config
        cp src/main/resources/application.yml dist/

        # Copy custom JRE
        cp -r jre dist/

        # Verify JRE was copied
        if [ ! -f "dist/jre/bin/java" ]; then
          echo "ERROR: dist/jre/bin/java not found after copy!"
          exit 1
        fi

        # Copy models if exist
        if compgen -G "models/*.onnx" > /dev/null; then
          mkdir -p dist/models
          cp models/*.onnx dist/models/
        fi

        # Copy MVS camera SDK libraries (complete lib directory with all dependencies)
        if [ -d "mvs/lib/linux64" ]; then
          mkdir -p dist/mvs
          cp -r mvs/lib dist/mvs/
          echo "Copied MVS Linux libraries (complete mvs/lib directory)"
        fi

        # Show final structure
        echo ""
        echo "Final dist structure:"
        find dist -type f | head -20

    - name: Create run script (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        "@echo off
        jre\bin\java.exe -jar edge-vision.jar --spring.config.additional-location=application.yml
        pause" | Out-File -FilePath dist\run.bat -Encoding ASCII

    - name: Create run script (Unix)
      if: runner.os != 'Windows'
      run: |
        cat > dist/run.sh << 'EOF'
        #!/bin/bash
        DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
        cd "$DIR"
        exec "$DIR/jre/bin/java" -jar edge-vision.jar --spring.config.additional-location=application.yml
        EOF
        chmod +x dist/run.sh

    - name: Verify package (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      timeout-minutes: 5
      run: |
        cd dist
        Write-Host "=== Verifying package ==="

        if (-not (Test-Path "edge-vision.jar")) {
          Write-Host "ERROR: edge-vision.jar not found!"
          Get-ChildItem -Force
          exit 1
        }

        if (-not (Test-Path "jre\bin\java.exe")) {
          Write-Host "ERROR: jre\bin\java.exe not found!"
          exit 1
        }

        $jarSize = (Get-Item "edge-vision.jar").Length
        Write-Host "JAR size: $jarSize bytes"

        if ($jarSize -lt 1MB) {
          Write-Host "ERROR: JAR file too small, might be corrupted"
          exit 1
        }

        Write-Host "Starting application..."
        $process = Start-Process -FilePath "jre\bin\java.exe" -ArgumentList "-jar","edge-vision.jar","--server.port=8888" -PassThru -NoNewWindow

        Write-Host "Waiting for startup..."
        Start-Sleep -Seconds 45

        Write-Host "Testing health endpoint..."
        try {
          $response = Invoke-WebRequest -Uri "http://localhost:8888/actuator/health" -TimeoutSec 10
          Write-Host "Health check passed: $($response.StatusCode)"
        } catch {
          Write-Host "Health check failed: $_"
          $process.Kill()
          exit 1
        }

        Write-Host "Stopping application..."
        $process.Kill()
        Write-Host "Verification completed successfully"

    - name: Verify package (Unix)
      if: runner.os != 'Windows'
      run: |
        echo "Starting application..."
        cd dist
        ./jre/bin/java -jar edge-vision.jar --spring.config.additional-location=application.yml --server.port=8888 &
        JAVA_PID=$!
        echo "Waiting for application to start (PID: $JAVA_PID)..."
        sleep 30
        echo "Testing health endpoint..."
        curl -s http://localhost:8888/actuator/health
        echo "Stopping application..."
        kill $JAVA_PID 2>/dev/null || true
        wait $JAVA_PID 2>/dev/null || true

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: edge-vision-cpu-${{ runner.os }}
        path: dist/
        compression-level: 6
        if-no-files-found: error

  build-gpu:
    runs-on: ${{ matrix.os }}
    name: Build GPU (${{ matrix.os }})

    # NOTE: This build uses onnxruntime 1.23.2 which only supports CUDA 12.x, NOT CUDA 13.x
    # If the deployment machine already has CUDA 13.x (for other applications),
    # install CUDA 12.x alongside it to a separate directory. The run scripts are
    # configured to automatically detect and prefer CUDA 12.x over CUDA 13.x.
    #
    # Windows: Install to "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.x"
    # Linux: Install to "/usr/local/cuda-12.x"
    #
    # The run scripts will:
    # 1. First check for CUDA 12.x directories
    # 2. Then check for CUDA 13.x directories (with warning)
    # 3. Set environment variables to ensure onnxruntime uses CUDA 12.x
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Build Spring Boot JAR (GPU)
      run: mvn clean package -Pgpu -DskipTests

    - name: Create custom JRE with jlink (Windows)
      if: runner.os == 'Windows'
      shell: cmd
      run: |
        jlink --add-modules java.base,java.sql,java.naming,java.desktop,java.management,java.net.http,java.xml,jdk.unsupported,jdk.security.jgss,java.instrument,jdk.crypto.cryptoki,jdk.charsets --output jre --compress 2 --no-header-files --no-man-pages
        if exist jre\bin\java.exe (echo JRE created successfully) else (echo JRE creation failed && exit /b 1)
        dir jre\bin

    - name: Create custom JRE with jlink (Unix)
      if: runner.os != 'Windows'
      run: |
        echo "Creating JRE with jlink..."
        jlink --add-modules java.base,java.sql,java.naming,java.desktop,java.management,java.net.http,java.xml,jdk.unsupported,jdk.security.jgss,java.instrument,jdk.crypto.cryptoki,jdk.charsets \
              --output jre \
              --compress 2 \
              --no-header-files \
              --no-man-pages

        # Verify JRE was created
        if [ ! -f "jre/bin/java" ]; then
          echo "ERROR: jre/bin/java not found after jlink!"
          ls -la
          if [ -d "jre" ]; then
            echo "JRE directory exists but bin/java not found:"
            ls -la jre/
          fi
          exit 1
        fi
        echo "JRE created successfully"
        ls -la jre/bin/

    - name: Prepare distribution (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        Write-Host "Preparing distribution..."
        New-Item -ItemType Directory -Force -Path "dist" | Out-Null

        # Check JRE exists
        if (-not (Test-Path "jre\bin\java.exe")) {
          Write-Host "ERROR: jre\bin\java.exe not found!"
          Get-ChildItem -Path "jre" -Recurse | Select-Object FullName
          exit 1
        }

        # Check and copy JAR
        $jarFiles = Get-ChildItem -Path "target" -Filter "edge-vision-system-*.jar"
        if ($jarFiles.Count -eq 0) {
          Write-Host "ERROR: No JAR file found in target directory!"
          Get-ChildItem -Path "target" | Select-Object Name, Length
          exit 1
        }

        $jarFile = $jarFiles[0].FullName
        $jarSize = $jarFiles[0].Length
        Write-Host "Found JAR: $($jarFiles[0].Name) with size $jarSize bytes"

        if ($jarSize -lt 1MB) {
          Write-Host "ERROR: JAR file is too small ($jarSize bytes), build may have failed!"
          exit 1
        }

        Copy-Item -Path $jarFile -Destination "dist\edge-vision.jar" -Force
        Write-Host "Copied JAR to dist\edge-vision.jar"

        # Verify JAR was copied
        $copiedJar = Get-Item "dist\edge-vision.jar"
        Write-Host "Verified JAR size: $($copiedJar.Length) bytes"

        # Copy config
        if (Test-Path "src\main\resources\application.yml") {
          Copy-Item -Path "src\main\resources\application.yml" -Destination "dist\" -Force
        }

        # Copy custom JRE
        Copy-Item -Path "jre" -Destination "dist\jre" -Recurse -Force

        # Verify JRE was copied
        if (-not (Test-Path "dist\jre\bin\java.exe")) {
          Write-Host "ERROR: dist\jre\bin\java.exe not found after copy!"
          exit 1
        }

        # Copy models if exist
        if (Test-Path "models\*.onnx") {
          New-Item -ItemType Directory -Force -Path "dist\models" | Out-Null
          Copy-Item -Path "models\*.onnx" -Destination "dist\models\" -Force
        }

        # Copy MVS camera SDK libraries (complete lib directory with all dependencies)
        if (Test-Path "mvs\lib\win64\MvCameraControl.dll") {
          Copy-Item -Path "mvs\lib" -Destination "dist\mvs" -Recurse -Force
          Write-Host "Copied MVS Windows libraries to dist/mvs/lib"
        }

        # Copy CUDA/cuDNN runtime libraries from libs directory (if provided)
        # Users should place CUDA/cuDNN DLLs in libs/win64/ directory
        if (Test-Path "libs\win64\*.dll") {
          New-Item -ItemType Directory -Force -Path "dist\libs" | Out-Null
          Copy-Item -Path "libs\win64\*.dll" -Destination "dist\libs\" -Force
          Write-Host "Copied CUDA/cuDNN DLLs from libs/win64 to dist/libs"
        } else {
          Write-Host "WARNING: libs/win64 directory not found. CUDA/cuDNN DLLs not included."
          Write-Host "         For GPU builds, place CUDA/cuDNN runtime DLLs in libs/win64/"
        }

        # Extract native libraries from JAR for easier access and loading
        # This extracts OpenCV and ONNX Runtime native libraries to dist/libs
        Write-Host "Extracting native libraries from JAR..."

        # Create libs directory if not exists
        New-Item -ItemType Directory -Force -Path "dist\libs" | Out-Null

        # Extract OpenCV native library (Windows x64)
        $jarPath = "dist\edge-vision.jar"
        if (Test-Path $jarPath) {
          Write-Host "Extracting OpenCV native library..."
          Expand-Archive -Path $jarPath -DestinationPath "temp_jar_extract" -Force

          # Copy OpenCV DLL
          $opencvSource = "temp_jar_extract\BOOT-INF\lib\opencv-4.7.0-0.jar"
          if (Test-Path $opencvSource) {
            Expand-Archive -Path $opencvSource -DestinationPath "temp_opencv_extract" -Force
            $opencvDll = "temp_opencv_extract\nu\pattern\opencv\windows\x86_64\opencv_java470.dll"
            if (Test-Path $opencvDll) {
              Copy-Item -Path $opencvDll -Destination "dist\libs\" -Force
              Write-Host "Extracted opencv_java470.dll to dist/libs"
            }
          }

          # Extract ONNX Runtime native libraries (Windows x64)
          Write-Host "Extracting ONNX Runtime native libraries..."
          $onnxJar = Get-ChildItem -Path "temp_jar_extract\BOOT-INF\lib" -Filter "onnxruntime_gpu-*.jar"
          if ($onnxJar) {
            Expand-Archive -Path $onnxJar.FullName -DestinationPath "temp_onnx_extract" -Force

            # Copy ONNX Runtime DLLs
            $onnxNativePath = "temp_onnx_extract\ai\onnxruntime\native\win-x64"
            if (Test-Path $onnxNativePath) {
              Copy-Item -Path "$onnxNativePath\*.dll" -Destination "dist\libs\" -Force
              Write-Host "Extracted ONNX Runtime DLLs to dist/libs"
            }
          }

          # Clean up temp directories
          Remove-Item -Path "temp_jar_extract" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "temp_opencv_extract" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "temp_onnx_extract" -Recurse -Force -ErrorAction SilentlyContinue
        }

        # Show final structure
        Write-Host ""
        Write-Host "Final dist structure:"
        Get-ChildItem -Path "dist" -Recurse | Select-Object FullName, Length

    - name: Prepare distribution (Unix)
      if: runner.os != 'Windows'
      run: |
        mkdir -p dist

        # Verify JRE exists before copying
        if [ ! -f "jre/bin/java" ]; then
          echo "ERROR: jre/bin/java not found!"
          echo "Current directory contents:"
          ls -la
          if [ -d "jre" ]; then
            echo "JRE directory contents:"
            ls -la jre/
            if [ -d "jre/bin" ]; then
              echo "JRE bin contents:"
              ls -la jre/bin/
            fi
          fi
          exit 1
        fi

        echo "JRE verified, copying to dist..."

        # Copy JAR
        cp target/edge-vision-system-*.jar dist/edge-vision.jar

        # Copy config
        cp src/main/resources/application.yml dist/

        # Copy custom JRE
        cp -r jre dist/

        # Verify JRE was copied
        if [ ! -f "dist/jre/bin/java" ]; then
          echo "ERROR: dist/jre/bin/java not found after copy!"
          exit 1
        fi

        # Copy models if exist
        if compgen -G "models/*.onnx" > /dev/null; then
          mkdir -p dist/models
          cp models/*.onnx dist/models/
        fi

        # Copy MVS camera SDK libraries (complete lib directory with all dependencies)
        if [ -d "mvs/lib/linux64" ]; then
          mkdir -p dist/mvs
          cp -r mvs/lib dist/mvs/
          echo "Copied MVS Linux libraries (complete mvs/lib directory)"
        fi

        # Copy CUDA/cuDNN runtime libraries from libs directory (if provided)
        # Users should place CUDA/cuDNN .so files in libs/linux64/ directory
        if [ -d "libs/linux64" ] && ls libs/linux64/*.so* > /dev/null 2>&1; then
          mkdir -p dist/libs
          cp -P libs/linux64/*.so* dist/libs/
          echo "Copied CUDA/cuDNN libraries from libs/linux64 to dist/libs"
        else
          echo "WARNING: libs/linux64 directory not found or empty. CUDA/cuDNN libraries not included."
          echo "         For GPU builds, place CUDA/cuDNN runtime libraries in libs/linux64/"
        fi

        # Extract native libraries from JAR for easier access and loading
        # This extracts OpenCV and ONNX Runtime native libraries to dist/libs
        echo "Extracting native libraries from JAR..."

        # Create libs directory if not exists
        mkdir -p dist/libs

        JAR_PATH="dist/edge-vision.jar"
        if [ -f "$JAR_PATH" ]; then
          # Create temp directory for extraction
          TEMP_DIR=$(mktemp -d)
          echo "Using temp directory: $TEMP_DIR"

          # Extract JAR contents
          unzip -q "$JAR_PATH" -d "$TEMP_DIR"

          # Extract OpenCV native library (Linux x64)
          echo "Extracting OpenCV native library..."
          OPENCV_JAR="$TEMP_DIR/BOOT-INF/lib/opencv-4.7.0-0.jar"
          if [ -f "$OPENCV_JAR" ]; then
            OPENCV_TEMP="$TEMP_DIR/opencv_extract"
            mkdir -p "$OPENCV_TEMP"
            unzip -q "$OPENCV_JAR" -d "$OPENCV_TEMP"

            OPENCV_SO="$OPENCV_TEMP/nu/pattern/opencv/linux/x86_64/libopencv_java470.so"
            if [ -f "$OPENCV_SO" ]; then
              cp "$OPENCV_SO" "dist/libs/"
              echo "Extracted libopencv_java470.so to dist/libs"
            fi
          fi

          # Extract ONNX Runtime native libraries (Linux x64)
          echo "Extracting ONNX Runtime native libraries..."
          ONNX_JAR=$(find "$TEMP_DIR/BOOT-INF/lib" -name "onnxruntime_gpu-*.jar" | head -1)
          if [ -n "$ONNX_JAR" ] && [ -f "$ONNX_JAR" ]; then
            ONNX_TEMP="$TEMP_DIR/onnx_extract"
            mkdir -p "$ONNX_TEMP"
            unzip -q "$ONNX_JAR" -d "$ONNX_TEMP"

            # Copy ONNX Runtime shared libraries
            ONNX_NATIVE="$ONNX_TEMP/ai/onnxruntime/native/linux-x64"
            if [ -d "$ONNX_NATIVE" ]; then
              cp "$ONNX_NATIVE"/libonnxruntime*.so "$ONNX_NATIVE"/libonnxruntime4j_jni.so dist/libs/
              echo "Extracted ONNX Runtime libraries to dist/libs"
            fi
          fi

          # Clean up temp directory
          rm -rf "$TEMP_DIR"
          echo "Native library extraction completed"
        fi

        # Show final structure
        echo ""
        echo "Final dist structure:"
        find dist -type f | head -20

    - name: Create run script (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $batContent = @"
        @echo off
        setlocal enabledelayedexpansion

        echo ========================================
        echo Edge Vision System - GPU Version
        echo ========================================
        echo.

        REM ============================================================
        REM Step 1: Setup library PATH priority
        REM ============================================================

        REM Add libs directory to PATH
        if exist "%~dp0libs" (
            set "PATH=%~dp0libs;%PATH%"
            echo Found libs directory with bundled libraries
        )

        REM Add MVS camera SDK library path
        if exist "%~dp0mvs\lib\win64" (
            set "PATH=%~dp0mvs\lib\win64;%PATH%"
        )

        REM ============================================================
        REM Step 2: Check for bundled CUDA/cuDNN libraries
        REM ============================================================

        set "HAS_BUNDLED_CUDA=0"
        if exist "%~dp0libs\cudart64_*.dll" (
            set "HAS_BUNDLED_CUDA=1"
            echo Using bundled CUDA/cuDNN libraries from libs directory
        )

        REM ============================================================
        REM Step 3: Auto-detect system CUDA installation (if no bundled)
        REM ============================================================

        if "!HAS_BUNDLED_CUDA!"=="0" (
            set "CUDA_PATH="
            set "CUDNN_PATH="

            REM Check CUDA 12.x versions (explicit checks to avoid for/f loop issues)
            if exist "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.0\bin\cudart64*.dll" (
                set "CUDA_PATH=C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.0"
            )
            if exist "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.1\bin\cudart64*.dll" (
                set "CUDA_PATH=C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.1"
            )
            if exist "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.2\bin\cudart64*.dll" (
                set "CUDA_PATH=C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.2"
            )
            if exist "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.3\bin\cudart64*.dll" (
                set "CUDA_PATH=C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.3"
            )
            if exist "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.4\bin\cudart64*.dll" (
                set "CUDA_PATH=C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.4"
            )
            if exist "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.5\bin\cudart64*.dll" (
                set "CUDA_PATH=C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.5"
            )
            if exist "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.6\bin\cudart64*.dll" (
                set "CUDA_PATH=C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.6"
            )

            REM Check CUDA 13.x (with warning)
            if not defined CUDA_PATH if exist "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.0\bin\cudart64*.dll" (
                set "CUDA_PATH=C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.0"
                echo WARNING: Found CUDA 13.x, but onnxruntime 1.23.2 only supports CUDA 12.x
            )
            if not defined CUDA_PATH if exist "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.1\bin\cudart64*.dll" (
                set "CUDA_PATH=C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.1"
                echo WARNING: Found CUDA 13.x, but onnxruntime 1.23.2 only supports CUDA 12.x
            )

            REM Check CUDA 11.x
            if not defined CUDA_PATH if exist "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11.8\bin\cudart64*.dll" (
                set "CUDA_PATH=C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11.8"
            )

            if defined CUDA_PATH (
                echo Found CUDA: !!CUDA_PATH!!

                REM Create libs directory if not exists
                if not exist "%~dp0libs" mkdir "%~dp0libs"

                REM Copy CUDA runtime DLLs to libs directory
                echo Copying CUDA runtime DLLs to libs directory...
                copy "!!CUDA_PATH!!\bin\cudart64_*.dll" "%~dp0libs\" >nul 2>&1
                copy "!!CUDA_PATH!!\bin\cublas64_*.dll" "%~dp0libs\" >nul 2>&1
                copy "!!CUDA_PATH!!\bin\cublasLt.dll" "%~dp0libs\" >nul 2>&1
                copy "!!CUDA_PATH!!\bin\cufft64_*.dll" "%~dp0libs\" >nul 2>&1
                copy "!!CUDA_PATH!!\bin\cusolver64_*.dll" "%~dp0libs\" >nul 2>&1
                copy "!!CUDA_PATH!!\bin\cusparse64_*.dll" "%~dp0libs\" >nul 2>&1
                copy "!!CUDA_PATH!!\bin\nvrtc64_*.dll" "%~dp0libs\" >nul 2>&1
                echo CUDA DLLs copied to libs directory

                REM Add CUDA bin to PATH
                set "PATH=!!CUDA_PATH!!\bin;%PATH%"
            ) else (
                echo WARNING: CUDA not found in default locations
                echo.
                echo Please install CUDA Toolkit 12.x:
                echo https://developer.nvidia.com/cuda-downloads
                echo.
            )

            REM Check cuDNN
            set "CUDNN_BIN="

            if exist "C:\Program Files\NVIDIA\CUDNN\bin\cudnn*.dll" (
                set "CUDNN_BIN=C:\Program Files\NVIDIA\CUDNN\bin"
                set "CUDNN_PATH=C:\Program Files\NVIDIA\CUDNN"
            )

            if not defined CUDNN_BIN if exist "C:\Program Files\NVIDIA\CUDNN\v9.0\bin\12\cudnn*.dll" (
                set "CUDNN_BIN=C:\Program Files\NVIDIA\CUDNN\v9.0\bin\12"
            )
            if not defined CUDNN_BIN if exist "C:\Program Files\NVIDIA\CUDNN\v9.1\bin\12\cudnn*.dll" (
                set "CUDNN_BIN=C:\Program Files\NVIDIA\CUDNN\v9.1\bin\12"
            )
            if not defined CUDNN_BIN if exist "C:\Program Files\NVIDIA\CUDNN\v9.2\bin\12\cudnn*.dll" (
                set "CUDNN_BIN=C:\Program Files\NVIDIA\CUDNN\v9.2\bin\12"
            )
            if not defined CUDNN_BIN if exist "C:\Program Files\NVIDIA\CUDNN\v9.3\bin\12\cudnn*.dll" (
                set "CUDNN_BIN=C:\Program Files\NVIDIA\CUDNN\v9.3\bin\12"
            )
            if not defined CUDNN_BIN if exist "C:\Program Files\NVIDIA\CUDNN\v9.4\bin\12\cudnn*.dll" (
                set "CUDNN_BIN=C:\Program Files\NVIDIA\CUDNN\v9.4\bin\12"
            )
            if not defined CUDNN_BIN if exist "C:\Program Files\NVIDIA\CUDNN\v9.5\bin\12\cudnn*.dll" (
                set "CUDNN_BIN=C:\Program Files\NVIDIA\CUDNN\v9.5\bin\12"
            )

            REM Check cuDNN in CUDA bin directory
            if not defined CUDNN_BIN if defined CUDA_PATH (
                if exist "!!CUDA_PATH!!\bin\cudnn*.dll" (
                    set "CUDNN_BIN=!!CUDA_PATH!!\bin"
                    set "CUDNN_PATH=!!CUDA_PATH!!"
                )
            )

            if defined CUDNN_BIN (
                echo Found cuDNN: !!CUDNN_BIN!!

                REM Create libs directory if not exists
                if not exist "%~dp0libs" mkdir "%~dp0libs"

                REM Copy cuDNN DLLs to libs directory
                echo Copying cuDNN DLLs to libs directory...
                copy "!!CUDNN_BIN!!\cudnn*.dll" "%~dp0libs\" >nul 2>&1
                echo cuDNN DLLs copied to libs directory

                REM Add cuDNN bin to PATH
                set "PATH=!!CUDNN_BIN!;%PATH%"
            ) else (
                echo WARNING: cuDNN not found in standard locations
                echo.
                echo Please install cuDNN for CUDA 12.x:
                echo https://developer.nvidia.com/cudnn
                echo.
            )
        )

        REM ============================================================
        REM Step 4: Verify native libraries in libs directory
        REM ============================================================

        echo Verifying native libraries in libs directory...

        if exist "%~dp0libs\opencv_java470.dll" (
            echo   Found: opencv_java470.dll ^(OpenCV^)
        ) else (
            echo   WARNING: opencv_java470.dll not found in libs directory
        )

        if exist "%~dp0libs\onnxruntime.dll" (
            echo   Found: onnxruntime.dll ^(ONNX Runtime^)
        ) else (
            echo   WARNING: onnxruntime.dll not found in libs directory
        )

        if exist "%~dp0libs\onnxruntime4j_jni.dll" (
            echo   Found: onnxruntime4j_jni.dll ^(ONNX Runtime JNI^)
        ) else (
            echo   WARNING: onnxruntime4j_jni.dll not found in libs directory
        )

        if exist "%~dp0libs\onnxruntime_providers_cuda.dll" (
            echo   Found: onnxruntime_providers_cuda.dll ^(CUDA Provider^)
        ) else (
            echo   WARNING: onnxruntime_providers_cuda.dll not found in libs directory
            echo   GPU acceleration may not work properly
        )
        echo.

        REM ============================================================
        REM Step 5: Verify CUDA runtime libraries
        REM ============================================================

        echo Verifying CUDA runtime libraries...
        set "MISSING_CUDA=0"

        if exist "%~dp0libs\cudart64_*.dll" (
            echo   Found: cudart64_*.dll ^(CUDA Runtime^)
        ) else (
            echo   WARNING: cudart64_*.dll not found in libs directory
            set "MISSING_CUDA=1"
        )

        if exist "%~dp0libs\cublas64_*.dll" (
            echo   Found: cublas64_*.dll ^(CUDA BLAS^)
        ) else (
            echo   WARNING: cublas64_*.dll not found in libs directory
            set "MISSING_CUDA=1"
        )

        if "!!MISSING_CUDA!!"=="1" (
            echo.
            echo WARNING: Some CUDA runtime libraries may be missing.
            echo This may cause GPU acceleration to fail.
            echo.
        )

        REM ============================================================
        REM Step 6: Set environment and start application
        REM ============================================================

        echo.
        echo Starting application...
        echo ========================================
        echo.

        set "JAVA_TOOL_OPTIONS=-Djava.library.path=%~dp0libs;%~dp0;%~dp0mvs\lib\win64"

        REM NOTE: OpenCV parallel backends (TBB/oneTBB/OpenMP) are optional for performance
        REM For best performance, download Intel oneTBB from:
        REM https://github.com/oneapi-src/oneTBB/releases
        REM Place tbb12*.dll and tbbmalloc*.dll in libs/ directory

        jre\bin\java.exe -jar edge-vision.jar --spring.config.additional-location=application.yml

        if errorlevel 1 (
            echo.
            echo ========================================
            echo Application exited with error
            echo ========================================
            echo.
            echo Troubleshooting:
            echo 1. Ensure NVIDIA GPU is installed
            echo 2. For bundled libraries: Place CUDA/cuDNN DLLs in libs/win64/ before building
            echo 3. For system CUDA: Install CUDA Toolkit 12.x and cuDNN
            echo 4. Check application.log for details
            echo.
        )

        pause
        "@

        # Write batch file with ANSI encoding for cmd.exe compatibility
        # UTF8 can cause issues with Chinese characters in cmd.exe
        $batContent | Out-File -FilePath dist\run.bat -Encoding Default
        Write-Host "Created run.bat with ANSI encoding"

    - name: Create run script (Unix)
      if: runner.os != 'Windows'
      run: |
        cat > dist/run.sh << 'EOFSCRIPT'
        #!/bin/bash
        set -e

        DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
        cd "$DIR"

        echo "========================================"
        echo "Edge Vision System - GPU Version"
        echo "========================================"
        echo ""

        # ============================================================
        # Step 1: Check for NVIDIA GPU
        # ============================================================

        if ! command -v nvidia-smi &> /dev/null; then
            echo "ERROR: nvidia-smi not found. This version requires NVIDIA GPU."
            echo "Please use the CPU version instead."
            exit 1
        fi

        echo "NVIDIA GPU detected:"
        nvidia-smi --query-gpu=name,driver_version,memory.total --format=csv,noheader
        echo ""

        # ============================================================
        # Step 2: Setup library PATH priority
        # ============================================================

        # Add libs directory first (for bundled CUDA/cuDNN libraries)
        if [ -d "$DIR/libs" ]; then
            export LD_LIBRARY_PATH="$DIR/libs:$LD_LIBRARY_PATH"
            echo "Found libs directory with bundled libraries"
        fi

        # Add MVS camera SDK library path
        if [ -d "$DIR/mvs/lib/linux64" ]; then
            export LD_LIBRARY_PATH="$DIR/mvs/lib/linux64:$LD_LIBRARY_PATH"
        fi

        # ============================================================
        # Step 3: Check for bundled CUDA/cuDNN libraries
        # ============================================================

        HAS_BUNDLED_CUDA=0
        if [ -f "$DIR/libs/libcudart.so.12" ] || [ -f "$DIR/libs/libcudart.so.11" ]; then
            HAS_BUNDLED_CUDA=1
            echo "Using bundled CUDA/cuDNN libraries from libs directory"
        fi

        # ============================================================
        # Step 4: Auto-detect system CUDA (if no bundled libraries)
        # ============================================================

        if [ "$HAS_BUNDLED_CUDA" -eq 0 ]; then
            CUDA_PATH=""
            CUDNN_PATH=""

            # Auto-detect CUDA (prioritize CUDA 12.x)
            if [ -d "/usr/local/cuda/lib64" ]; then
                CUDA_PATH="/usr/local/cuda"
                echo "Found CUDA: $CUDA_PATH"
                export LD_LIBRARY_PATH="$CUDA_PATH/lib64:$LD_LIBRARY_PATH"
                export PATH="$CUDA_PATH/bin:$PATH"
            fi

            for cuda_ver in 12 13 11; do
                if [ -d "/usr/local/cuda-${cuda_ver}" ]; then
                    CUDA_PATH="/usr/local/cuda-${cuda_ver}"
                    if [ "$cuda_ver" = "13" ]; then
                        echo "Found CUDA ${cuda_ver}: $CUDA_PATH"
                        echo "WARNING: onnxruntime 1.23.2 only supports CUDA 12.x, not CUDA 13.x"
                        echo "Please install CUDA 12.x alongside CUDA 13.x"
                    else
                        echo "Found CUDA ${cuda_ver}: $CUDA_PATH"
                    fi
                    export LD_LIBRARY_PATH="$CUDA_PATH/lib64:$LD_LIBRARY_PATH"
                    export PATH="$CUDA_PATH/bin:$PATH"
                    break
                fi
            done

            # Auto-detect and copy cuDNN if not in libs directory
            if [ ! -f "$DIR/libs/libcudnn.so" ] && [ ! -f "$DIR/libs/libcudnn.so.9" ]; then
                for lib_dir in /usr/local/cuda-12*/lib64 /usr/local/cuda/lib64 /usr/local/cuda-13*/lib64 /usr/local/cuda-11*/lib64 /usr/lib/x86_64-linux-gnu; do
                    if [ -d "$lib_dir" ] && ls "$lib_dir"/libcudnn*so* 2>/dev/null | head -1 > /dev/null; then
                        CUDNN_PATH="$lib_dir"
                        echo "Found cuDNN in: $CUDNN_PATH"
                        echo "Copying cuDNN libraries to libs directory..."
                        mkdir -p "$DIR/libs"
                        cp "$lib_dir"/libcudnn*.so* "$DIR/libs/" 2>/dev/null || true
                        echo "cuDNN libraries copied to libs directory!"
                        echo ""
                        break
                    fi
                done
            else
                echo "Found cuDNN in libs directory"
            fi

            # Warnings
            if [ -z "$CUDA_PATH" ]; then
                echo "WARNING: CUDA not found in standard locations"
                echo "Install CUDA Toolkit: https://developer.nvidia.com/cuda-downloads"
                echo ""
            fi

            if [ -z "$CUDNN_PATH" ] && [ ! -f "$DIR/libs/libcudnn.so" ] && [ ! -f "$DIR/libs/libcudnn.so.9" ]; then
                echo "WARNING: cuDNN not found"
                echo "Install cuDNN for CUDA 12.x: https://developer.nvidia.com/cudnn"
                echo ""
            fi
        fi

        # ============================================================
        # Step 5: Verify native libraries in libs directory
        # ============================================================

        echo "Verifying native libraries..."

        # Check OpenCV
        if [ -f "$DIR/libs/libopencv_java470.so" ]; then
            echo "  Found: libopencv_java470.so (OpenCV)"
        else
            echo "  WARNING: libopencv_java470.so not found in libs directory"
        fi

        # Check ONNX Runtime
        if [ -f "$DIR/libs/libonnxruntime.so" ]; then
            echo "  Found: libonnxruntime.so (ONNX Runtime)"
        else
            echo "  WARNING: libonnxruntime.so not found in libs directory"
        fi

        # Check ONNX Runtime JNI
        if [ -f "$DIR/libs/libonnxruntime4j_jni.so" ]; then
            echo "  Found: libonnxruntime4j_jni.so (ONNX Runtime JNI)"
        else
            echo "  WARNING: libonnxruntime4j_jni.so not found in libs directory"
        fi

        # Check ONNX Runtime CUDA provider
        if [ -f "$DIR/libs/libonnxruntime_providers_cuda.so" ]; then
            echo "  Found: libonnxruntime_providers_cuda.so (CUDA Provider)"
        else
            echo "  WARNING: libonnxruntime_providers_cuda.so not found in libs directory"
            echo "  GPU acceleration may not work properly"
        fi
        echo ""

        # ============================================================
        # Step 6: Set environment and start application
        # ============================================================

        echo ""
        echo "Starting application..."
        echo "========================================"
        echo ""

        # Set JAVA_TOOL_OPTIONS for native library path
        # - libs directory for extracted OpenCV, ONNX Runtime, and CUDA/cuDNN libraries
        # - mvs/lib/linux64 for MVS camera SDK
        export JAVA_TOOL_OPTIONS="-Djava.library.path=$DIR/libs:$DIR/mvs/lib/linux64"

        # NOTE: OpenCV parallel backends (TBB/oneTBB/OpenMP) are optional for performance
        # For best performance, install Intel oneTBB:
        # https://github.com/oneapi-src/oneTBB/releases

        exec "$DIR/jre/bin/java" -jar edge-vision.jar --spring.config.additional-location=application.yml
        EOFSCRIPT
        chmod +x dist/run.sh
        echo "Created run.sh"

    - name: Verify package (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      timeout-minutes: 5
      run: |
        cd dist
        Write-Host "=== Verifying package ==="

        if (-not (Test-Path "edge-vision.jar")) {
          Write-Host "ERROR: edge-vision.jar not found!"
          Get-ChildItem -Force
          exit 1
        }

        if (-not (Test-Path "jre\bin\java.exe")) {
          Write-Host "ERROR: jre\bin\java.exe not found!"
          exit 1
        }

        $jarSize = (Get-Item "edge-vision.jar").Length
        Write-Host "JAR size: $jarSize bytes"

        if ($jarSize -lt 1MB) {
          Write-Host "ERROR: JAR file too small, might be corrupted"
          exit 1
        }

        Write-Host "Starting application..."
        # Force CPU mode for CI testing (no GPU available)
        $process = Start-Process -FilePath "jre\bin\java.exe" -ArgumentList "-jar","edge-vision.jar","--server.port=8888","--edge-vision.models.device=CPU" -PassThru -NoNewWindow

        Write-Host "Waiting for startup..."
        Start-Sleep -Seconds 45

        Write-Host "Testing health endpoint..."
        try {
          $response = Invoke-WebRequest -Uri "http://localhost:8888/actuator/health" -TimeoutSec 10
          Write-Host "Health check passed: $($response.StatusCode)"
        } catch {
          Write-Host "Health check failed: $_"
          $process.Kill()
          exit 1
        }

        Write-Host "Stopping application..."
        $process.Kill()
        Write-Host "Verification completed successfully"

    - name: Verify package (Unix)
      if: runner.os != 'Windows'
      run: |
        echo "Starting application..."
        cd dist
        # Force CPU mode for CI testing (no GPU available)
        ./jre/bin/java -jar edge-vision.jar --spring.config.additional-location=application.yml --server.port=8888 --edge-vision.models.device=CPU &
        JAVA_PID=$!
        echo "Waiting for application to start (PID: $JAVA_PID)..."
        sleep 30
        echo "Testing health endpoint..."
        curl -s http://localhost:8888/actuator/health
        echo "Stopping application..."
        kill $JAVA_PID 2>/dev/null || true
        wait $JAVA_PID 2>/dev/null || true

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: edge-vision-gpu-${{ runner.os }}
        path: dist/
        compression-level: 6
        if-no-files-found: error

  create-release:
    needs: [build-cpu, build-gpu]
    runs-on: ubuntu-latest
    if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && inputs.release == true)

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Create release archives
      run: |
        for dir in edge-vision-*/; do
          name="${dir%/}"
          if [[ "$name" == *Linux* ]]; then
            tar -czf "${name}.tar.gz" "$dir"
          else
            zip -r "${name}.zip" "$dir"
          fi
        done

    - name: Show archive sizes
      run: |
        echo "Archive sizes:"
        du -h *.zip *.tar.gz 2>/dev/null || true

    - name: Upload release assets
      uses: softprops/action-gh-release@v1
      with:
        files: |
          *.zip
          *.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
