<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EdgeVision Pro | æ™ºèƒ½è§†è§‰å·¥ä½œå°</title>
    <style>
        :root {
            --sidebar-bg: #001529;
            --sidebar-width: 200px;
            --primary-color: #1890ff;
            --bg-body: #f0f2f5;
            --header-height: 48px;
            --card-radius: 8px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-body);
            height: 100vh;
            display: flex;
            overflow: hidden;
            color: #333;
        }

        /* å·¦ä¾§ä¾§è¾¹æ  */
        aside {
            width: var(--sidebar-width);
            background: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
            color: rgba(255,255,255,0.65);
            z-index: 10;
            box-shadow: 2px 0 8px rgba(0,0,0,0.15);
        }

        .brand {
            height: 60px;
            display: flex;
            align-items: center;
            padding-left: 20px;
            font-size: 18px;
            font-weight: 700;
            color: white;
            letter-spacing: 1px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .brand span { color: var(--primary-color); }

        .menu { flex: 1; padding: 20px 10px; display: flex; flex-direction: column; gap: 15px; }
        .menu-label { font-size: 12px; margin-bottom: 5px; padding-left: 10px; text-transform: uppercase; opacity: 0.5; }

        .ctrl-btn {
            background: rgba(255,255,255,0.08);
            border: none;
            color: white;
            padding: 12px 15px;
            border-radius: 6px;
            cursor: pointer;
            text-align: left;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }
        .ctrl-btn:hover:not(:disabled) { background: var(--primary-color); color: white; transform: translateX(5px); }
        .ctrl-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .ctrl-btn.stop:hover:not(:disabled) { background: #ff4d4f; }

        /* ä¸»ä½“åŒºåŸŸ */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        header {
            height: var(--header-height);
            background: white;
            border-bottom: 1px solid #e8e8e8;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            font-size: 13px;
            color: #666;
        }

        .workspace {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }

        /* ä¸ŠåŠéƒ¨åˆ†ï¼šç›‘æ§åŒº */
        .monitor-section {
            height: 40vh;
            min-height: 280px;
            display: flex;
            gap: 16px;
        }

        .camera-card {
            flex: 1;
            background: black;
            border-radius: var(--card-radius);
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
        }

        .video-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #1f1f1f;
            position: relative;
        }

        .video-wrapper img {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
        }

        .cam-overlay-info {
            position: absolute; top: 10px; left: 10px;
            background: rgba(0,0,0,0.6); color: #fff;
            padding: 4px 8px; border-radius: 4px; font-size: 12px; font-family: monospace;
            display: flex; align-items: center; gap: 6px;
        }
        .rec-dot { width: 8px; height: 8px; background: #52c41a; border-radius: 50%; box-shadow: 0 0 4px #52c41a;}

        /* ä¸‹åŠéƒ¨åˆ†ï¼šç»“æœé¢æ¿ */
        .result-section {
            flex: 1;
            background: white;
            border-radius: var(--card-radius);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #e8e8e8;
            min-height: 0;
        }

        .panel-header {
            padding: 15px 24px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fafafa;
        }

        /* éœ€æ±‚2ï¼šæ ‡é¢˜è¦æ˜æ˜¾ */
        .panel-title {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            border-left: 4px solid var(--primary-color);
            padding-left: 12px;
        }

        .panel-body {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        /* å·¦ä¾§ï¼šæ£€æµ‹å›¾ */
        .result-view {
            flex: 0 0 40%;
            background: #f7f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: 1px solid #f0f0f0;
            padding: 20px;
            position: relative;
        }

        .canvas-box {
            position: relative;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            max-width: 100%;
            max-height: 100%;
            display: flex;
            border-radius: 4px;
            overflow: hidden;
            cursor: zoom-in; /* æç¤ºå¯æ”¾å¤§ */
            transition: transform 0.2s;
        }
        .canvas-box:hover {
            transform: scale(1.02);
            border: 2px solid var(--primary-color);
        }

        .res-img-display {
            display: block;
            max-height: 100%;
            max-width: 100%;
            object-fit: contain;
        }

        /* å³ä¾§ï¼šæ•°æ®åˆ—è¡¨ */
        .data-list-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            min-width: 0;
            padding: 20px;
        }

        /* éœ€æ±‚1ï¼šä¿¡æ¯æ˜¾ç¤ºè¦æ˜æ˜¾ (å¡ç‰‡å¼å¸ƒå±€) */
        .batch-info-bar {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .info-card {
            background: #f8faff;
            border: 1px solid #d6e4ff;
            padding: 12px 15px;
            border-radius: 6px;
        }
        .info-card label {
            display: block;
            font-size: 12px;
            color: #85a5ff;
            font-weight: 600;
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        .info-card .val {
            font-size: 16px;
            font-weight: 700;
            color: #003a8c;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* éœ€æ±‚4ï¼šç»Ÿè®¡åŒºåŸŸ */
        .stats-bar {
            margin-bottom: 15px;
            padding: 12px;
            background: #fff;
            border-radius: 6px;
            border: 1px dashed #e8e8e8;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .stats-label { font-weight: 600; font-size: 14px; color: #555; margin-right: 5px; }
        .stat-pill {
            background: #f5f5f5;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 13px;
            color: #333;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .stat-pill b { color: var(--primary-color); }

        .table-container { flex: 1; overflow-y: auto; border: 1px solid #f0f0f0; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { text-align: left; padding: 12px 15px; color: #999; font-weight: 500; font-size: 12px; background: #fafafa; position: sticky; top: 0; border-bottom: 1px solid #eee; }
        td { padding: 10px 15px; border-bottom: 1px solid #f5f5f5; cursor: pointer; transition: 0.2s; }
        tr:hover td { background: #e6f7ff; }
        tr.active td { background: #e6f7ff; font-weight: 600; color: var(--primary-color); border-left: 3px solid var(--primary-color); }

        .empty-state {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; width: 100%; color: #ccc;
        }

        /* éœ€æ±‚3ï¼šå›¾ç‰‡æ”¾å¤§Lightbox */
        .lightbox {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .lightbox-content {
            position: relative;
            max-width: 90%;
            max-height: 85%;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }
        .lightbox-img {
            display: block;
            max-width: 100%;
            max-height: 85vh; /* ç¡®ä¿ä¸è¶…å‡ºä¸€å± */
            object-fit: contain;
        }
        .lightbox-canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
        }
        .lightbox-close {
            position: absolute;
            top: 20px; right: 30px;
            color: white;
            font-size: 40px;
            cursor: pointer;
            z-index: 2001;
        }

        /* Modal (è¡¨å•) */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        .modal-card {
            background: white; margin: 10vh auto; width: 420px;
            border-radius: 8px; padding: 0;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden; animation: slideIn 0.3s;
        }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .modal-header { padding: 20px; background: #fbfbfb; border-bottom: 1px solid #eee; font-weight: 600; }
        .modal-body { padding: 24px; }
        .form-item { margin-bottom: 16px; }
        .form-item label { display: block; font-size: 13px; margin-bottom: 6px; color: #666; }
        .form-item input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; outline: none; transition: 0.3s; }
        .form-item input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(24,144,255,0.1); }
        .modal-footer { padding: 16px 24px; text-align: right; background: #fbfbfb; border-top: 1px solid #eee; }

    </style>
</head>
<body>

<aside>
    <div class="brand">
        EDGE<span>VISION</span>
    </div>

    <div class="menu">
        <div class="menu-label">Device Control</div>
        <button class="ctrl-btn" onclick="startCamera()" id="startBtn">
            â–¶ å¯åŠ¨ç›‘æ§
        </button>
        <button class="ctrl-btn stop" onclick="stopCamera()" id="stopBtn" disabled>
            â¹ åœæ­¢ç›‘æ§
        </button>

        <div class="menu-label" style="margin-top: 20px;">Inspection</div>
        <button class="ctrl-btn" onclick="startPreCheck()" id="inspectBtn" disabled>
            â— å¼€å§‹æ£€æµ‹
        </button>
    </div>

    <div style="padding: 20px; font-size: 12px; opacity: 0.5; margin-top: auto;">
        System Status: Normal<br>
        Ver 3.1.0 (Enhanced)
    </div>
</aside>

<main>
    <header>
        <div><b>å·¥ä½œå°</b> / å®æ—¶ç›‘æ§ä¸åˆ†æ</div>
        <div id="clock">00:00:00</div>
    </header>

    <div class="workspace">
        <div class="monitor-section" id="monitorSection">
            <div class="camera-card">
                <div class="video-wrapper">
                    <div style="color: #666; display: flex; flex-direction: column; align-items: center;">
                        <span style="font-size: 24px; opacity: 0.5;">OFFLINE</span>
                        <span style="font-size: 12px; margin-top: 10px; opacity: 0.3;">ç­‰å¾…è®¾å¤‡è¿æ¥</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="result-section">
            <div class="panel-header">
                <div class="panel-title">æ£€æµ‹ç»“æœåˆ†æ (Analysis)</div>
                <span id="status-tag" style="font-size: 14px; font-weight:bold; background: #f5f5f5; padding: 6px 16px; border-radius: 20px; color: #999;">Waiting</span>
            </div>

            <div class="panel-body" id="result-panel-body">
                <div class="empty-state">
                    <p>æš‚æ— æ£€æµ‹æ•°æ®ï¼Œè¯·ç‚¹å‡»å·¦ä¾§ "è§¦å‘æ£€æµ‹"</p>
                </div>
            </div>

            <template id="result-content-template">
                <div style="width: 100%; height: 100%; display: flex;">
                    <div class="result-view">
                        <div class="canvas-box" onclick="openLightbox()" title="ç‚¹å‡»æ”¾å¤§æŸ¥çœ‹">
                            <img class="res-img-display" src="">
                            <canvas class="res-canvas-display" style="position: absolute; top:0; left:0; width:100%; height:100%;"></canvas>
                            <div style="position:absolute; bottom:10px; right:10px; background:rgba(0,0,0,0.6); color:white; padding:4px 8px; border-radius:4px; font-size:12px; pointer-events:none;">ğŸ” ç‚¹å‡»æ”¾å¤§</div>
                        </div>
                    </div>
                    <div class="data-list-view">
                        <div class="batch-info-bar">
                            <div class="info-card">
                                <label>å·¥ä»¶åç§°</label>
                                <div class="val-part val">-</div>
                            </div>
                            <div class="info-card">
                                <label>æ‰¹æ¬¡å·</label>
                                <div class="val-batch val">-</div>
                            </div>
                            <div class="info-card">
                                <label>æ“ä½œå‘˜</label>
                                <div class="val-op val">-</div>
                            </div>
                        </div>

                        <div class="stats-bar">
                            <span class="stats-label">ç¼ºé™·ç»Ÿè®¡:</span>
                            <div class="stats-container" style="display:flex; gap:10px;">
                            </div>
                        </div>

                        <div class="table-container">
                            <table>
                                <thead>
                                <tr><th>ID</th><th>æ£€æµ‹ç±»å‹ (Class)</th><th>ç½®ä¿¡åº¦ (Conf)</th></tr>
                                </thead>
                                <tbody class="defect-tbody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>
</main>

<div id="lightbox" class="lightbox">
    <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
    <div class="lightbox-content">
        <img id="lightbox-img" class="lightbox-img" src="">
        <canvas id="lightbox-canvas" class="lightbox-canvas"></canvas>
    </div>
    <div style="color:white; margin-top:10px; font-size:14px;">æŒ‰ ESC é€€å‡ºå…¨å±</div>
</div>

<div id="confirmModal" class="modal">
    <div class="modal-card">
        <div class="modal-header">æ£€æµ‹å‚æ•°ç¡®è®¤</div>
        <div class="modal-body">
            <img id="preview-image" style="width: 100%; height: 150px; object-fit: contain; background: #333; border-radius: 4px; margin-bottom: 20px;" src="">
            <div class="form-item">
                <label>å·¥ä»¶åç§° (Part Name)</label>
                <input type="text" id="part-name">
            </div>
            <div class="form-item">
                <label>ç”Ÿäº§æ‰¹æ¬¡ (Batch ID)</label>
                <input type="text" id="batch-id">
            </div>
            <div class="form-item">
                <label>æ“ä½œå‘˜ (Operator)</label>
                <input type="text" id="operator" value="Admin">
            </div>
        </div>
        <div class="modal-footer">
            <button class="ctrl-btn" style="display:inline-block; width:auto; background:#ccc; color:#333; margin-right:10px;" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="ctrl-btn" style="display:inline-block; width:auto; background:var(--primary-color); color:white;" onclick="confirmInspection()">å¼€å§‹åˆ†æ</button>
        </div>
    </div>
</div>

<script>
    const API_BASE = '';
    let requestId = null;
    let currentDetections = [];
    let currentResultImageSrc = ''; // ä¿å­˜å½“å‰ç»“æœå›¾ç‰‡åœ°å€ä¾›æ”¾å¤§ä½¿ç”¨

    setInterval(() => {
        document.getElementById('clock').innerText = new Date().toLocaleTimeString();
    }, 1000);

    // --- æ‘„åƒå¤´æ§åˆ¶ ---
    async function startCamera() {
        try {
            const res = await fetch(`${API_BASE}/api/camera/start`, { method: 'POST' });
            const data = await res.json();
            if (data.status === 'success') {
                toggleState(true);
                initMonitors(data.cameraCount);
            }
        } catch(e) { alert('å¯åŠ¨å¤±è´¥: ' + e.message); }
    }

    function initMonitors(count) {
        const container = document.getElementById('monitorSection');
        container.innerHTML = '';
        const ts = new Date().getTime();

        for (let i = 0; i < count; i++) {
            const card = document.createElement('div');
            card.className = 'camera-card';
            card.innerHTML = `
                <div class="cam-overlay-info">
                    <div class="rec-dot"></div> CAM 0${i+1}
                </div>
                <div class="video-wrapper">
                    <img src="${API_BASE}/api/camera/stream/${i}?t=${ts}" onerror="this.style.display='none'">
                </div>
            `;
            container.appendChild(card);
        }
    }

    async function stopCamera() {
        try {
            await fetch(`${API_BASE}/api/camera/stop`, { method: 'POST' });
            toggleState(false);
            document.getElementById('monitorSection').innerHTML = `
                <div class="camera-card"><div class="video-wrapper"><div style="color: #666; text-align:center;"><span style="font-size: 24px; opacity: 0.5;">SYSTEM HALTED</span></div></div></div>`;
        } catch(e) {}
    }

    function toggleState(isOn) {
        document.getElementById('startBtn').disabled = isOn;
        document.getElementById('stopBtn').disabled = !isOn;
        document.getElementById('inspectBtn').disabled = !isOn;
    }

    // --- æ£€æµ‹é€»è¾‘ ---
    async function startPreCheck() {
        try {
            const res = await fetch(`${API_BASE}/api/inspect/pre-check`, { method: 'POST' });
            const data = await res.json();
            if(data.status === 'success') {
                requestId = data.data.requestId;
                document.getElementById('preview-image').src = data.data.preview_image;
                if(data.data.suggested_type) document.getElementById('part-name').value = data.data.suggested_type;
                document.getElementById('confirmModal').style.display = 'block';
            }
        } catch(e) { console.error(e); }
    }

    async function confirmInspection() {
        const part = document.getElementById('part-name').value;
        const batch = document.getElementById('batch-id').value;
        const op = document.getElementById('operator').value;
        if(!part || !batch) return alert('è¯·å®Œå–„ä¿¡æ¯');

        closeModal();

        try {
            const res = await fetch(`${API_BASE}/api/inspect/confirm`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ request_id: requestId, confirmed_part_name: part, batch_id: batch, operator: op })
            });
            const data = await res.json();
            if(data.status === 'success') showResults(data.data);
            else alert(data.message);
        } catch(e) { alert(e.message); }
    }

    function showResults(data) {
        const panelBody = document.getElementById('result-panel-body');
        const template = document.getElementById('result-content-template').content.cloneNode(true);

        panelBody.innerHTML = '';
        panelBody.appendChild(template);

        const img = panelBody.querySelector('.res-img-display');
        const canvas = panelBody.querySelector('.res-canvas-display');
        const tbody = panelBody.querySelector('.defect-tbody');
        const statsContainer = panelBody.querySelector('.stats-container'); // ç»Ÿè®¡å®¹å™¨
        const statusTag = document.getElementById('status-tag');

        // ä¿å­˜å…¨å±€ä¾›æ”¾å¤§ä½¿ç”¨
        currentResultImageSrc = data.result_image;
        img.src = data.result_image;

        // å¡«å……é†’ç›®çš„å¡ç‰‡ä¿¡æ¯
        panelBody.querySelector('.val-part').innerText = data.batch_info.part_name;
        panelBody.querySelector('.val-batch').innerText = data.batch_info.batch_id;
        panelBody.querySelector('.val-op').innerText = data.batch_info.operator;

        const isPass = data.analysis.quality_status === 'PASS';
        statusTag.innerText = isPass ? 'PASS / è´¨æ£€åˆæ ¼' : 'FAIL / è´¨æ£€ä¸åˆæ ¼';
        statusTag.style.background = isPass ? '#f6ffed' : '#fff1f0';
        statusTag.style.color = isPass ? '#52c41a' : '#f5222d';

        currentDetections = data.analysis.details || [];

        // --- æ ¸å¿ƒæ–°å¢ï¼šç»Ÿè®¡é€»è¾‘ ---
        const stats = {};
        currentDetections.forEach(det => {
            const label = det.label || 'Unknown';
            stats[label] = (stats[label] || 0) + 1;
        });

        statsContainer.innerHTML = '';
        if (Object.keys(stats).length === 0) {
            statsContainer.innerHTML = '<span style="color:#999; font-size:12px;">æ— ç¼ºé™·ç›®æ ‡</span>';
        } else {
            for (const [key, count] of Object.entries(stats)) {
                const pill = document.createElement('div');
                pill.className = 'stat-pill';
                pill.innerHTML = `${key}: <b>${count}</b>`;
                statsContainer.appendChild(pill);
            }
        }
        // -----------------------

        tbody.innerHTML = '';
        currentDetections.forEach((det, idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${idx + 1}</td>
                <td>${det.label}</td>
                <td>${(det.confidence * 100).toFixed(0)}%</td>
            `;
            tr.onclick = () => {
                const rows = tbody.querySelectorAll('tr');
                rows.forEach(r => r.classList.remove('active'));
                tr.classList.add('active');
                drawBoxes(img, canvas, idx);
            };
            tbody.appendChild(tr);
        });

        if(img.complete && img.naturalHeight !== 0) {
             drawBoxes(img, canvas, -1);
        } else {
             img.onload = () => drawBoxes(img, canvas, -1);
        }
    }

    // ç»˜åˆ¶æ¡†æ ¸å¿ƒå‡½æ•° (å¤ç”¨)
    function drawBoxes(imgElement, canvasElement, activeIdx) {
        if (!imgElement || imgElement.clientWidth === 0) return;

        canvasElement.width = imgElement.clientWidth;
        canvasElement.height = imgElement.clientHeight;
        const ctx = canvasElement.getContext('2d');
        ctx.clearRect(0,0, canvasElement.width, canvasElement.height);

        const scaleX = imgElement.clientWidth / imgElement.naturalWidth;
        const scaleY = imgElement.clientHeight / imgElement.naturalHeight;

        currentDetections.forEach((det, idx) => {
            const isActive = idx === activeIdx;
            const [x1, y1, x2, y2] = det.bbox;
            const x = x1 * scaleX;
            const y = y1 * scaleY;
            const w = (x2 - x1) * scaleX;
            const h = (y2 - y1) * scaleY;

            ctx.beginPath();
            ctx.lineWidth = isActive ? 4 : 2; // æ”¾å¤§æ—¶çº¿æ›´ç²—ä¸€ç‚¹
            ctx.strokeStyle = isActive ? '#ff4d4f' : '#1890ff';
            ctx.fillStyle = isActive ? 'rgba(255, 77, 79, 0.3)' : 'rgba(24,144,255,0.1)';

            // ç»˜åˆ¶æ–‡å­—èƒŒæ™¯ (ä»…åœ¨æ”¾å¤§æ¨¡å¼æˆ–é«˜äº®æ—¶æ˜¾ç¤ºæ–‡å­—ï¼Œé¿å…æ‹¥æŒ¤)
            if (isActive || canvasElement.id === 'lightbox-canvas') {
                ctx.font = "bold 14px Arial";
                const txt = `${det.label} ${(det.confidence*100).toFixed(0)}%`;
                const txtWidth = ctx.measureText(txt).width;
                ctx.fillStyle = isActive ? '#ff4d4f' : '#1890ff';
                ctx.fillRect(x, y - 20, txtWidth + 10, 20);

                ctx.fillStyle = 'white';
                ctx.fillText(txt, x + 5, y - 5);

                // è¿˜åŸå¡«å……è‰²ç»™æ¡†
                ctx.fillStyle = isActive ? 'rgba(255, 77, 79, 0.3)' : 'rgba(24,144,255,0.1)';
            }

            ctx.rect(x, y, w, h);
            ctx.stroke();
            ctx.fill();
        });
    }

    // --- æ”¾å¤§æŸ¥çœ‹ (Lightbox) é€»è¾‘ ---
    function openLightbox() {
        if (!currentResultImageSrc) return;
        const lightbox = document.getElementById('lightbox');
        const lbImg = document.getElementById('lightbox-img');
        const lbCanvas = document.getElementById('lightbox-canvas');

        lightbox.style.display = 'flex';
        lbImg.src = currentResultImageSrc;

        // å›¾ç‰‡åŠ è½½å®Œæˆåç»˜åˆ¶å¤§å›¾çš„æ¡†
        lbImg.onload = () => {
            drawBoxes(lbImg, lbCanvas, -1);
        };
        // å¦‚æœå·²ç»ç¼“å­˜
        if (lbImg.complete) {
            drawBoxes(lbImg, lbCanvas, -1);
        }
    }

    function closeLightbox() {
        document.getElementById('lightbox').style.display = 'none';
    }

    // é”®ç›˜ESCå…³é—­æ”¾å¤§
    document.addEventListener('keydown', function(event) {
        if (event.key === "Escape") closeLightbox();
    });

    // çª—å£å¤§å°å˜åŒ–æ—¶é‡ç»˜Canvas
    window.onresize = () => {
        const img = document.querySelector('.res-img-display');
        const canvas = document.querySelector('.res-canvas-display');
        if(img && canvas) drawBoxes(img, canvas, -1);

        // å¦‚æœå…¨å±å¼€å¯ä¸­ï¼Œä¹Ÿè¦é‡ç»˜
        const lb = document.getElementById('lightbox');
        if (lb.style.display === 'flex') {
             const lbImg = document.getElementById('lightbox-img');
             const lbCanvas = document.getElementById('lightbox-canvas');
             drawBoxes(lbImg, lbCanvas, -1);
        }
    }

    function closeModal() {
        document.getElementById('confirmModal').style.display = 'none';
    }
</script>
</body>
</html>