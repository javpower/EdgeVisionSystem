<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EdgeVision Pro | 智能视觉工作台</title>
    <style>
        :root {
            --sidebar-bg: #001529;
            --sidebar-width: 220px;
            --primary-color: #1890ff;
            --bg-body: #f0f2f5;
            --header-height: 48px;
            --card-radius: 8px;
            --success-color: #52c41a;
            --warning-color: #faad14;
            --danger-color: #ff4d4f;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-body);
            height: 100vh;
            display: flex;
            overflow: hidden;
            color: #333;
        }

        aside {
            width: var(--sidebar-width);
            background: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
            color: rgba(255,255,255,0.65);
            z-index: 10;
            box-shadow: 2px 0 8px rgba(0,0,0,0.15);
        }

        .brand {
            height: 60px;
            display: flex;
            align-items: center;
            padding-left: 20px;
            font-size: 18px;
            font-weight: 700;
            color: white;
            letter-spacing: 1px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .brand span { color: var(--primary-color); }

        .menu { flex: 1; padding: 20px 10px; display: flex; flex-direction: column; gap: 12px; overflow-y: auto; }
        .menu-label { font-size: 12px; margin-bottom: 5px; padding-left: 10px; text-transform: uppercase; opacity: 0.5; }

        .ctrl-btn {
            background: rgba(255,255,255,0.08);
            border: none;
            color: white;
            padding: 12px 15px;
            border-radius: 6px;
            cursor: pointer;
            text-align: left;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }
        .ctrl-btn:hover:not(:disabled) { background: var(--primary-color); color: white; transform: translateX(5px); }
        .ctrl-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .ctrl-btn.stop:hover:not(:disabled) { background: #ff4d4f; }

        .stitch-status {
            background: rgba(255,255,255,0.05);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 12px;
        }
        .stitch-status .status-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .stitch-status .status-label { opacity: 0.7; }
        .stitch-status .status-value { color: var(--primary-color); font-weight: 600; }
        .stitch-status.manual .status-value { color: var(--warning-color); }

        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        header {
            height: var(--header-height);
            background: white;
            border-bottom: 1px solid #e8e8e8;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            font-size: 13px;
            color: #666;
            flex-shrink: 0;
        }

        .workspace {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow: hidden;
            min-height: 0;
        }

        /* 全景 Canvas 监控区 (前端拼接) */
        .panorama-section {
            background: black;
            border-radius: var(--card-radius);
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid #333;
            flex: 0 0 calc((100vh - var(--header-height) - 40px - 40px) * 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 300px;
        }

        .panorama-canvas {
            max-width: 100%;
            max-height: 60vh;
            object-fit: contain;
        }

        .panorama-overlay {
            position: absolute; top: 15px; left: 15px;
            background: rgba(0,0,0,0.7); color: #fff;
            padding: 8px 15px; border-radius: 6px; font-size: 13px;
            display: flex; align-items: center; gap: 10px;
            backdrop-filter: blur(5px);
            z-index: 10;
        }
        .rec-dot { width: 10px; height: 10px; background: #52c41a; border-radius: 50%; box-shadow: 0 0 8px #52c41a; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .panorama-placeholder {
            color: #666; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .panorama-placeholder span { font-size: 28px; opacity: 0.4; }
        .panorama-placeholder p { font-size: 13px; margin-top: 10px; opacity: 0.3; }

        /* 结果面板 */
        .result-section {
            flex: 1;
            background: white;
            border-radius: var(--card-radius);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #e8e8e8;
            min-height: 0;
        }

        .panel-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            min-height: 0;
        }

        .panel-header {
            padding: 15px 24px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fafafa;
        }

        .panel-title {
            font-size: 16px;
            font-weight: 700;
            color: #333;
            border-left: 4px solid var(--primary-color);
            padding-left: 12px;
        }

        /* 质检状态标签 */
        .status-tag {
            font-size: 16px;
            font-weight: 700;
            padding: 8px 20px;
            border-radius: 24px;
            letter-spacing: 0.5px;
        }
        .status-tag.waiting {
            background: #f5f5f5;
            color: #999;
        }
        .status-tag.pass {
            background: linear-gradient(135deg, #52c41a 0%, #73d13d 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(82, 196, 26, 0.3);
        }
        .status-tag.fail {
            background: linear-gradient(135deg, #ff4d4f 0%, #ff7875 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(255, 77, 79, 0.3);
            animation: pulse-fail 1.5s infinite;
        }
        @keyframes pulse-fail {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .result-view {
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }

        .result-image {
            flex: 0 0 auto;
            background: #f7f9fa;
            border-radius: 8px;
            padding: 10px;
            display: inline-block;
            max-width: 240px;
        }

        .result-image img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 4px;
            cursor: zoom-in;
            box-shadow: 0 2px 12px rgba(0,0,0,0.15);
            display: block;
        }

        .result-info {
            flex: 1;
            min-width: 0;
        }

        .batch-info-bar {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 15px;
        }
        .info-card {
            background: #f8faff;
            border: 1px solid #d6e4ff;
            padding: 10px 12px;
            border-radius: 6px;
        }
        .info-card label {
            display: block;
            font-size: 11px;
            color: #85a5ff;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .info-card .val {
            font-size: 14px;
            font-weight: 700;
            color: #003a8c;
        }

        /* 统计信息样式 */
        .summary-stats {
            margin-bottom: 20px;
        }
        .summary-title {
            font-size: 13px;
            color: #999;
            font-weight: 500;
            margin-bottom: 12px;
        }
        .summary-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .summary-card {
            display: flex;
            align-items: baseline;
            gap: 6px;
            padding: 8px 14px;
            background: #f5f5f5;
            border-radius: 20px;
            border: 1px solid #e8e8e8;
        }
        .summary-type {
            font-size: 13px;
            color: #666;
        }
        .summary-count {
            font-size: 18px;
            font-weight: 700;
            color: #1890ff;
        }
        .no-defects {
            color: #52c41a;
            font-size: 14px;
            padding: 8px 14px;
            background: #f6ffed;
            border-radius: 20px;
            border: 1px solid #b7eb8f;
            display: inline-block;
        }

        .table-container { border: 1px solid #f0f0f0; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; padding: 10px 12px; color: #999; font-weight: 500; font-size: 11px; background: #fafafa; border-bottom: 1px solid #eee; }
        td { padding: 8px 12px; border-bottom: 1px solid #f5f5f5; }
        tr:hover td { background: #fff7e6; }
        tr[data-index] td { transition: background 0.2s; }

        .empty-state {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 40px; color: #999; font-size: 13px;
        }

        /* Modal - 底部滑入，更宽更低（拼接设置用） */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .modal-card.bottom-panel {
            background: white;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            max-height: 40vh;
            border-radius: 12px;
            box-shadow: 0 -5px 40px rgba(0,0,0,0.2);
            overflow: hidden;
            animation: slideInUp 0.3s;
            display: flex;
            flex-direction: column;
            width: 90%;
            max-width: 900px;
        }
        @keyframes slideInUp { from { transform: translate(-50%, 100%); } to { transform: translate(-50%, 0); } }

        /* 检测确认模态框 - 居中大尺寸 */
        .modal-card.center-dialog {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 500px;
            background: white;
            max-height: 90vh;
            border-radius: 8px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
            overflow: hidden;
            animation: fadeIn 0.3s;
            display: flex;
            flex-direction: column;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translate(-50%, -50%) scale(0.95); } to { opacity: 1; transform: translate(-50%, -50%) scale(1); } }

        .modal-header {
            padding: 16px 20px;
            background: #fbfbfb;
            border-bottom: 1px solid #eee;
            font-weight: 600;
            font-size: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .modal-close {
            background: none; border: none;
            font-size: 24px; cursor: pointer;
            color: #999; width: 30px; height: 30px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 4px;
        }
        .modal-close:hover { background: #f0f0f0; }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
            max-height: calc(40vh - 100px);
        }
        .modal-card.center-dialog .modal-body {
            max-height: none;
            overflow-y: visible;
        }
        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid #eee;
            background: #fbfbfb;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            flex-shrink: 0;
        }

        /* 小屏幕适配 */
        @media (max-width: 768px) {
            .modal-card.bottom-panel {
                width: 95%;
                max-height: 60vh;
                bottom: 10px;
            }
            .modal-card.bottom-panel .modal-body {
                max-height: calc(60vh - 100px);
            }
            .modal-card.center-dialog {
                width: 90%;
            }
        }

        .form-item { margin-bottom: 15px; }
        .form-item label { display: block; font-size: 12px; color: #666; margin-bottom: 5px; }
        .form-item input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }

        /* 拼接配置样式 */
        .strategy-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        .strategy-option {
            flex: 1;
            padding: 10px 8px;
            border: 2px solid #e8e8e8;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .strategy-option:hover { border-color: var(--primary-color); background: #f0f9ff; }
        .strategy-option.active {
            border-color: var(--primary-color);
            background: #e6f7ff;
        }
        .strategy-option .name { font-weight: 600; font-size: 13px; }
        .strategy-option .desc { font-size: 10px; color: #999; }

        .manual-config-section {
            background: #fffbf0;
            border: 1px solid #ffe58f;
            border-radius: 6px;
            padding: 14px;
            margin-bottom: 16px;
        }
        .manual-config-section .section-title {
            font-size: 13px;
            font-weight: 600;
            color: #d46b08;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .manual-config-section .section-title .live-indicator {
            width: 8px; height: 8px;
            background: #52c41a;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        .camera-config-item {
            background: white;
            border: 1px solid #e8e8e8;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
        }
        .camera-config-item .camera-title {
            font-weight: 600;
            font-size: 12px;
            color: #333;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f0f0f0;
        }

        .param-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .param-item label {
            font-size: 11px;
            color: #999;
            margin-bottom: 4px;
            display: block;
        }
        .param-item input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e8e8e8;
            outline: none;
            -webkit-appearance: none;
        }
        .param-item input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
        }

        .range-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .range-wrapper input[type="range"] { flex: 1; }
        .range-wrapper .range-value {
            min-width: 45px;
            text-align: right;
            font-size: 11px;
            color: #666;
            font-weight: 600;
        }

        .preview-note {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            border-radius: 6px;
            padding: 10px 12px;
            font-size: 12px;
            color: #0050b3;
            margin-bottom: 15px;
        }

        .btn {
            padding: 10px 18px; border: none; border-radius: 4px; cursor: pointer;
            font-size: 14px; font-weight: 500; transition: all 0.3s;
        }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-primary:hover { background: #40a9ff; }
        .btn-secondary { background: #f5f5f5; color: #666; }
        .btn-secondary:hover { background: #e8e8e8; }
        .btn-success { background: var(--success-color); color: white; }
        .btn-success:hover { background: #73d13d; }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 12px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 3000;
            display: none;
        }
        .toast.success { border-left: 4px solid var(--success-color); }
        .toast.error { border-left: 4px solid var(--danger-color); }
        .toast.warning { border-left: 4px solid var(--warning-color); }

        .hidden { display: none !important; }

        /* 系统设置标签页样式 */
        .tab-header {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            border-bottom: 1px solid #e8e8e8;
        }
        .tab-option {
            flex: 1;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 2px solid transparent;
            font-weight: 500;
            color: #666;
        }
        .tab-option:hover {
            color: var(--primary-color);
        }
        .tab-option.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* 质检标准配置样式 */
        .quality-standards-section {
            background: #f0f9ff;
            border: 1px solid #91d5ff;
            border-radius: 6px;
            padding: 14px;
            margin-bottom: 16px;
        }
        .quality-standards-section .section-title {
            font-size: 13px;
            font-weight: 600;
            color: #0050b3;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .part-type-item {
            background: white;
            border: 1px solid #e8e8e8;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
        }
        .part-type-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f0f0f0;
        }
        .part-type-name {
            font-weight: 600;
            font-size: 13px;
            color: #333;
        }
        .defect-standard-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #fafafa;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        .defect-type-input {
            flex: 2;
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }
        .operator-select {
            flex: 1;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            background: white;
        }
        .threshold-input {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            width: 60px;
        }
        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #999;
            padding: 4px 8px;
            border-radius: 4px;
        }
        .btn-icon:hover {
            color: #ff4d4f;
            background: #fff1f0;
        }
        .btn-add {
            font-size: 12px;
            padding: 6px 12px;
            background: #e6f7ff;
            color: #1890ff;
            border: 1px dashed #1890ff;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
        }
        .btn-add:hover {
            background: #bae7ff;
        }
    </style>
</head>
<body>

<aside>
    <div class="brand">
        EDGE<span>VISION</span>
    </div>

    <div class="menu">
        <div class="menu-label">Device Control</div>
        <button class="ctrl-btn" onclick="startCamera()" id="startBtn">
            ▶ 启动监控
        </button>
        <button class="ctrl-btn stop" onclick="stopCamera()" id="stopBtn" disabled>
            ⏹ 停止监控
        </button>

        <div class="stitch-status" id="stitchStatus">
            <div class="status-row">
                <span class="status-label">拼接策略:</span>
                <span class="status-value" id="currentStrategy">-</span>
            </div>
        </div>

        <div class="menu-label" style="margin-top: 20px;">Inspection</div>
        <button class="ctrl-btn" onclick="startPreCheck()" id="inspectBtn" disabled>
            ◎ 开始检测
        </button>
    </div>

    <div style="padding: 20px; margin-top: auto;">
        <button class="ctrl-btn" onclick="openSystemConfigModal()" id="systemConfigBtn" style="width: 100%; opacity: 0.5;">
            ⚙ 系统设置
        </button>
    </div>
</aside>

<main>
    <header>
        <div><b>工作台</b> / 实时监控与分析</div>
        <div id="clock">00:00:00</div>
    </header>

    <div class="workspace">
        <!-- 全景 Canvas 监控区 (前端拼接) -->
        <div class="panorama-section">
            <div class="panorama-placeholder" id="panoramaPlaceholder">
                <span>OFFLINE</span>
                <p>点击左侧"启动监控"查看拼接画面</p>
            </div>
            <canvas id="panoramaCanvas" class="panorama-canvas" style="display: none;"></canvas>
            <div class="panorama-overlay" id="panoramaOverlay" style="display: none;">
                <div class="rec-dot"></div>
                <span>实时拼接</span>
            </div>
        </div>

        <!-- 检测结果区 -->
        <div class="result-section">
            <div class="panel-header">
                <div class="panel-title">检测结果分析</div>
                <div id="status-tag" class="status-tag waiting">等待检测</div>
            </div>
            <div class="panel-body" id="result-panel-body">
                <div class="empty-state">
                    <p>暂无检测数据，请点击左侧 "开始检测"</p>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- 检测确认模态框 -->
<div id="confirmModal" class="modal">
    <div class="modal-card center-dialog">
        <div class="modal-header">
            <span>检测参数确认</span>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <img id="preview-image" style="width: 100%; height: 180px; object-fit: contain; background: #333; border-radius: 4px; margin-bottom: 20px;" src="">
            <div class="form-item">
                <label>工件名称</label>
                <input type="text" id="part-name" style="padding: 12px; font-size: 14px;">
            </div>
            <div class="form-item">
                <label>生产批次</label>
                <input type="text" id="batch-id" style="padding: 12px; font-size: 14px;">
            </div>
            <div class="form-item">
                <label>操作员</label>
                <input type="text" id="operator" value="Admin" style="padding: 12px; font-size: 14px;">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">取消</button>
            <button class="btn btn-primary" onclick="confirmInspection()">开始分析</button>
        </div>
    </div>
</div>

<!-- 系统设置模态框 -->
<div id="systemConfigModal" class="modal">
    <div class="modal-card bottom-panel">
        <div class="modal-header">
            <span>系统设置</span>
            <button class="modal-close" onclick="closeSystemConfigModal()">&times;</button>
        </div>
        <div class="modal-body">
            <!-- 标签页头部 -->
            <div class="tab-header">
                <div class="tab-option active" data-tab="stitch" onclick="switchTab('stitch')">拼接设置</div>
                <div class="tab-option" data-tab="quality" onclick="switchTab('quality')">质检标准设置</div>
            </div>

            <!-- 拼接设置标签内容 -->
            <div class="tab-content active" id="stitchTabContent">
                <div style="margin-bottom: 15px;">
                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 8px;">拼接策略</label>
                    <div class="strategy-selector">
                        <div class="strategy-option" data-strategy="simple" onclick="selectStrategy('simple')">
                            <div class="name">Simple</div>
                            <div class="desc">简单拼接</div>
                        </div>
                        <div class="strategy-option" data-strategy="auto" onclick="selectStrategy('auto')">
                            <div class="name">Auto</div>
                            <div class="desc">自动拼接</div>
                        </div>
                        <div class="strategy-option" data-strategy="manual" onclick="selectStrategy('manual')">
                            <div class="name">Manual</div>
                            <div class="desc">手动调节</div>
                        </div>
                    </div>
                </div>

                <div class="manual-config-section" id="manualConfigSection" style="display: none;">
                    <div class="section-title">
                        <div class="live-indicator"></div>
                        实时参数调节
                    </div>

                    <div class="preview-note">
                        拖动滑块实时预览拼接效果，满意后点击保存
                    </div>

                    <div id="cameraConfigsContainer">
                        <!-- 动态生成 -->
                    </div>
                </div>
            </div>

            <!-- 质检标准设置标签内容 -->
            <div class="tab-content" id="qualityTabContent">
                <div class="quality-standards-section">
                    <div class="section-title">
                        <span>质检标准配置</span>
                        <button class="btn btn-secondary" style="font-size: 11px; padding: 4px 10px;" onclick="addPartType()">+ 添加工件类型</button>
                    </div>

                    <div class="preview-note" style="margin-bottom: 12px;">
                        支持操作符：&lt;=（不超过）、&gt;=（至少）、==（精确匹配）、&lt;（少于）、&gt;（多于）
                    </div>

                    <div id="qualityStandardsContainer">
                        <!-- 动态生成 -->
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="resetCurrentConfig()">重置</button>
            <button class="btn btn-success" onclick="saveCurrentConfig()">保存配置</button>
        </div>
    </div>
</div>

<!-- Toast 提示 -->
<div id="toast" class="toast"></div>

<script>
    const API_BASE = '';
    let requestId = null;

    // 拼接配置相关
    let currentStrategy = 'simple';
    let manualConfigs = {};
    let cameraCount = 2;
    let isManualModeAvailable = false;
    let isPreviewMode = false;

    // Canvas 拼接相关
    let panoramaCanvas = null;
    let panoramaCtx = null;
    let offscreenCanvas = null; // 离屏 Canvas 用于双缓冲
    let offscreenCtx = null;
    let cameraStreams = []; // 隐藏的 img 元素用于加载 MJPEG 流
    let animationId = null;
    let lastFetchTime = 0;
    let lastCanvasWidth = 0;
    let lastCanvasHeight = 0;

    setInterval(() => {
        document.getElementById('clock').innerText = new Date().toLocaleTimeString();
    }, 1000);

    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = `toast ${type}`;
        toast.style.display = 'block';
        setTimeout(() => { toast.style.display = 'none'; }, 3000);
    }

    // --- 摄像头控制 ---
    async function startCamera() {
        try {
            const res = await fetch(`${API_BASE}/api/camera/start`, { method: 'POST' });
            const data = await res.json();
            if (data.status === 'success') {
                cameraCount = data.cameraCount;
                toggleState(true);
                initPanoramaCanvas();
                updateStitchStatus();
                startCanvasStitch();
                showToast('摄像头启动成功');
            }
        } catch(e) { alert('启动失败: ' + e.message); }
    }

    function initPanoramaCanvas() {
        panoramaCanvas = document.getElementById('panoramaCanvas');
        panoramaCtx = panoramaCanvas.getContext('2d', { alpha: false }); // 优化：关闭透明通道

        // 创建离屏 Canvas 用于双缓冲
        offscreenCanvas = document.createElement('canvas');
        offscreenCtx = offscreenCanvas.getContext('2d', { alpha: false });

        document.getElementById('panoramaPlaceholder').style.display = 'none';
        panoramaCanvas.style.display = 'block';
        document.getElementById('panoramaOverlay').style.display = 'flex';

        // 创建隐藏的 img 元素加载 MJPEG 流
        const hiddenContainer = document.createElement('div');
        hiddenContainer.style.position = 'absolute';
        hiddenContainer.style.visibility = 'hidden';
        hiddenContainer.style.width = '0';
        hiddenContainer.style.height = '0';
        hiddenContainer.style.overflow = 'hidden';

        for (let i = 0; i < cameraCount; i++) {
            const img = document.createElement('img');
            img.crossOrigin = 'anonymous'; // 允许跨域
            img.src = `${API_BASE}/api/camera/stream/${i}?t=${Date.now()}`;
            hiddenContainer.appendChild(img);
            cameraStreams.push(img);
        }

        document.body.appendChild(hiddenContainer);

        lastCanvasWidth = 0;
        lastCanvasHeight = 0;
    }

    // Canvas 拼接主循环
    async function startCanvasStitch() {
        const fetchInterval = 50; // 约 20fps，避免过于频繁

        async function stitchLoop() {
            if (!document.getElementById('stopBtn').disabled) {
                const now = Date.now();
                if (now - lastFetchTime >= fetchInterval) {
                    stitchFromStreams();
                    lastFetchTime = now;
                }
            }
            animationId = requestAnimationFrame(stitchLoop);
        }

        // 等待图片加载完成后再开始循环
        setTimeout(() => {
            stitchLoop();
        }, 1000);
    }

    // 从 MJPEG 流截取画面并拼接
    function stitchFromStreams() {
        // 检查所有流是否已加载
        const loadedImages = cameraStreams.filter(img => img.complete && img.naturalWidth > 0);

        if (loadedImages.length === cameraCount) {
            stitchImagesOnCanvas(loadedImages);
        }
    }

    function stitchImagesOnCanvas(images) {
        if (!offscreenCtx || images.length === 0) return;

        // 根据策略设置画布尺寸
        let canvasWidth, canvasHeight;

        if (currentStrategy === 'manual' && Object.keys(manualConfigs).length > 0) {
            // 手动模式：根据参数计算画布大小
            let totalWidth = 0;
            let maxHeight = 0;

            images.forEach((img, index) => {
                const config = manualConfigs[index] || {
                    offset: [0, 0],
                    scale: 1.0
                };
                // 使用 naturalWidth/Height 获取图像的实际尺寸
                const scaledWidth = img.naturalWidth * config.scale;
                const scaledHeight = img.naturalHeight * config.scale;
                const overlapWidth = config.overlapWidth || 0;

                totalWidth += scaledWidth - overlapWidth;
                maxHeight = Math.max(maxHeight, scaledHeight + Math.abs(config.offset[1]));
            });

            canvasWidth = Math.round(totalWidth);
            canvasHeight = Math.round(maxHeight);
        } else {
            // Simple/Auto 模式：简单水平拼接
            canvasWidth = images.reduce((sum, img) => sum + img.naturalWidth, 0);
            canvasHeight = Math.max(...images.map(img => img.naturalHeight));
        }

        // 只有尺寸真正变化时才调整 Canvas（避免频繁重置）
        if (canvasWidth !== lastCanvasWidth || canvasHeight !== lastCanvasHeight) {
            offscreenCanvas.width = canvasWidth;
            offscreenCanvas.height = canvasHeight;
            panoramaCanvas.width = canvasWidth;
            panoramaCanvas.height = canvasHeight;
            lastCanvasWidth = canvasWidth;
            lastCanvasHeight = canvasHeight;
        }

        // 在离屏 Canvas 上绘制背景
        offscreenCtx.fillStyle = '#000';
        offscreenCtx.fillRect(0, 0, canvasWidth, canvasHeight);

        // 绘制图像
        let offsetX = 0;

        images.forEach((img, index) => {
            let drawX, drawY, drawWidth, drawHeight;

            if (currentStrategy === 'manual' && manualConfigs[index]) {
                const config = manualConfigs[index];
                drawWidth = img.naturalWidth * config.scale;
                drawHeight = img.naturalHeight * config.scale;
                drawX = offsetX + config.offset[0];
                drawY = (canvasHeight - drawHeight) / 2 + config.offset[1];

                const overlapWidth = config.overlapWidth || 0;
                offsetX += drawWidth - overlapWidth;
            } else {
                drawWidth = img.naturalWidth;
                drawHeight = img.naturalHeight;
                drawX = offsetX;
                drawY = (canvasHeight - img.naturalHeight) / 2;
                offsetX += img.naturalWidth;
            }

            // 绘制到离屏 Canvas
            try {
                offscreenCtx.drawImage(img, drawX, drawY, drawWidth, drawHeight);
            } catch(e) {
                // 忽略绘制错误
            }
        });

        // 一次性将离屏 Canvas 复制到主 Canvas（避免闪烁）
        panoramaCtx.drawImage(offscreenCanvas, 0, 0);
    }

    async function stopCamera() {
        try {
            await fetch(`${API_BASE}/api/camera/stop`, { method: 'POST' });
            toggleState(false);

            // 停止 Canvas 循环
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }

            // 清理隐藏的流容器
            cameraStreams.forEach(img => {
                img.src = '';
            });
            cameraStreams = [];

            // 重置显示
            document.getElementById('panoramaPlaceholder').style.display = 'flex';
            panoramaCanvas.style.display = 'none';
            document.getElementById('panoramaOverlay').style.display = 'none';

            showToast('摄像头已停止', 'warning');
        } catch(e) {}
    }

    function toggleState(isOn) {
        document.getElementById('startBtn').disabled = isOn;
        document.getElementById('stopBtn').disabled = !isOn;
        document.getElementById('inspectBtn').disabled = !isOn;
    }

    // --- 检测逻辑 ---
    async function startPreCheck() {
        try {
            const res = await fetch(`${API_BASE}/api/inspect/pre-check`, { method: 'POST' });
            const data = await res.json();
            if(data.status === 'success') {
                requestId = data.data.requestId;
                document.getElementById('preview-image').src = data.data.preview_image;
                if(data.data.suggested_type) document.getElementById('part-name').value = data.data.suggested_type;
                document.getElementById('confirmModal').style.display = 'block';
            }
        } catch(e) {}
    }

    async function confirmInspection() {
        const part = document.getElementById('part-name').value;
        const batch = document.getElementById('batch-id').value;
        const op = document.getElementById('operator').value;
        if(!part || !batch) return showToast('请完善信息', 'error');

        closeModal();

        try {
            const res = await fetch(`${API_BASE}/api/inspect/confirm`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ request_id: requestId, confirmed_part_name: part, batch_id: batch, operator: op })
            });
            const data = await res.json();
            if(data.status === 'success') showResults(data.data);
            else showToast(data.message, 'error');
        } catch(e) { showToast(e.message, 'error'); }
    }

    function showResults(data) {
        const panelBody = document.getElementById('result-panel-body');

        // 计算每种类型的统计数量
        const typeCounts = {};
        const details = data.analysis.details || [];
        details.forEach(det => {
            typeCounts[det.label] = (typeCounts[det.label] || 0) + 1;
        });

        panelBody.innerHTML = `
            <div class="result-view">
                <div class="result-image">
                    <div class="image-wrapper" style="position: relative; display: inline-block;">
                        <img id="resultImage" src="${data.result_image}" onclick="showImagePreview(this.src)" style="cursor: pointer;" title="点击放大查看">
                        <canvas id="bboxCanvas" style="position: absolute; top: 0; left: 0; pointer-events: none;"></canvas>
                    </div>
                </div>
                <div class="result-info">
                    <div class="batch-info-bar">
                        <div class="info-card">
                            <label>工件名称</label>
                            <div class="val">${data.batch_info.part_name}</div>
                        </div>
                        <div class="info-card">
                            <label>批次号</label>
                            <div class="val">${data.batch_info.batch_id}</div>
                        </div>
                        <div class="info-card">
                            <label>操作员</label>
                            <div class="val">${data.batch_info.operator}</div>
                        </div>
                    </div>

                    <!-- 统计信息 -->
                    <div class="summary-stats">
                        <div class="summary-title">类型统计</div>
                        <div class="summary-cards">
                            ${Object.entries(typeCounts).map(([type, count]) => `
                                <div class="summary-card">
                                    <div class="summary-type">${type}</div>
                                    <div class="summary-count">${count}</div>
                                </div>
                            `).join('')}
                            ${Object.keys(typeCounts).length === 0 ? '<div class="no-defects">无缺陷检出</div>' : ''}
                        </div>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead><tr><th>ID</th><th>类型</th><th>坐标</th><th>置信度</th></tr></thead>
                            <tbody id="resultTableBody">
                                ${details.map((det, i) => `
                                    <tr data-index="${i}" onclick="highlightBBox(${i})" style="cursor: pointer;">
                                        <td>${i + 1}</td>
                                        <td>${det.label}</td>
                                        <td>${det.bbox ? `[${det.bbox.map(v => Math.round(v)).join(', ')}]` : '-'}</td>
                                        <td>${(det.confidence * 100).toFixed(0)}%</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;

        // 绘制检测框
        setTimeout(() => {
            drawBBoxes(details);
        }, 100);

        const statusTag = document.getElementById('status-tag');
        const isPass = data.analysis.quality_status === 'PASS';
        statusTag.className = 'status-tag ' + (isPass ? 'pass' : 'fail');
        statusTag.innerText = isPass ? '✓ 质检合格' : '✗ 质检不合格';
    }

    // 全局变量用于存储检测框数据
    let bboxesData = [];
    let canvasCtx = null;
    let selectedIndex = -1;

    function drawBBoxes(details) {
        const img = document.getElementById('resultImage');
        const canvas = document.getElementById('bboxCanvas');
        if (!img || !canvas) return;

        bboxesData = details;
        selectedIndex = -1;

        // 设置 canvas 尺寸与图片一致
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        canvas.style.width = img.width + 'px';
        canvas.style.height = img.height + 'px';

        canvasCtx = canvas.getContext('2d');

        // 绘制所有检测框
        redrawBBoxes();
    }

    function redrawBBoxes() {
        if (!canvasCtx) return;

        canvasCtx.clearRect(0, 0, canvasCtx.canvas.width, canvasCtx.canvas.height);

        bboxesData.forEach((det, i) => {
            if (!det.bbox || det.bbox.length < 4) return;

            const [x1, y1, x2, y2] = det.bbox;
            const width = x2 - x1;
            const height = y2 - y1;

            const isSelected = i === selectedIndex;

            // 绘制矩形框
            canvasCtx.strokeStyle = isSelected ? '#ff0000' : '#00ff00';
            canvasCtx.lineWidth = isSelected ? 4 : 2;
            canvasCtx.strokeRect(x1, y1, width, height);

            // 绘制标签背景
            canvasCtx.fillStyle = isSelected ? '#ff0000' : '#00ff00';
            canvasCtx.fillRect(x1, y1 - 24, 60, 24);

            // 绘制标签文字
            canvasCtx.fillStyle = '#000000';
            canvasCtx.font = 'bold 14px Arial';
            canvasCtx.fillText(`${det.label} (${(det.confidence * 100).toFixed(0)}%)`, x1 + 4, y1 - 6);
        });
    }

    function highlightBBox(index) {
        // 更新表格行样式
        const rows = document.querySelectorAll('#resultTableBody tr');
        rows.forEach((row, i) => {
            if (i === index) {
                row.style.background = '#e6f7ff';
            } else {
                row.style.background = '';
            }
        });

        // 更新 Canvas 高亮
        selectedIndex = index;
        redrawBBoxes();
    }

    function closeModal() {
        document.getElementById('confirmModal').style.display = 'none';
    }

    // 图片预览功能
    function showImagePreview(src) {
        // 创建预览模态框
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.id = 'imagePreviewModal';
        modal.innerHTML = `
            <div class="modal-card center-dialog" style="width: auto; max-width: 90vw;">
                <div class="modal-header">
                    <span>检测结果图片</span>
                    <button class="modal-close" onclick="closeImagePreview()">&times;</button>
                </div>
                <div class="modal-body" style="display: flex; align-items: center; justify-content: center; background: #f5f5f5; padding: 20px;">
                    <div class="preview-image-wrapper" style="position: relative; display: inline-block;">
                        <img id="previewImage" src="${src}" style="max-width: 100%; max-height: 70vh; object-fit: contain; border-radius: 4px; display: block;">
                        <canvas id="previewCanvas" style="position: absolute; top: 0; left: 0; pointer-events: none;"></canvas>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        // 图片加载后绘制检测框
        const img = document.getElementById('previewImage');
        img.onload = () => {
            drawPreviewBBoxes(img);
        };

        // 点击背景关闭
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeImagePreview();
            }
        });
    }

    function drawPreviewBBoxes(img) {
        const canvas = document.getElementById('previewCanvas');
        if (!canvas || !bboxesData.length) return;

        // 设置 canvas 尺寸与图片显示尺寸一致
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        canvas.style.width = img.width + 'px';
        canvas.style.height = img.height + 'px';

        const ctx = canvas.getContext('2d');

        bboxesData.forEach((det, i) => {
            if (!det.bbox || det.bbox.length < 4) return;

            const [x1, y1, x2, y2] = det.bbox;
            const width = x2 - x1;
            const height = y2 - y1;

            const isSelected = i === selectedIndex;

            // 绘制矩形框
            ctx.strokeStyle = isSelected ? '#ff0000' : '#00ff00';
            ctx.lineWidth = isSelected ? 4 : 2;
            ctx.strokeRect(x1, y1, width, height);

            // 绘制标签背景
            ctx.fillStyle = isSelected ? '#ff0000' : '#00ff00';
            ctx.fillRect(x1, y1 - 24, 60, 24);

            // 绘制标签文字
            ctx.fillStyle = '#000000';
            ctx.font = 'bold 14px Arial';
            ctx.fillText(`${det.label} (${(det.confidence * 100).toFixed(0)}%)`, x1 + 4, y1 - 6);
        });
    }

    function closeImagePreview() {
        const modal = document.getElementById('imagePreviewModal');
        if (modal) {
            modal.remove();
        }
    }

    // --- 系统设置 ---
    let currentTab = 'stitch';
    let qualityStandardsData = {};

    // 质检标准相关
    async function loadQualityStandards() {
        console.log('loadQualityStandards called');
        try {
            const res = await fetch(`${API_BASE}/api/quality-standards`);
            const data = await res.json();
            console.log('Quality standards data:', data);
            if(data.status === 'success' && data.data.standards) {
                qualityStandardsData = data.data.standards;
                console.log('Loaded qualityStandardsData:', qualityStandardsData);
                renderQualityStandards();
            }
        } catch(e) {
            console.error('Failed to load quality standards', e);
        }
    }

    function renderQualityStandards() {
        const container = document.getElementById('qualityStandardsContainer');
        container.innerHTML = '';

        for (const [partType, standards] of Object.entries(qualityStandardsData)) {
            const partItem = document.createElement('div');
            partItem.className = 'part-type-item';
            partItem.innerHTML = `
                <div class="part-type-header">
                    <span class="part-type-name">${partType}</span>
                    <button class="btn-icon" onclick="deletePartType('${partType}')">&times;</button>
                </div>
                <div class="defect-standards-list" id="standards-${partType.replace(/\W/g, '_')}">
                    ${standards.map((std, idx) => `
                        <div class="defect-standard-item">
                            <input type="text" class="defect-type-input" value="${std.defectType || ''}" placeholder="缺陷类型" data-part="${partType}" data-idx="${idx}" onchange="updateStandard('${partType}', ${idx}, 'defectType', this.value)">
                            <select class="operator-select" onchange="updateStandard('${partType}', ${idx}, 'operator', this.value)">
                                <option value="==" ${std.operator === '==' ? 'selected' : ''}>==</option>
                                <option value="<=" ${std.operator === '<=' ? 'selected' : ''}>&lt;=</option>
                                <option value=">=" ${std.operator === '>=' ? 'selected' : ''}>&gt;=</option>
                                <option value="<" ${std.operator === '<' ? 'selected' : ''}>&lt;</option>
                                <option value=">" ${std.operator === '>' ? 'selected' : ''}>&gt;</option>
                            </select>
                            <input type="number" class="threshold-input" value="${std.threshold || 0}" placeholder="阈值" data-part="${partType}" data-idx="${idx}" onchange="updateStandard('${partType}', ${idx}, 'threshold', this.value)">
                            <button class="btn-icon" onclick="removeStandard('${partType}', ${idx})">&times;</button>
                        </div>
                    `).join('')}
                </div>
                <button class="btn-add" onclick="addStandard('${partType}')">+ 添加缺陷标准</button>
            `;
            container.appendChild(partItem);
        }
    }

    function updateStandard(partType, idx, field, value) {
        if (!qualityStandardsData[partType]) return;
        if (field === 'threshold') {
            qualityStandardsData[partType][idx][field] = parseInt(value) || 0;
        } else {
            qualityStandardsData[partType][idx][field] = value;
        }
    }

    function addStandard(partType) {
        if (!qualityStandardsData[partType]) {
            qualityStandardsData[partType] = [];
        }
        qualityStandardsData[partType].push({
            defectType: '',
            operator: '<=',
            threshold: 0
        });
        renderQualityStandards();
    }

    function removeStandard(partType, idx) {
        if (!qualityStandardsData[partType]) return;
        qualityStandardsData[partType].splice(idx, 1);
        renderQualityStandards();
    }

    function addPartType() {
        const partTypeName = prompt('请输入新的工件类型名称:');
        if (!partTypeName || partTypeName.trim() === '') return;
        const partType = partTypeName.trim();
        if (qualityStandardsData[partType]) {
            showToast('该工件类型已存在', 'warning');
            return;
        }
        qualityStandardsData[partType] = [
            { defectType: '', operator: '<=', threshold: 0 }
        ];
        renderQualityStandards();
    }

    function deletePartType(partType) {
        if (!confirm(`确定要删除工件类型 "${partType}" 的质检标准吗？`)) return;
        delete qualityStandardsData[partType];
        renderQualityStandards();
    }

    async function saveQualityStandards() {
        try {
            console.log('saveQualityStandards called, data:', qualityStandardsData);

            // 过滤掉空的缺陷类型
            for (const [partType, standards] of Object.entries(qualityStandardsData)) {
                // 过滤掉 defectType 为空的标准
                qualityStandardsData[partType] = standards.filter(s => s.defectType && s.defectType.trim() !== '');
            }

            // 移除没有标准工件类型
            for (const [partType, standards] of Object.entries(qualityStandardsData)) {
                if (!standards || standards.length === 0) {
                    delete qualityStandardsData[partType];
                }
            }

            console.log('Filtered qualityStandardsData:', qualityStandardsData);

            for (const [partType, standards] of Object.entries(qualityStandardsData)) {
                const res = await fetch(`${API_BASE}/api/quality-standards/part-types/${encodeURIComponent(partType)}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ standards: standards })
                });
                const data = await res.json();
                if (data.status !== 'success') {
                    showToast(`保存 ${partType} 失败: ${data.message}`, 'error');
                    return;
                }
            }
            // 保存成功后重新加载配置，确保前端数据与后端同步
            await loadQualityStandards();
            showToast('质检标准已保存');
        } catch(e) {
            console.error('Save error:', e);
            showToast('保存失败: ' + e.message, 'error');
        }
    }

    async function resetQualityStandards() {
        if (!confirm('确定要重置所有质检标准为默认值吗？')) return;
        try {
            const res = await fetch(`${API_BASE}/api/quality-standards/reset`, { method: 'POST' });
            const data = await res.json();
            if (data.status === 'success') {
                await loadQualityStandards();
                showToast('质检标准已重置');
            }
        } catch(e) { showToast('重置失败', 'error'); }
    }

    // 标签页切换
    function switchTab(tabName) {
        console.log('switchTab called with:', tabName);
        currentTab = tabName;
        console.log('currentTab is now:', currentTab);

        // 更新标签页头部样式
        document.querySelectorAll('.tab-option').forEach(el => {
            el.classList.toggle('active', el.dataset.tab === tabName);
        });

        // 更新内容显示
        document.querySelectorAll('.tab-content').forEach(el => {
            el.classList.remove('active');
        });
        document.getElementById(tabName + 'TabContent').classList.add('active');

        // 加载对应标签页的数据
        if (tabName === 'quality') {
            loadQualityStandards();
        }
    }

    // --- 拼接配置 ---
    async function updateStitchStatus() {
        try {
            const res = await fetch(`${API_BASE}/api/stitch/config`);
            const data = await res.json();
            if(data.status === 'success') {
                currentStrategy = data.data.currentStrategy;
                const strategyEl = document.getElementById('currentStrategy');

                strategyEl.textContent = currentStrategy.toUpperCase();
                document.getElementById('stitchStatus').classList.toggle('manual', currentStrategy === 'manual');
            }
        } catch(e) {}
    }

    async function openSystemConfigModal() {
        document.getElementById('systemConfigModal').style.display = 'block';
        isPreviewMode = true;

        // 重置为拼接设置标签页
        currentTab = 'stitch';
        switchTab('stitch');

        try {
            const res = await fetch(`${API_BASE}/api/stitch/strategy`);
            const data = await res.json();
            if(data.status === 'success') {
                currentStrategy = data.data.strategy;
                updateStrategyUI();
            }
        } catch(e) {}
    }

    function closeSystemConfigModal() {
        document.getElementById('systemConfigModal').style.display = 'none';
        isPreviewMode = false;
    }

    function selectStrategy(strategy) {
        currentStrategy = strategy;
        updateStrategyUI();
    }

    function updateStrategyUI() {
        document.querySelectorAll('.strategy-option').forEach(el => {
            el.classList.toggle('active', el.dataset.strategy === currentStrategy);
        });

        const manualSection = document.getElementById('manualConfigSection');
        if(currentStrategy === 'manual') {
            manualSection.style.display = 'block';
            loadManualConfigs();
        } else {
            manualSection.style.display = 'none';
        }
    }

    async function loadManualConfigs() {
        try {
            const res = await fetch(`${API_BASE}/api/stitch/manual`);
            const data = await res.json();
            if(data.status === 'success' && data.data.cameras) {
                renderCameraConfigs(data.data.cameras);
            }
        } catch(e) {}
    }

    function renderCameraConfigs(cameras) {
        const container = document.getElementById('cameraConfigsContainer');
        container.innerHTML = '';

        cameras.forEach(cam => {
            const config = manualConfigs[cam.index] || {
                offset: cam.offset || [0, 0],
                scale: cam.scale || 1.0,
                rotation: cam.rotation || 0,
                flip: cam.flip || [false, false],
                overlapWidth: cam.overlapWidth || 100
            };
            manualConfigs[cam.index] = config;

            const item = document.createElement('div');
            item.className = 'camera-config-item';
            item.innerHTML = `
                <div class="camera-title">摄像头 ${cam.index}</div>
                <div class="param-grid">
                    <div class="param-item">
                        <label>X 偏移</label>
                        <div class="range-wrapper">
                            <input type="range" min="-200" max="200" value="${config.offset[0]}"
                                oninput="updateParam(${cam.index}, 'offset', [parseInt(this.value), manualConfigs[${cam.index}].offset[1]]); updateRangeDisplay(this)">
                            <span class="range-value">${config.offset[0]}</span>
                        </div>
                    </div>
                    <div class="param-item">
                        <label>Y 偏移</label>
                        <div class="range-wrapper">
                            <input type="range" min="-200" max="200" value="${config.offset[1]}"
                                oninput="updateParam(${cam.index}, 'offset', [manualConfigs[${cam.index}].offset[0], parseInt(this.value)]); updateRangeDisplay(this)">
                            <span class="range-value">${config.offset[1]}</span>
                        </div>
                    </div>
                    <div class="param-item">
                        <label>缩放</label>
                        <div class="range-wrapper">
                            <input type="range" min="0.5" max="1.5" step="0.01" value="${config.scale}"
                                oninput="updateParam(${cam.index}, 'scale', parseFloat(this.value)); updateRangeDisplay(this)">
                            <span class="range-value">${config.scale.toFixed(2)}</span>
                        </div>
                    </div>
                    <div class="param-item">
                        <label>重叠宽度</label>
                        <div class="range-wrapper">
                            <input type="range" min="0" max="300" value="${config.overlapWidth}"
                                oninput="updateParam(${cam.index}, 'overlapWidth', parseInt(this.value)); updateRangeDisplay(this)">
                            <span class="range-value">${config.overlapWidth}</span>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(item);
        });
    }

    function updateRangeDisplay(input) {
        const display = input.nextElementSibling;
        const val = input.type === 'range' && input.step === '0.01' ? parseFloat(input.value).toFixed(2) : input.value;
        display.textContent = val;
    }

    function updateParam(cameraIndex, param, value) {
        if(!manualConfigs[cameraIndex]) {
            manualConfigs[cameraIndex] = {
                offset: [0, 0],
                scale: 1.0,
                rotation: 0,
                flip: [false, false],
                overlapWidth: 100
            };
        }
        manualConfigs[cameraIndex][param] = value;
    }

    async function saveStitchConfig() {
        try {
            const strategyRes = await fetch(`${API_BASE}/api/stitch/strategy`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ strategy: currentStrategy })
            });

            const strategyData = await strategyRes.json();
            if(strategyData.status !== 'success') {
                showToast(strategyData.message, 'error');
                return;
            }

            if(currentStrategy === 'manual') {
                const configs = Object.entries(manualConfigs).map(([index, config]) => ({
                    index: parseInt(index),
                    offset: config.offset.map(v => typeof v === 'number' ? v : parseInt(v)),
                    scale: config.scale,
                    rotation: config.rotation,
                    flip: config.flip,
                    overlapWidth: config.overlapWidth
                }));

                const res = await fetch(`${API_BASE}/api/stitch/manual/batch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cameras: configs })
                });

                const data = await res.json();
                if(data.status === 'success') {
                    showToast('拼接配置已保存');
                    updateStitchStatus();
                } else {
                    showToast(data.message, 'error');
                }
            } else {
                showToast('拼接策略已切换');
                updateStitchStatus();
            }
        } catch(e) {
            showToast('保存失败: ' + e.message, 'error');
        }
    }

    async function saveCurrentConfig() {
        console.log('saveCurrentConfig called, currentTab =', currentTab);
        if (currentTab === 'stitch') {
            console.log('Saving stitch config');
            await saveStitchConfig();
        } else if (currentTab === 'quality') {
            console.log('Saving quality standards');
            await saveQualityStandards();
        } else {
            console.warn('Unknown tab:', currentTab);
        }
    }

    async function resetManualConfig() {
        try {
            const res = await fetch(`${API_BASE}/api/stitch/manual/reset`, { method: 'POST' });
            const data = await res.json();
            if(data.status === 'success') {
                manualConfigs = {};
                loadManualConfigs();
                showToast('拼接配置已重置');
            }
        } catch(e) { showToast('重置失败', 'error'); }
    }

    async function resetCurrentConfig() {
        if (currentTab === 'stitch') {
            await resetManualConfig();
        } else if (currentTab === 'quality') {
            await resetQualityStandards();
        }
    }

    // 页面加载时更新拼接状态
    updateStitchStatus();

    // ESC 关闭模态框
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeModal();
            closeSystemConfigModal();
            closeImagePreview();
        }
    });
</script>
</body>
</html>
