<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EdgeVision Pro | æ™ºèƒ½è§†è§‰å·¥ä½œå°</title>
    <style>
        :root {
            --sidebar-bg: #001529;
            --sidebar-width: 220px;
            --primary-color: #1890ff;
            --bg-body: #f0f2f5;
            --header-height: 48px;
            --card-radius: 8px;
            --success-color: #52c41a;
            --warning-color: #faad14;
            --danger-color: #ff4d4f;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-body);
            height: 100vh;
            display: flex;
            overflow: hidden;
            color: #333;
        }

        aside {
            width: var(--sidebar-width);
            background: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
            color: rgba(255,255,255,0.65);
            z-index: 10;
            box-shadow: 2px 0 8px rgba(0,0,0,0.15);
        }

        .brand {
            height: 60px;
            display: flex;
            align-items: center;
            padding-left: 20px;
            font-size: 18px;
            font-weight: 700;
            color: white;
            letter-spacing: 1px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .brand span { color: var(--primary-color); }

        .menu { flex: 1; padding: 20px 10px; display: flex; flex-direction: column; gap: 12px; overflow-y: auto; }
        .menu-label { font-size: 12px; margin-bottom: 5px; padding-left: 10px; text-transform: uppercase; opacity: 0.5; }

        .ctrl-btn {
            background: rgba(255,255,255,0.08);
            border: none;
            color: white;
            padding: 12px 15px;
            border-radius: 6px;
            cursor: pointer;
            text-align: left;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }
        .ctrl-btn:hover:not(:disabled) { background: var(--primary-color); color: white; transform: translateX(5px); }
        .ctrl-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .ctrl-btn.stop:hover:not(:disabled) { background: #ff4d4f; }

        .stitch-status {
            background: rgba(255,255,255,0.05);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 12px;
        }
        .stitch-status .status-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .stitch-status .status-label { opacity: 0.7; }
        .stitch-status .status-value { color: var(--primary-color); font-weight: 600; }
        .stitch-status.manual .status-value { color: var(--warning-color); }

        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        header {
            height: var(--header-height);
            background: white;
            border-bottom: 1px solid #e8e8e8;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            font-size: 13px;
            color: #666;
            flex-shrink: 0;
        }

        .workspace {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow: hidden;
            min-height: 0;
        }

        /* å…¨æ™¯ Canvas ç›‘æ§åŒº (å‰ç«¯æ‹¼æ¥) */
        .panorama-section {
            background: black;
            border-radius: var(--card-radius);
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid #333;
            flex: 0 0 calc((100vh - var(--header-height) - 40px - 40px) * 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            max-height: 80vh;
        }

        .panorama-canvas {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }

        /* ç”»å¸ƒå®¹å™¨ - ç”¨äºä¿æŒå®½é«˜æ¯” */
        .panorama-canvas-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            position: relative;
        }

        .panorama-canvas-wrapper canvas {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .panorama-overlay {
            position: absolute; top: 15px; left: 15px;
            background: rgba(0,0,0,0.7); color: #fff;
            padding: 8px 15px; border-radius: 6px; font-size: 13px;
            display: flex; align-items: center; gap: 10px;
            backdrop-filter: blur(5px);
            z-index: 10;
        }
        .rec-dot { width: 10px; height: 10px; background: #52c41a; border-radius: 50%; box-shadow: 0 0 8px #52c41a; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .panorama-placeholder {
            color: #666; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .panorama-placeholder span { font-size: 28px; opacity: 0.4; }
        .panorama-placeholder p { font-size: 13px; margin-top: 10px; opacity: 0.3; }

        /* ç»“æœé¢æ¿ */
        .result-section {
            flex: 1;
            background: white;
            border-radius: var(--card-radius);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #e8e8e8;
            min-height: 0;
        }

        .panel-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            min-height: 0;
        }

        .panel-header {
            padding: 15px 24px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fafafa;
        }

        .btn-complete {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s;
        }
        .btn-complete:hover {
            background: #73d13d;
        }

        .panel-title {
            font-size: 16px;
            font-weight: 700;
            color: #333;
            border-left: 4px solid var(--primary-color);
            padding-left: 12px;
        }

        /* è´¨æ£€çŠ¶æ€æ ‡ç­¾ */
        .status-tag {
            font-size: 16px;
            font-weight: 700;
            padding: 8px 20px;
            border-radius: 24px;
            letter-spacing: 0.5px;
        }
        .status-tag.waiting {
            background: #f5f5f5;
            color: #999;
        }
        .status-tag.pass {
            background: linear-gradient(135deg, #52c41a 0%, #73d13d 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(82, 196, 26, 0.3);
        }
        .status-tag.fail {
            background: linear-gradient(135deg, #ff4d4f 0%, #ff7875 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(255, 77, 79, 0.3);
            animation: pulse-fail 1.5s infinite;
        }
        @keyframes pulse-fail {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* æ¨¡æ¿æ¯”å¯¹çŠ¶æ€æ ·å¼ */
        .status-pass {
            color: #52c41a;
            font-weight: 600;
        }
        .status-fail,
        .status-missing,
        .status-extra,
        .status-type-mismatch {
            color: #ff4d4f;
            font-weight: 600;
        }

        .result-view {
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }

        .result-image {
            flex: 0 0 auto;
            background: #f7f9fa;
            border-radius: 8px;
            padding: 10px;
            display: inline-block;
            max-width: 240px;
        }

        .result-image img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 4px;
            cursor: zoom-in;
            box-shadow: 0 2px 12px rgba(0,0,0,0.15);
            display: block;
        }

        .result-info {
            flex: 1;
            min-width: 0;
        }

        .batch-info-bar {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 15px;
        }
        .info-card {
            background: #f8faff;
            border: 1px solid #d6e4ff;
            padding: 10px 12px;
            border-radius: 6px;
        }
        .info-card label {
            display: block;
            font-size: 11px;
            color: #85a5ff;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .info-card .val {
            font-size: 14px;
            font-weight: 700;
            color: #003a8c;
        }

        /* ç»Ÿè®¡ä¿¡æ¯æ ·å¼ */
        .summary-stats {
            margin-bottom: 20px;
        }
        .summary-title {
            font-size: 13px;
            color: #999;
            font-weight: 500;
            margin-bottom: 12px;
        }
        .summary-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .summary-card {
            display: flex;
            align-items: baseline;
            gap: 6px;
            padding: 8px 14px;
            background: #f5f5f5;
            border-radius: 20px;
            border: 1px solid #e8e8e8;
        }
        .summary-type {
            font-size: 13px;
            color: #666;
        }
        .summary-count {
            font-size: 18px;
            font-weight: 700;
            color: #1890ff;
        }
        .no-defects {
            color: #52c41a;
            font-size: 14px;
            padding: 8px 14px;
            background: #f6ffed;
            border-radius: 20px;
            border: 1px solid #b7eb8f;
            display: inline-block;
        }

        .table-container { border: 1px solid #f0f0f0; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; padding: 10px 12px; color: #999; font-weight: 500; font-size: 11px; background: #fafafa; border-bottom: 1px solid #eee; }
        td { padding: 8px 12px; border-bottom: 1px solid #f5f5f5; }
        tr:hover td { background: #fff7e6; }
        tr[data-index] td { transition: background 0.2s; }

        .empty-state {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 40px; color: #999; font-size: 13px;
        }

        /* Modal - åº•éƒ¨æ»‘å…¥ï¼Œæ›´å®½æ›´ä½ï¼ˆæ‹¼æ¥è®¾ç½®ç”¨ï¼‰ */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-card.bottom-panel {
            background: white;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            max-height: 40vh;
            border-radius: 12px;
            box-shadow: 0 -5px 40px rgba(0,0,0,0.2);
            overflow: hidden;
            animation: slideInUp 0.3s;
            display: flex;
            flex-direction: column;
            width: 90%;
            max-width: 900px;
        }
        @keyframes slideInUp { from { transform: translate(-50%, 100%); } to { transform: translate(-50%, 0); } }

        /* æ£€æµ‹ç¡®è®¤æ¨¡æ€æ¡† - å±…ä¸­å¤§å°ºå¯¸ */
        .modal-card.center-dialog {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 500px;
            background: white;
            max-height: 90vh;
            border-radius: 8px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
            overflow: hidden;
            animation: fadeIn 0.3s;
            display: flex;
            flex-direction: column;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translate(-50%, -50%) scale(0.95); } to { opacity: 1; transform: translate(-50%, -50%) scale(1); } }

        .modal-header {
            padding: 16px 20px;
            background: #fbfbfb;
            border-bottom: 1px solid #eee;
            font-weight: 600;
            font-size: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .modal-close {
            background: none; border: none;
            font-size: 24px; cursor: pointer;
            color: #999; width: 30px; height: 30px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 4px;
        }
        .modal-close:hover { background: #f0f0f0; }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
            max-height: calc(40vh - 100px);
        }
        .modal-card.center-dialog .modal-body {
            max-height: none;
            overflow-y: visible;
        }
        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid #eee;
            background: #fbfbfb;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            flex-shrink: 0;
        }

        /* å°å±å¹•é€‚é… */
        @media (max-width: 768px) {
            .modal-card.bottom-panel {
                width: 95%;
                max-height: 60vh;
                bottom: 10px;
            }
            .modal-card.bottom-panel .modal-body {
                max-height: calc(60vh - 100px);
            }
            .modal-card.center-dialog {
                width: 90%;
            }
        }

        .form-item { margin-bottom: 15px; }
        .form-item label { display: block; font-size: 12px; color: #666; margin-bottom: 5px; }
        .form-item input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }

        /* æ‹¼æ¥é…ç½®æ ·å¼ */
        .strategy-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        .strategy-option {
            flex: 1;
            padding: 10px 8px;
            border: 2px solid #e8e8e8;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .strategy-option:hover { border-color: var(--primary-color); background: #f0f9ff; }
        .strategy-option.active {
            border-color: var(--primary-color);
            background: #e6f7ff;
        }
        .strategy-option .name { font-weight: 600; font-size: 13px; }
        .strategy-option .desc { font-size: 10px; color: #999; }

        .manual-config-section {
            background: #fffbf0;
            border: 1px solid #ffe58f;
            border-radius: 6px;
            padding: 14px;
            margin-bottom: 16px;
        }
        .manual-config-section .section-title {
            font-size: 13px;
            font-weight: 600;
            color: #d46b08;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .manual-config-section .section-title .live-indicator {
            width: 8px; height: 8px;
            background: #52c41a;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        .camera-config-item {
            background: white;
            border: 1px solid #e8e8e8;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
        }
        .camera-config-item .camera-title {
            font-weight: 600;
            font-size: 12px;
            color: #333;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f0f0f0;
        }

        .param-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }
        .param-item label {
            font-size: 11px;
            color: #555;
            margin-bottom: 6px;
            display: block;
            font-weight: 500;
        }
        .param-item input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e8e8e8;
            outline: none;
            -webkit-appearance: none;
        }
        .param-item input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
        }

        .range-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .range-wrapper input[type="range"] { flex: 1; }
        .range-wrapper .range-value {
            min-width: 45px;
            text-align: right;
            font-size: 12px;
            color: var(--primary-color);
            font-weight: 600;
            background: #e6f7ff;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .preview-note {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            border-radius: 6px;
            padding: 10px 12px;
            font-size: 12px;
            color: #0050b3;
            margin-bottom: 15px;
        }

        .btn {
            padding: 10px 18px; border: none; border-radius: 4px; cursor: pointer;
            font-size: 14px; font-weight: 500; transition: all 0.3s;
        }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-primary:hover { background: #40a9ff; }
        .btn-secondary { background: #f5f5f5; color: #666; }
        .btn-secondary:hover { background: #e8e8e8; }
        .btn-success { background: var(--success-color); color: white; }
        .btn-success:hover { background: #73d13d; }
        .btn-info { background: #1890ff; color: white; }
        .btn-info:hover { background: #40a9ff; }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 12px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 3000;
            display: none;
        }
        .toast.success { border-left: 4px solid var(--success-color); }
        .toast.error { border-left: 4px solid var(--danger-color); }
        .toast.warning { border-left: 4px solid var(--warning-color); }

        .hidden { display: none !important; }

        /* ç³»ç»Ÿè®¾ç½®æ ‡ç­¾é¡µæ ·å¼ */
        .tab-header {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            border-bottom: 1px solid #e8e8e8;
        }
        .tab-option {
            flex: 1;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 2px solid transparent;
            font-weight: 500;
            color: #666;
        }
        .tab-option:hover {
            color: var(--primary-color);
        }
        .tab-option.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* è´¨æ£€æ ‡å‡†é…ç½®æ ·å¼ */
        .quality-standards-section {
            background: #f0f9ff;
            border: 1px solid #91d5ff;
            border-radius: 6px;
            padding: 14px;
            margin-bottom: 16px;
        }
        .quality-standards-section .section-title {
            font-size: 13px;
            font-weight: 600;
            color: #0050b3;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .part-type-item {
            background: white;
            border: 1px solid #e8e8e8;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
        }
        .part-type-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f0f0f0;
        }
        .part-type-name {
            font-weight: 600;
            font-size: 13px;
            color: #333;
        }
        .defect-standard-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #fafafa;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        .defect-type-input {
            flex: 2;
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }
        .operator-select {
            flex: 1;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            background: white;
        }
        .threshold-input {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            width: 60px;
        }
        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #999;
            padding: 4px 8px;
            border-radius: 4px;
        }
        .btn-icon:hover {
            color: #ff4d4f;
            background: #fff1f0;
        }
        .btn-add {
            font-size: 12px;
            padding: 6px 12px;
            background: #e6f7ff;
            color: #1890ff;
            border: 1px dashed #1890ff;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
        }
        .btn-add:hover {
            background: #bae7ff;
        }
    </style>
</head>
<body>

<aside>
    <div class="brand">
        EDGE<span>VISION</span>
    </div>

    <div class="menu">
        <div class="menu-label">Device Control</div>
        <button class="ctrl-btn" onclick="startCamera()" id="startBtn">
            â–¶ å¯åŠ¨ç›‘æ§
        </button>
        <button class="ctrl-btn stop" onclick="stopCamera()" id="stopBtn" disabled>
            â¹ åœæ­¢ç›‘æ§
        </button>

        <div class="stitch-status" id="stitchStatus">
            <div class="status-row">
                <span class="status-label">æ‹¼æ¥ç­–ç•¥:</span>
                <span class="status-value" id="currentStrategy">-</span>
            </div>
        </div>

        <div class="menu-label" style="margin-top: 20px;">Inspection</div>
        <button class="ctrl-btn" onclick="startPreCheck()" id="inspectBtn" disabled>
            â— å¼€å§‹æ£€æµ‹
        </button>
    </div>

    <div style="padding: 20px; margin-top: auto;">
        <button class="ctrl-btn" onclick="openSystemConfigModal()" id="systemConfigBtn" style="width: 100%; opacity: 0.5;">
            âš™ ç³»ç»Ÿè®¾ç½®
        </button>
    </div>
</aside>

<main>
    <header>
        <div><b>å·¥ä½œå°</b> / å®æ—¶ç›‘æ§ä¸åˆ†æ</div>
        <div id="clock">00:00:00</div>
    </header>

    <div class="workspace">
        <!-- å…¨æ™¯ Canvas ç›‘æ§åŒº (å‰ç«¯æ‹¼æ¥) -->
        <div class="panorama-section">
            <div class="panorama-placeholder" id="panoramaPlaceholder">
                <span>OFFLINE</span>
                <p>ç‚¹å‡»å·¦ä¾§"å¯åŠ¨ç›‘æ§"æŸ¥çœ‹æ‹¼æ¥ç”»é¢</p>
            </div>
            <div class="panorama-canvas-wrapper" id="panoramaWrapper" style="display: none;">
                <canvas id="panoramaCanvas" class="panorama-canvas"></canvas>
            </div>
            <div class="panorama-overlay" id="panoramaOverlay" style="display: none;">
                <div class="rec-dot"></div>
                <span>å®æ—¶ç”»é¢</span>
            </div>
        </div>

        <!-- æ£€æµ‹ç»“æœåŒº -->
        <div class="result-section">
            <div class="panel-header">
                <div class="panel-title">æ£€æµ‹ç»“æœåˆ†æ</div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div id="status-tag" class="status-tag waiting">ç­‰å¾…æ£€æµ‹</div>
                    <button id="completeBtn" class="btn-complete" style="display: none;" onclick="clearResults()">æ£€æŸ¥å®Œæˆ</button>
                </div>
            </div>
            <div class="panel-body" id="result-panel-body">
                <div class="empty-state">
                    <p>æš‚æ— æ£€æµ‹æ•°æ®ï¼Œè¯·ç‚¹å‡»å·¦ä¾§ "å¼€å§‹æ£€æµ‹"</p>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- æ£€æµ‹ç¡®è®¤æ¨¡æ€æ¡† -->
<div id="confirmModal" class="modal">
    <div class="modal-card center-dialog">
        <div class="modal-header">
            <span>æ£€æµ‹å‚æ•°ç¡®è®¤</span>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <img id="preview-image" style="width: 100%; height: 180px; object-fit: contain; background: #333; border-radius: 4px; margin-bottom: 20px;" src="">
            <div class="form-item">
                <label>å·¥ä»¶åç§°</label>
                <input type="text" id="part-name" style="padding: 12px; font-size: 14px;">
            </div>
            <div class="form-item">
                <label>ç”Ÿäº§æ‰¹æ¬¡</label>
                <input type="text" id="batch-id" style="padding: 12px; font-size: 14px;">
            </div>
            <div class="form-item">
                <label>æ“ä½œå‘˜</label>
                <input type="text" id="operator" value="Admin" style="padding: 12px; font-size: 14px;">
            </div>
            <div class="form-item">
                <label>æ•°æ®é‡‡é›†ç›®å½•</label>
                <input type="text" id="save-dir" placeholder="ä¾‹å¦‚: data/collected/EKS" style="padding: 12px; font-size: 14px;">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="btn btn-info" onclick="collectData()">æ•°æ®é‡‡é›†</button>
            <button class="btn btn-primary" onclick="confirmInspection()">å¼€å§‹åˆ†æ</button>
        </div>
    </div>
</div>

<!-- ç³»ç»Ÿè®¾ç½®æ¨¡æ€æ¡† -->
<div id="systemConfigModal" class="modal">
    <div class="modal-card bottom-panel">
        <div class="modal-header">
            <span>ç³»ç»Ÿè®¾ç½®</span>
            <button class="modal-close" onclick="closeSystemConfigModal()">&times;</button>
        </div>
        <div class="modal-body">
            <!-- æ ‡ç­¾é¡µå¤´éƒ¨ -->
            <div class="tab-header">
                <div class="tab-option active" data-tab="stitch" onclick="switchTab('stitch')">æ‹¼æ¥è®¾ç½®</div>
                <div class="tab-option" data-tab="template" onclick="switchTab('template')">æ¨¡æ¿ç®¡ç†</div>
            </div>

            <!-- æ‹¼æ¥è®¾ç½®æ ‡ç­¾å†…å®¹ -->
            <div class="tab-content active" id="stitchTabContent">
                <div class="manual-config-section" id="manualConfigSection" style="display: block;">
                    <div class="section-title">
                        <div class="live-indicator"></div>
                        æ‘„åƒå¤´æ‹¼æ¥å‚æ•°
                    </div>

                    <div class="preview-note">
                        æ‹–åŠ¨æ»‘å—å®æ—¶é¢„è§ˆæ‹¼æ¥æ•ˆæœï¼Œæ»¡æ„åç‚¹å‡»ä¿å­˜
                    </div>

                    <!-- å‚æ•°è¯´æ˜å›¾ç¤º -->
                    <div style="background: #f5f7fa; border-radius: 6px; padding: 12px; margin-bottom: 15px; border: 1px solid #e1e4e8;">
                        <div style="font-size: 12px; color: #333; margin-bottom: 10px; font-weight: 600;">ğŸ“Œ æ‹¼æ¥åŸç†ï¼ˆæ¯ä¸ªæ‘„åƒå¤´åªä¿ç•™ä¸€éƒ¨åˆ†ï¼‰ï¼š</div>

                        <!-- ä¸¤æ‘„åƒå¤´ç¤ºä¾‹ -->
                        <div style="margin-bottom: 12px;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 6px;">ä¸¤ä¸ªæ‘„åƒå¤´æ—¶ï¼š</div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <div style="flex: 1;">
                                    <div style="background: linear-gradient(90deg, #4CAF50 0%, #4CAF50 65%, #ddd 65%, #ddd 100%); height: 35px; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; font-weight: bold;">
                                        æ‘„åƒå¤´0
                                    </div>
                                    <div style="text-align: center; margin-top: 4px; font-size: 10px; color: #666;">
                                        ä¿ç•™ 0 åˆ° stitchX<br><span style="color: #4CAF50;">stitchX: 225</span>
                                    </div>
                                </div>
                                <div style="font-size: 14px; color: #999;">â•</div>
                                <div style="flex: 1;">
                                    <div style="background: linear-gradient(90deg, #ddd 0%, #ddd 25%, #2196F3 25%, #2196F3 100%); height: 35px; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; font-weight: bold;">
                                        æ‘„åƒå¤´1
                                    </div>
                                    <div style="text-align: center; margin-top: 4px; font-size: 10px; color: #666;">
                                        ä¿ç•™ stitchX åˆ°æœ«å°¾<br><span style="color: #2196F3;">stitchX: 75</span>
                                    </div>
                                </div>
                                <div style="font-size: 14px; color: #999;">=</div>
                                <div style="flex: 1.5;">
                                    <div style="background: linear-gradient(90deg, #4CAF50 0%, #4CAF50 50%, #2196F3 50%, #2196F3 100%); height: 35px; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; font-weight: bold;">
                                        æ‹¼æ¥ç»“æœ
                                    </div>
                                    <div style="text-align: center; margin-top: 4px; font-size: 10px; color: #666;">æ— é‡å æ‹¼æ¥</div>
                                </div>
                            </div>
                        </div>

                        <!-- ä¸‰æ‘„åƒå¤´ç¤ºä¾‹ -->
                        <div>
                            <div style="font-size: 11px; color: #666; margin-bottom: 6px;">ä¸‰ä¸ªæ‘„åƒå¤´æ—¶ï¼š</div>
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <div style="flex: 1;">
                                    <div style="background: linear-gradient(90deg, #FF9800 0%, #FF9800 60%, #ddd 60%, #ddd 100%); height: 30px; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: white; font-size: 9px; font-weight: bold;">
                                        æ‘„åƒå¤´0
                                    </div>
                                    <div style="text-align: center; margin-top: 3px; font-size: 9px; color: #666;">
                                        stitchX: 700
                                    </div>
                                </div>
                                <div style="font-size: 12px; color: #999;">+</div>
                                <div style="flex: 1;">
                                    <div style="background: linear-gradient(90deg, #ddd 0%, #ddd 20%, #4CAF50 20%, #4CAF50 80%, #ddd 80%, #ddd 100%); height: 30px; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: white; font-size: 9px; font-weight: bold;">
                                        æ‘„åƒå¤´1
                                    </div>
                                    <div style="text-align: center; margin-top: 3px; font-size: 9px; color: #666;">
                                        ä¸¤è¾¹éƒ½åˆ‡<br>stitchX: 256
                                    </div>
                                </div>
                                <div style="font-size: 12px; color: #999;">+</div>
                                <div style="flex: 1;">
                                    <div style="background: linear-gradient(90deg, #ddd 0%, #ddd 25%, #2196F3 25%, #2196F3 100%); height: 30px; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: white; font-size: 9px; font-weight: bold;">
                                        æ‘„åƒå¤´2
                                    </div>
                                    <div style="text-align: center; margin-top: 3px; font-size: 9px; color: #666;">
                                        stitchX: 320
                                    </div>
                                </div>
                                <div style="font-size: 12px; color: #999;">=</div>
                                <div style="flex: 1.2;">
                                    <div style="background: linear-gradient(90deg, #FF9800 0%, #FF9800 33%, #4CAF50 33%, #4CAF50 66%, #2196F3 66%, #2196F3 100%); height: 30px; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: white; font-size: 9px; font-weight: bold;">
                                        ä¸‰æ®µæ‹¼æ¥
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: 12px; padding: 8px; background: #fff3cd; border-radius: 4px; font-size: 10px; color: #856404;">
                            ğŸ’¡ <strong>æ ¸å¿ƒæ¦‚å¿µï¼š</strong>æ¯ä¸ªæ‘„åƒå¤´è¾“å…¥çš„æ˜¯å®Œæ•´ç”»é¢ï¼Œä½†åªä¿ç•™ <code style="background: #fff; padding: 1px 4px; border-radius: 3px;">stitchX</code> æŒ‡å®šçš„é‚£ä¸€éƒ¨åˆ†ã€‚<br>
                            â€¢ <strong>è¾¹ç¼˜æ‘„åƒå¤´</strong>ï¼ˆ0å’Œæœ€åä¸€ä¸ªï¼‰ï¼šåªåˆ‡ä¸€è¾¹ï¼Œä¿ç•™å¤§éƒ¨åˆ†<br>
                            â€¢ <strong>ä¸­é—´æ‘„åƒå¤´</strong>ï¼šä¸¤è¾¹éƒ½åˆ‡ï¼Œåªä¿ç•™ä¸­é—´é‡å åŒºåŸŸ
                        </div>
                    </div>

                    <div id="cameraConfigsContainer">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- æ¨¡æ¿ç®¡ç†æ ‡ç­¾å†…å®¹ -->
            <div class="tab-content" id="templateTabContent">
                <div class="quality-standards-section">
                    <div class="section-title">
                        <span>æ¨¡æ¿ç®¡ç†</span>
                        <button class="btn btn-success" style="font-size: 11px; padding: 4px 10px;" onclick="showOneClickBuildModal()">âš¡ ä¸€é”®å»ºæ¨¡ï¼ˆæ ‡å‡†ï¼‰</button>
                        <button class="btn btn-primary" style="font-size: 11px; padding: 4px 10px;" onclick="showCropAreaBuildModal()">âœ‚ï¸ ä¸€é”®å»ºæ¨¡ï¼ˆè£å‰ªåŒºåŸŸï¼‰</button>
                    </div>

                    <div class="preview-note" style="margin-bottom: 12px;">
                        æˆªå–å½“å‰ç”»é¢ï¼ŒAI è‡ªåŠ¨è¯†åˆ«ç‰¹å¾å¹¶ç”Ÿæˆæ¨¡æ¿
                    </div>

                    <div id="templatesContainer">
                        <!-- åŠ¨æ€ç”Ÿæˆæ¨¡æ¿åˆ—è¡¨ -->
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeSystemConfigModal()">å–æ¶ˆ</button>
            <button class="btn btn-secondary" onclick="resetCurrentConfig()">é‡ç½®</button>
            <button class="btn btn-success" onclick="saveCurrentConfig()">ä¿å­˜é…ç½®</button>
        </div>
    </div>
</div>

<!-- Toast æç¤º -->
<div id="toast" class="toast"></div>

<script>
    const API_BASE = '';
    let requestId = null;
    let inspectionStartTime = null; // æ£€æµ‹å¼€å§‹æ—¶é—´

    // æ‹¼æ¥é…ç½®ç›¸å…³
    let currentStrategy = 'manual';  // å›ºå®šä½¿ç”¨ manual æ¨¡å¼
    let manualConfigs = {};
    let cameraCount = 2;
    let isPreviewMode = false;

    // Canvas æ‹¼æ¥ç›¸å…³
    let panoramaCanvas = null;
    let panoramaCtx = null;
    let offscreenCanvas = null; // ç¦»å± Canvas ç”¨äºåŒç¼“å†²
    let offscreenCtx = null;
    let cameraStreams = []; // éšè—çš„ img å…ƒç´ ç”¨äºåŠ è½½ MJPEG æµ
    let animationId = null;
    let lastFetchTime = 0;
    let lastCanvasWidth = 0;
    let lastCanvasHeight = 0;

    setInterval(() => {
        document.getElementById('clock').innerText = new Date().toLocaleTimeString();
    }, 1000);

    function showToast(message, type = 'success', duration = 3000) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = `toast ${type}`;
        toast.style.display = 'block';
        setTimeout(() => { toast.style.display = 'none'; }, duration);
    }

    // --- æ‘„åƒå¤´æ§åˆ¶ ---
    async function startCamera() {
        try {
            const res = await fetch(`${API_BASE}/api/camera/start`, { method: 'POST' });
            const data = await res.json();
            if (data.status === 'success') {
                cameraCount = data.cameraCount;

                // å¦‚æœæ‘„åƒå¤´æ•°é‡å¤§äº1ï¼ŒåŠ è½½æ‹¼æ¥é…ç½®
                if (cameraCount > 1) {
                    await loadManualConfigs();
                }

                toggleState(true);
                initPanoramaCanvas();
                updateStitchStatus();
                startCanvasStitch();
                showToast('æ‘„åƒå¤´å¯åŠ¨æˆåŠŸ');
            }
        } catch(e) { alert('å¯åŠ¨å¤±è´¥: ' + e.message); }
    }

    function initPanoramaCanvas() {
        panoramaCanvas = document.getElementById('panoramaCanvas');
        panoramaCtx = panoramaCanvas.getContext('2d', { alpha: false }); // ä¼˜åŒ–ï¼šå…³é—­é€æ˜é€šé“

        // åˆ›å»ºç¦»å± Canvas ç”¨äºåŒç¼“å†²
        offscreenCanvas = document.createElement('canvas');
        offscreenCtx = offscreenCanvas.getContext('2d', { alpha: false });

        document.getElementById('panoramaPlaceholder').style.display = 'none';
        document.getElementById('panoramaWrapper').style.display = 'flex';
        document.getElementById('panoramaOverlay').style.display = 'flex';

        // åˆ›å»ºéšè—çš„ img å…ƒç´ åŠ è½½ MJPEG æµ
        const hiddenContainer = document.createElement('div');
        hiddenContainer.style.position = 'absolute';
        hiddenContainer.style.visibility = 'hidden';
        hiddenContainer.style.width = '0';
        hiddenContainer.style.height = '0';
        hiddenContainer.style.overflow = 'hidden';

        for (let i = 0; i < cameraCount; i++) {
            const img = document.createElement('img');
            img.crossOrigin = 'anonymous'; // å…è®¸è·¨åŸŸ
            img.src = `${API_BASE}/api/camera/stream/${i}?t=${Date.now()}`;
            hiddenContainer.appendChild(img);
            cameraStreams.push(img);
        }

        document.body.appendChild(hiddenContainer);

        lastCanvasWidth = 0;
        lastCanvasHeight = 0;
    }

    // Canvas æ‹¼æ¥ä¸»å¾ªç¯
    async function startCanvasStitch() {
        const fetchInterval = 50; // çº¦ 20fpsï¼Œé¿å…è¿‡äºé¢‘ç¹

        async function stitchLoop() {
            if (!document.getElementById('stopBtn').disabled) {
                const now = Date.now();
                if (now - lastFetchTime >= fetchInterval) {
                    stitchFromStreams();
                    lastFetchTime = now;
                }
            }
            animationId = requestAnimationFrame(stitchLoop);
        }

        // ç­‰å¾…å›¾ç‰‡åŠ è½½å®Œæˆåå†å¼€å§‹å¾ªç¯
        setTimeout(() => {
            stitchLoop();
        }, 1000);
    }

    // ä» MJPEG æµæˆªå–ç”»é¢å¹¶æ‹¼æ¥
    function stitchFromStreams() {
        // æ£€æŸ¥æ‰€æœ‰æµæ˜¯å¦å·²åŠ è½½
        const loadedImages = cameraStreams.filter(img => img.complete && img.naturalWidth > 0);

        if (loadedImages.length === cameraCount) {
            stitchImagesOnCanvas(loadedImages);
        }
    }

    function stitchImagesOnCanvas(images) {
        if (!offscreenCtx || images.length === 0) return;

        const totalCameras = images.length;

        // åªæœ‰1ä¸ªæ‘„åƒå¤´æ—¶ï¼Œç›´æ¥æ˜¾ç¤ºåŸå›¾ï¼Œä¸è¿›è¡Œæ‹¼æ¥
        if (totalCameras === 1) {
            const img = images[0];
            const canvasWidth = img.naturalWidth;
            const canvasHeight = img.naturalHeight;

            if (canvasWidth !== lastCanvasWidth || canvasHeight !== lastCanvasHeight) {
                offscreenCanvas.width = canvasWidth;
                offscreenCanvas.height = canvasHeight;
                panoramaCanvas.width = canvasWidth;
                panoramaCanvas.height = canvasHeight;
                lastCanvasWidth = canvasWidth;
                lastCanvasHeight = canvasHeight;
            }

            offscreenCtx.fillStyle = '#000';
            offscreenCtx.fillRect(0, 0, canvasWidth, canvasHeight);
            offscreenCtx.drawImage(img, 0, 0);
            // å¤åˆ¶åˆ°ä¸» Canvas æ˜¾ç¤º
            panoramaCtx.drawImage(offscreenCanvas, 0, 0);
            return;
        }

        // é˜¶æ®µä¸€ï¼šè®¡ç®—ç»Ÿä¸€çš„ç›®æ ‡é«˜åº¦ï¼ˆå–æ‰€æœ‰æ‘„åƒå¤´çš„æœ€å° h å€¼ï¼‰
        let targetHeight = Infinity;
        const configs = [];

        images.forEach((img, index) => {
            const config = manualConfigs[index] || {
                x1: 0,
                x2: img.naturalWidth,
                y: 0,
                h: img.naturalHeight
            };
            configs.push(config);
            if (config.h > 0 && config.h < targetHeight) {
                targetHeight = config.h;
            }
        });

        if (targetHeight === Infinity) {
            targetHeight = images[0].naturalHeight;
        }

        // é˜¶æ®µäºŒï¼šè®¡ç®—åˆ‡ç‰‡åçš„ç”»å¸ƒå°ºå¯¸
        let totalWidth = 0;

        images.forEach((img, index) => {
            const config = configs[index];
            // æ¯ä¸ªæ‘„åƒå¤´ä¿ç•™ [x1, x2) åˆ—
            const sliceWidth = config.x2 - config.x1;
            totalWidth += sliceWidth;
        });

        const canvasWidth = totalWidth;
        const canvasHeight = targetHeight;

        // åªæœ‰å°ºå¯¸çœŸæ­£å˜åŒ–æ—¶æ‰è°ƒæ•´ Canvasï¼ˆé¿å…é¢‘ç¹é‡ç½®ï¼‰
        if (canvasWidth !== lastCanvasWidth || canvasHeight !== lastCanvasHeight) {
            offscreenCanvas.width = canvasWidth;
            offscreenCanvas.height = canvasHeight;
            panoramaCanvas.width = canvasWidth;
            panoramaCanvas.height = canvasHeight;
            lastCanvasWidth = canvasWidth;
            lastCanvasHeight = canvasHeight;
        }

        // åœ¨ç¦»å± Canvas ä¸Šç»˜åˆ¶èƒŒæ™¯
        offscreenCtx.fillStyle = '#000';
        offscreenCtx.fillRect(0, 0, canvasWidth, canvasHeight);

        // é˜¶æ®µä¸‰ï¼šç»˜åˆ¶å›¾åƒï¼ˆæ‰€æœ‰å›¾åƒä½¿ç”¨ç›¸åŒçš„ç›®æ ‡é«˜åº¦ï¼‰
        let offsetX = 0;

        images.forEach((img, index) => {
            const config = configs[index];

            // æ¯ä¸ªæ‘„åƒå¤´ä¿ç•™ [x1, x2) åˆ—ï¼Œ[y, y+h) è¡Œ
            const srcX = config.x1;
            const srcY = config.y;
            const srcWidth = config.x2 - config.x1;
            // ä½¿ç”¨ç›®æ ‡é«˜åº¦ï¼Œä½†ç¡®ä¿ä¸è¶…è¿‡å›¾åƒè¾¹ç•Œ
            const srcHeight = Math.min(targetHeight, img.naturalHeight - config.y);

            // ç»˜åˆ¶åˆ°ç¦»å± Canvasï¼ˆä½¿ç”¨åˆ‡ç‰‡å’Œç»Ÿä¸€çš„é«˜åº¦ï¼‰
            try {
                offscreenCtx.drawImage(img, srcX, srcY, srcWidth, srcHeight, offsetX, 0, srcWidth, targetHeight);
                if (index !== totalCameras - 1) {
                    offsetX += srcWidth;
                }
            } catch(e) {
                console.error('Failed to draw image for camera', index, e);
            }
        });

        // ä¸€æ¬¡æ€§å°†ç¦»å± Canvas å¤åˆ¶åˆ°ä¸» Canvasï¼ˆé¿å…é—ªçƒï¼‰
        panoramaCtx.drawImage(offscreenCanvas, 0, 0);
    }

    async function stopCamera() {
        try {
            await fetch(`${API_BASE}/api/camera/stop`, { method: 'POST' });
            toggleState(false);

            // åœæ­¢ Canvas å¾ªç¯
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }

            // æ¸…ç†éšè—çš„æµå®¹å™¨
            cameraStreams.forEach(img => {
                img.src = '';
            });
            cameraStreams = [];

            // é‡ç½®æ˜¾ç¤º
            document.getElementById('panoramaPlaceholder').style.display = 'flex';
            document.getElementById('panoramaWrapper').style.display = 'none';
            document.getElementById('panoramaOverlay').style.display = 'none';

            showToast('æ‘„åƒå¤´å·²åœæ­¢', 'warning');
        } catch(e) {}
    }

    function toggleState(isOn) {
        document.getElementById('startBtn').disabled = isOn;
        document.getElementById('stopBtn').disabled = !isOn;
        document.getElementById('inspectBtn').disabled = !isOn;
    }

    // --- æ£€æµ‹é€»è¾‘ ---
    async function startPreCheck() {
        try {
            const res = await fetch(`${API_BASE}/api/inspect/pre-check`, { method: 'POST' });
            const data = await res.json();
            if(data.status === 'success') {
                requestId = data.data.requestId;
                document.getElementById('preview-image').src = data.data.preview_image;
                if(data.data.suggested_type) document.getElementById('part-name').value = data.data.suggested_type;
                document.getElementById('confirmModal').style.display = 'block';
            }
        } catch(e) {}
    }

    async function confirmInspection() {
        const part = document.getElementById('part-name').value;
        const batch = document.getElementById('batch-id').value;
        const op = document.getElementById('operator').value;
        if(!part || !batch) return showToast('è¯·å®Œå–„ä¿¡æ¯', 'error');

        closeModal();

        // è®°å½•æ£€æµ‹å¼€å§‹æ—¶é—´ï¼ˆå‘èµ·è¯·æ±‚å‰ï¼‰
        inspectionStartTime = new Date();

        try {
            const res = await fetch(`${API_BASE}/api/inspect/confirm`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ request_id: requestId, confirmed_part_name: part, batch_id: batch, operator: op })
            });
            const data = await res.json();
            if(data.status === 'success') showResults(data.data);
            else showToast(data.message, 'error');
        } catch(e) { showToast(e.message, 'error'); }
    }

    // æ•°æ®é‡‡é›†åŠŸèƒ½
    async function collectData() {
        const part = document.getElementById('part-name').value;
        const batch = document.getElementById('batch-id').value;
        const op = document.getElementById('operator').value;
        const saveDir = document.getElementById('save-dir').value;

        if(!part) {
            showToast('è¯·è¾“å…¥å·¥ä»¶åç§°', 'error');
            return;
        }

        // ä¸å…³é—­æ¨¡æ€æ¡†ï¼Œæ–¹ä¾¿è¿ç»­é‡‡é›†

        showToast('æ­£åœ¨æ‰§è¡Œæ•°æ®é‡‡é›†...', 'info');

        try {
            const res = await fetch(`${API_BASE}/api/inspect/collect-data`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    confirmed_part_name: part,
                    batch_id: batch || '',
                    operator: op || 'Admin',
                    save_dir: saveDir || ''
                })
            });
            const data = await res.json();

            if(data.status === 'success') {
                if(data.collected) {
                    // æ£€æµ‹å¤±è´¥ï¼Œæ•°æ®å·²é‡‡é›†
                    showToast(`âœ“ é‡‡é›†æˆåŠŸï¼ä¿å­˜ ${data.labelCount} ä¸ªæ ‡ç­¾`, 'success', 1500);
                } else {
                    // æ£€æµ‹æˆåŠŸï¼Œæ— éœ€é‡‡é›†
                    showToast('æ£€æµ‹æˆåŠŸï¼Œè·³è¿‡é‡‡é›†', 'info', 1500);
                }
            } else {
                showToast('é‡‡é›†å¤±è´¥: ' + data.message, 'error');
            }
        } catch(e) {
            showToast('é‡‡é›†å¤±è´¥: ' + e.message, 'error');
        }
    }

    function showResults(data) {
        const panelBody = document.getElementById('result-panel-body');

        // è®¡ç®—æ¯ç§ç±»å‹çš„ç»Ÿè®¡æ•°é‡
        const typeCounts = {};
        const details = data.analysis.details || [];
        details.forEach(det => {
            typeCounts[det.label] = (typeCounts[det.label] || 0) + 1;
        });

        // è®¡ç®—æ£€æŸ¥æ—¶é—´å’Œè€—è´¹æ—¶é—´
        const inspectionEndTime = new Date();
        const checkTime = inspectionEndTime.toLocaleTimeString('zh-CN', { hour12: false });
        let duration = '-';
        if (inspectionStartTime) {
            const durationMs = inspectionEndTime - inspectionStartTime;
            const seconds = (durationMs / 1000).toFixed(2);
            duration = `${seconds} ç§’`;
        }

        panelBody.innerHTML = `
            <div class="result-view">
                <div class="result-image">
                    <div class="image-wrapper" style="position: relative; display: inline-block;">
                        <img id="resultImage" src="${data.result_image}" onclick="showImagePreview(this.src)" style="cursor: pointer;" title="ç‚¹å‡»æ”¾å¤§æŸ¥çœ‹">
                        <canvas id="bboxCanvas" style="position: absolute; top: 0; left: 0; pointer-events: none;"></canvas>
                    </div>
                </div>
                <div class="result-info">
                    <div class="batch-info-bar">
                        <div class="info-card">
                            <label>å·¥ä»¶åç§°</label>
                            <div class="val">${data.batch_info.part_name}</div>
                        </div>
                        <div class="info-card">
                            <label>æ‰¹æ¬¡å·</label>
                            <div class="val">${data.batch_info.batch_id}</div>
                        </div>
                        <div class="info-card">
                            <label>æ“ä½œå‘˜</label>
                            <div class="val">${data.batch_info.operator}</div>
                        </div>
                    </div>

                    <!-- æ£€æŸ¥æ—¶é—´å’Œè€—è´¹æ—¶é—´ -->
                    <div class="batch-info-bar">
                        <div class="info-card" style="background: #fffbe6; border-color: #ffe58f;">
                            <label style="color: #d48806;">æ£€æŸ¥æ—¶é—´</label>
                            <div class="val" style="color: #d46b08;">${checkTime}</div>
                        </div>
                        <div class="info-card" style="background: #fffbe6; border-color: #ffe58f;">
                            <label style="color: #d48806;">è€—è´¹æ—¶é—´</label>
                            <div class="val" style="color: #d46b08;">${duration}</div>
                        </div>
                    </div>

                    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                    <div class="summary-stats">
                        <div class="summary-title">ç±»å‹ç»Ÿè®¡</div>
                        <div class="summary-cards">
                            ${Object.entries(typeCounts).map(([type, count]) => `
                                <div class="summary-card">
                                    <div class="summary-type">${type}</div>
                                    <div class="summary-count">${count}</div>
                                </div>
                            `).join('')}
                            ${Object.keys(typeCounts).length === 0 ? '<div class="no-defects">æ— ç¼ºé™·æ£€å‡º</div>' : ''}
                        </div>
                    </div>

                    <!-- æ¨¡æ¿æ¯”å¯¹ç»“æœè¡¨æ ¼ -->
                    ${data.analysis.templateComparisons && data.analysis.templateComparisons.length > 0 ? `
                        <div class="table-container">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                                <div class="summary-title">æ¨¡æ¿æ¯”å¯¹ç»“æœ</div>
                                <div style="font-size: 12px; color: #666;">
                                    æ€»è®¡: ${data.analysis.templateComparisons.length} ä¸ªç‰¹å¾
                                </div>
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>çŠ¶æ€</th>
                                        <th>ç±»å‹</th>
                                        <th>æ¨¡æ¿ä½ç½®</th>
                                        <th>æ£€æµ‹ä½ç½®</th>
                                        <th>Xåå·®</th>
                                        <th>Yåå·®</th>
                                        <th>æ€»åå·®</th>
                                        <th>å®¹å·®</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.analysis.templateComparisons.map((comp, i) => {
                                        const statusClass = comp.withinTolerance ? 'status-pass' :
                                            comp.status === 'MISSING' ? 'status-missing' :
                                            comp.status === 'EXTRA' ? 'status-extra' :
                                            comp.status === 'TYPE_MISMATCH' ? 'status-type-mismatch' : 'status-fail';
                                        const statusText = comp.withinTolerance ? 'åˆæ ¼' :
                                            comp.status === 'MISSING' ? 'æ¼æ£€' :
                                            comp.status === 'EXTRA' ? 'é”™æ£€' :
                                            comp.status === 'TYPE_MISMATCH' ? 'ç±»å‹é”™è¯¯' : 'åå·®';
                                        const tplX = comp.templatePosition?.x ?? comp.template_position?.x;
                                        const tplY = comp.templatePosition?.y ?? comp.template_position?.y;
                                        const detX = comp.detectedPosition?.x ?? comp.detected_position?.x;
                                        const detY = comp.detectedPosition?.y ?? comp.detected_position?.y;
                                        const xError = comp.xError ?? comp.x_error;
                                        const yError = comp.yError ?? comp.y_error;
                                        const totalError = comp.totalError ?? comp.total_error;
                                        const toleranceX = comp.toleranceX ?? comp.tolerance_x;
                                        const toleranceY = comp.toleranceY ?? comp.tolerance_y;
                                        // ç±»å‹é”™è¯¯æˆ–é”™æ£€æ—¶æ˜¾ç¤ºæ ¼å¼: "æ¨¡æ¿: nut -> æ£€æµ‹: hole"
                                        let displayType = comp.className || comp.featureName || comp.feature_name || 'class_' + comp.classId;
                                        if ((comp.status === 'TYPE_MISMATCH' || comp.status === 'EXTRA') && comp.expectedClassName && comp.className) {
                                            displayType = `æ¨¡æ¿: ${comp.expectedClassName} &rarr; æ£€æµ‹: ${comp.className}`;
                                        }
                                        // ç±»å‹é”™è¯¯æ—¶ï¼Œæ¨¡æ¿ä½ç½®å°±æ˜¯é¢„æœŸçš„ç‰¹å¾ä½ç½®
                                        let displayTplX = tplX;
                                        let displayTplY = tplY;
                                        if (comp.status === 'TYPE_MISMATCH' && comp.expectedPosition) {
                                            displayTplX = comp.expectedPosition.x ?? comp.expected_position?.x;
                                            displayTplY = comp.expectedPosition.y ?? comp.expected_position?.y;
                                        }
                                        // é”™æ£€æ—¶ä½¿ç”¨é¢„æœŸä½ç½®ä½œä¸ºæ¨¡æ¿ä½ç½®
                                        if (comp.status === 'EXTRA' && comp.expectedPosition) {
                                            displayTplX = comp.expectedPosition.x ?? comp.expected_position?.x;
                                            displayTplY = comp.expectedPosition.y ?? comp.expected_position?.y;
                                        }
                                        return `
                                            <tr data-index="${i}" onclick="${comp.status !== 'MISSING' ? `highlightBBox(${i})` : ''}" style="cursor: ${comp.status !== 'MISSING' ? 'pointer' : 'default'}; ${!comp.withinTolerance ? 'background: #fff1f0;' : ''}">
                                                <td><span class="${statusClass}">${statusText}</span></td>
                                                <td>${displayType}</td>
                                                <td>(${displayTplX != null ? Math.round(displayTplX) : '-'}, ${displayTplY != null ? Math.round(displayTplY) : '-'})</td>
                                                <td>${detX != null ? `(${Math.round(detX)}, ${Math.round(detY)})` : '-'}</td>
                                                <td style="color: ${xError != null && xError !== undefined && xError !== 0 && Math.abs(xError) > toleranceX ? '#ff4d4f' : 'inherit'}">
                                                    ${xError != null && xError !== undefined && xError !== 0 ? xError.toFixed(2) : '-'}
                                                </td>
                                                <td style="color: ${yError != null && yError !== undefined && yError !== 0 && Math.abs(yError) > toleranceY ? '#ff4d4f' : 'inherit'}">
                                                    ${yError != null && yError !== undefined && yError !== 0 ? yError.toFixed(2) : '-'}
                                                </td>
                                                <td style="color: ${totalError != null && totalError !== undefined && totalError !== 0 && totalError > Math.max(toleranceX, toleranceY) ? '#ff4d4f' : 'inherit'}">
                                                    ${totalError != null && totalError !== undefined && totalError !== 0 ? totalError.toFixed(2) : '-'}
                                                </td>
                                                <td>Xâ‰¤${toleranceX}, Yâ‰¤${toleranceY}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : `
                        <!-- æ²¡æœ‰æ¨¡æ¿æ¯”å¯¹ç»“æœæ—¶æ˜¾ç¤ºåŸå§‹æ£€æµ‹åˆ—è¡¨ -->
                        <div class="table-container">
                            <table>
                                <thead><tr><th>ID</th><th>ç±»å‹</th><th>åæ ‡</th><th>ç½®ä¿¡åº¦</th></tr></thead>
                                <tbody id="resultTableBody">
                                    ${details.map((det, i) => `
                                        <tr data-index="${i}" onclick="highlightBBox(${i})" style="cursor: pointer;">
                                            <td>${i + 1}</td>
                                            <td>${det.label}</td>
                                            <td>${det.bbox ? `[${det.bbox.map(v => Math.round(v)).join(', ')}]` : '-'}</td>
                                            <td>${(det.confidence * 100).toFixed(0)}%</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `}
                </div>
            </div>
        `;

        // ä¿å­˜æ¨¡æ¿æ¯”å¯¹ç»“æœåˆ°å…¨å±€å˜é‡ï¼Œä¾›ç»˜åˆ¶ä½¿ç”¨
        templateComparisonsData = data.analysis.templateComparisons || [];

        // ç»˜åˆ¶æ£€æµ‹æ¡†
        setTimeout(() => {
            drawBBoxes(details);
            // å¦‚æœæœ‰æ¨¡æ¿æ¯”å¯¹ç»“æœï¼Œç»˜åˆ¶æ¼æ£€å’Œé”™æ£€æ ‡æ³¨
            if (templateComparisonsData.length > 0) {
                drawTemplateComparisons(templateComparisonsData);
            }
        }, 100);

        const statusTag = document.getElementById('status-tag');
        const isPass = data.analysis.quality_status === 'PASS';
        statusTag.className = 'status-tag ' + (isPass ? 'pass' : 'fail');
        statusTag.innerText = isPass ? 'âœ“ è´¨æ£€åˆæ ¼' : 'âœ— è´¨æ£€ä¸åˆæ ¼';

        // æ˜¾ç¤º"æ£€æŸ¥å®Œæˆ"æŒ‰é’®
        document.getElementById('completeBtn').style.display = 'block';
    }

    // æ¸…ç©ºæ£€æµ‹ç»“æœï¼Œæ¢å¤åˆ°æ£€æŸ¥å‰çš„çŠ¶æ€
    function clearResults() {
        // æ¸…ç©ºç»“æœæ˜¾ç¤ºåŒºåŸŸ
        const panelBody = document.getElementById('result-panel-body');
        panelBody.innerHTML = `
            <div class="empty-state">
                <p>æš‚æ— æ£€æµ‹æ•°æ®ï¼Œè¯·ç‚¹å‡»å·¦ä¾§ "å¼€å§‹æ£€æµ‹"</p>
            </div>
        `;

        // é‡ç½®çŠ¶æ€æ ‡ç­¾
        const statusTag = document.getElementById('status-tag');
        statusTag.className = 'status-tag waiting';
        statusTag.innerText = 'ç­‰å¾…æ£€æµ‹';

        // éšè—"æ£€æŸ¥å®Œæˆ"æŒ‰é’®
        document.getElementById('completeBtn').style.display = 'none';

        // æ¸…ç©ºæ£€æµ‹æ¡†æ•°æ®
        bboxesData = [];
        selectedIndex = -1;
        canvasCtx = null;

        // æ¸…ç©ºé¢œè‰²æ˜ å°„
        for (const key in defectTypeColors) {
            delete defectTypeColors[key];
        }

        // æ¸…ç©ºæ£€æµ‹å¼€å§‹æ—¶é—´
        inspectionStartTime = null;

        showToast('æ£€æµ‹ç»“æœå·²æ¸…ç©º');
    }

    // å…¨å±€å˜é‡ç”¨äºå­˜å‚¨æ£€æµ‹æ¡†æ•°æ®
    let bboxesData = [];
    let canvasCtx = null;
    let selectedIndex = -1;
    let templateComparisonsData = [];  // æ¨¡æ¿æ¯”å¯¹ç»“æœæ•°æ®

    // ç¼ºé™·ç±»å‹é¢œè‰²æ˜ å°„
    const defectTypeColors = {};
    const colorPalette = [
        '#00FF00', '#FF0000', '#00FFFF', '#FF00FF', '#FFFF00',
        '#FF8800', '#0088FF', '#FF0088', '#88FF00', '#8800FF',
        '#00FF88', '#FF8888', '#88FFFF', '#FF88FF', '#FFFF88'
    ];

    // è·å–ç¼ºé™·ç±»å‹çš„é¢œè‰²
    function getDefectTypeColor(defectType) {
        if (!defectTypeColors[defectType]) {
            const usedColors = Object.values(defectTypeColors);
            const availableColor = colorPalette.find(c => !usedColors.includes(c));
            defectTypeColors[defectType] = availableColor || colorPalette[Object.keys(defectTypeColors).length % colorPalette.length];
        }
        return defectTypeColors[defectType];
    }

    function drawBBoxes(details) {
        const img = document.getElementById('resultImage');
        const canvas = document.getElementById('bboxCanvas');
        if (!img || !canvas) return;

        bboxesData = details;
        selectedIndex = -1;

        // è®¾ç½® canvas å°ºå¯¸ä¸å›¾ç‰‡ä¸€è‡´
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        canvas.style.width = img.width + 'px';
        canvas.style.height = img.height + 'px';

        canvasCtx = canvas.getContext('2d');

        // ç»˜åˆ¶æ‰€æœ‰æ£€æµ‹æ¡†
        redrawBBoxes();
    }

    function redrawBBoxes() {
        if (!canvasCtx) return;

        canvasCtx.clearRect(0, 0, canvasCtx.canvas.width, canvasCtx.canvas.height);

        bboxesData.forEach((det, i) => {
            if (!det.bbox || det.bbox.length < 4) return;

            const [x1, y1, x2, y2] = det.bbox;
            const width = x2 - x1;
            const height = y2 - y1;

            const isSelected = i === selectedIndex;

            // æ ¹æ®æ¨¡æ¿æ¯”å¯¹ç»“æœç¡®å®šé¢œè‰²
            const detCenterX = det.centerX || det.bbox[0] + (det.bbox[2] - det.bbox[0]) / 2;
            const detCenterY = det.centerY || det.bbox[1] + (det.bbox[3] - det.bbox[1]) / 2;
            const compStatus = getComparisonStatus(detCenterX, detCenterY);

            let color;
            if (compStatus === 'PASSED') {
                color = '#52c41a'; // ç»¿è‰² - åˆæ ¼
            } else if (compStatus === 'DEVIATION') {
                color = '#faad14'; // é»„è‰² - åå·®
            } else if (compStatus === 'EXTRA') {
                color = '#ff4d4f'; // çº¢è‰² - é”™æ£€
            } else {
                color = getDefectTypeColor(det.label); // æœªæ¯”å¯¹ï¼Œä½¿ç”¨ç¼ºé™·ç±»å‹é¢œè‰²
            }

            // ç»˜åˆ¶çŸ©å½¢æ¡†
            canvasCtx.strokeStyle = isSelected ? '#FFFFFF' : color;
            canvasCtx.lineWidth = isSelected ? 4 : 2;
            canvasCtx.strokeRect(x1, y1, width, height);

            // ç»˜åˆ¶æ ‡ç­¾èƒŒæ™¯
            canvasCtx.fillStyle = isSelected ? '#FFFFFF' : color;
            const labelText = `${det.label} (${(det.confidence * 100).toFixed(0)}%)`;
            canvasCtx.font = 'bold 14px Arial';
            const textWidth = canvasCtx.measureText(labelText).width;
            canvasCtx.fillRect(x1, y1 - 24, textWidth + 8, 24);

            // ç»˜åˆ¶æ ‡ç­¾æ–‡å­—
            canvasCtx.fillStyle = isSelected ? '#000000' : '#000000';
            canvasCtx.fillText(labelText, x1 + 4, y1 - 6);
        });
    }

    // è·å–æ£€æµ‹å¯¹è±¡çš„æ¯”å¯¹çŠ¶æ€
    function getComparisonStatus(x, y) {
        if (!templateComparisonsData || templateComparisonsData.length === 0) {
            return null;
        }

        // æ‰¾åˆ°è·ç¦»æœ€è¿‘çš„æ¯”å¯¹ç»“æœ
        let nearestComp = null;
        let minDist = Infinity;

        templateComparisonsData.forEach(comp => {
            const compX = comp.detectedPosition?.x ?? comp.detected_position?.x;
            const compY = comp.detectedPosition?.y ?? comp.detected_position?.y;

            if (compX != null && compY != null) {
                const dist = Math.sqrt(Math.pow(x - compX, 2) + Math.pow(y - compY, 2));
                if (dist < minDist) {
                    minDist = dist;
                    nearestComp = comp;
                }
            }
        });

        // å¦‚æœè·ç¦»å¤ªè¿œï¼ˆè¶…è¿‡50åƒç´ ï¼‰ï¼Œè®¤ä¸ºæ²¡æœ‰å¯¹åº”çš„æ¯”å¯¹ç»“æœ
        if (minDist > 50) {
            return null;
        }

        const status = nearestComp?.status;
        if (status === 'MISSING') return 'MISSING';
        if (status === 'EXTRA') return 'EXTRA';
        if (status === 'DEVIATION_EXCEEDED') return 'DEVIATION';
        if (nearestComp?.withinTolerance) return 'PASSED';

        return null;
    }

    // ç»˜åˆ¶æ¨¡æ¿æ¯”å¯¹ç»“æœï¼ˆæ¼æ£€å’Œé”™æ£€æ ‡æ³¨ï¼‰
    function drawTemplateComparisons(comparisons) {
        if (!canvasCtx) return;

        comparisons.forEach((comp, i) => {
            const detX = comp.detectedPosition?.x ?? comp.detected_position?.x;
            const detY = comp.detectedPosition?.y ?? comp.detected_position?.y;
            const status = comp.status;
            const featureName = comp.featureName || comp.feature_name || 'unknown';

            if (status === 'MISSING') {
                // æ¼æ£€ï¼šçº¢è‰²è™šçº¿æ¡† + åå­— + æ–‡å­—
                if (detX != null && detY != null) {
                    drawMissingAnnotation(canvasCtx, detX, detY, featureName);
                }
            } else if (status === 'EXTRA') {
                // é”™æ£€ï¼šçº¢è‰²X + åœ†åœˆ + æ–‡å­—
                if (detX != null && detY != null) {
                    drawExtraAnnotation(canvasCtx, detX, detY, featureName);
                }
            } else if (comp.withinTolerance) {
                // åˆæ ¼ï¼šç»¿è‰²å°æ–¹å—æ ‡è®°
                if (detX != null && detY != null) {
                    drawPassedAnnotation(canvasCtx, detX, detY);
                }
            } else if (status === 'DEVIATION_EXCEEDED' || (!comp.withinTolerance && status !== 'MISSING' && status !== 'EXTRA')) {
                // åå·®è¿‡å¤§ï¼šé»„è‰²ç©ºå¿ƒæ¡†
                if (detX != null && detY != null) {
                    drawDeviationAnnotation(canvasCtx, detX, detY);
                }
            }
        });
    }

    // ç»˜åˆ¶æ¼æ£€æ ‡æ³¨ï¼ˆçº¢è‰²è™šçº¿æ¡† + åå­—ï¼‰
    function drawMissingAnnotation(ctx, x, y, label) {
        const size = 30;

        // ç»˜åˆ¶çº¢è‰²è™šçº¿æ¡†
        ctx.strokeStyle = '#FF0000';
        ctx.lineWidth = 2;
        ctx.setLineDash([8, 4]); // è™šçº¿æ¨¡å¼
        ctx.strokeRect(x - size, y - size, size * 2, size * 2);
        ctx.setLineDash([]); // é‡ç½®ä¸ºå®çº¿

        // ç»˜åˆ¶ä¸­å¿ƒåå­—
        ctx.beginPath();
        ctx.moveTo(x - 10, y);
        ctx.lineTo(x + 10, y);
        ctx.moveTo(x, y - 10);
        ctx.lineTo(x, y + 10);
        ctx.stroke();

        // ç»˜åˆ¶æ–‡å­—æ ‡ç­¾
        ctx.fillStyle = '#FF0000';
        ctx.font = 'bold 14px Arial';
        const text = `æ¼æ£€: ${label}`;
        ctx.fillText(text, x - size, y - size - 8);
    }

    // ç»˜åˆ¶é”™æ£€æ ‡æ³¨ï¼ˆçº¢è‰²X + åœ†åœˆï¼‰
    function drawExtraAnnotation(ctx, x, y, label) {
        const size = 25;

        // ç»˜åˆ¶çº¢è‰²X
        ctx.strokeStyle = '#FF0000';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(x - size, y - size);
        ctx.lineTo(x + size, y + size);
        ctx.moveTo(x + size, y - size);
        ctx.lineTo(x - size, y + size);
        ctx.stroke();

        // ç»˜åˆ¶å¤–åœˆ
        ctx.beginPath();
        ctx.arc(x, y, size + 5, 0, Math.PI * 2);
        ctx.stroke();

        // ç»˜åˆ¶æ–‡å­—æ ‡ç­¾
        ctx.fillStyle = '#FF0000';
        ctx.font = 'bold 14px Arial';
        ctx.fillText('é”™æ£€', x - size, y - size - 8);
    }

    // ç»˜åˆ¶åˆæ ¼æ ‡æ³¨ï¼ˆç»¿è‰²å°æ–¹å—ï¼‰
    function drawPassedAnnotation(ctx, x, y) {
        const size = 6;
        ctx.fillStyle = '#52c41a'; // ç»¿è‰²ï¼ˆåˆæ ¼ï¼‰
        ctx.fillRect(x - size, y - size, size * 2, size * 2);
    }

    // ç»˜åˆ¶åå·®æ ‡æ³¨ï¼ˆé»„è‰²ç©ºå¿ƒæ¡†ï¼‰
    function drawDeviationAnnotation(ctx, x, y) {
        const size = 10;
        ctx.strokeStyle = '#FFFF00'; // é»„è‰²
        ctx.lineWidth = 2;
        ctx.strokeRect(x - size, y - size, size * 2, size * 2);
    }

    function highlightBBox(index) {
        // æ›´æ–°è¡¨æ ¼è¡Œæ ·å¼
        const rows = document.querySelectorAll('#resultTableBody tr');
        rows.forEach((row, i) => {
            if (i === index) {
                row.style.background = '#e6f7ff';
            } else {
                row.style.background = '';
            }
        });

        // æ›´æ–° Canvas é«˜äº®
        selectedIndex = index;
        redrawBBoxes();
    }

    function closeModal() {
        document.getElementById('confirmModal').style.display = 'none';
    }

    // å›¾ç‰‡é¢„è§ˆåŠŸèƒ½
    function showImagePreview(src) {
        // åˆ›å»ºé¢„è§ˆæ¨¡æ€æ¡†
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.id = 'imagePreviewModal';
        modal.innerHTML = `
            <div class="modal-card center-dialog" style="width: 1400px; max-width: 95vw; max-height: 90vh;">
                <div class="modal-header">
                    <span>æ£€æµ‹ç»“æœå›¾ç‰‡</span>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button class="btn btn-success" onclick="downloadAnnotatedImage()" style="padding: 6px 12px; font-size: 13px;">â¬‡ ä¸‹è½½å›¾ç‰‡</button>
                        <button class="modal-close" onclick="closeImagePreview()">&times;</button>
                    </div>
                </div>
                <div class="modal-body" style="display: flex; align-items: center; justify-content: center; background: #f5f5f5; padding: 20px;">
                    <div class="preview-image-wrapper" style="position: relative; display: inline-block;">
                        <img id="previewImage" src="${src}" style="max-width: 100%; max-height: 75vh; object-fit: contain; border-radius: 4px; display: block;">
                        <canvas id="previewCanvas" style="position: absolute; top: 0; left: 0; pointer-events: none;"></canvas>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        // å›¾ç‰‡åŠ è½½åç»˜åˆ¶æ£€æµ‹æ¡†
        const img = document.getElementById('previewImage');
        img.onload = () => {
            drawPreviewBBoxes(img);
        };

        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeImagePreview();
            }
        });
    }

    // ä¸‹è½½å¸¦æ ‡æ³¨çš„å›¾ç‰‡
    function downloadAnnotatedImage() {
        const img = document.getElementById('previewImage');
        const canvas = document.getElementById('previewCanvas');

        if (!img || !canvas) return;

        // åˆ›å»ºä¸€ä¸ªæ–°çš„ canvasï¼Œå°†å›¾ç‰‡å’Œæ£€æµ‹æ¡†åˆå¹¶
        const mergedCanvas = document.createElement('canvas');
        mergedCanvas.width = img.naturalWidth;
        mergedCanvas.height = img.naturalHeight;
        const ctx = mergedCanvas.getContext('2d');

        // ç»˜åˆ¶åŸå›¾
        ctx.drawImage(img, 0, 0);

        // ç»˜åˆ¶æ£€æµ‹æ¡†
        ctx.drawImage(canvas, 0, 0);

        // å¯¼å‡ºä¸ºå›¾ç‰‡å¹¶ä¸‹è½½
        const link = document.createElement('a');
        link.download = `æ£€æµ‹ç»“æœ_${new Date().toLocaleString('zh-CN', { hour12: false }).replace(/[/:]/g, '-')}.png`;
        link.href = mergedCanvas.toDataURL('image/png');
        link.click();
    }

    function drawPreviewBBoxes(img) {
        const canvas = document.getElementById('previewCanvas');
        if (!canvas) return;

        // è®¾ç½® canvas å°ºå¯¸ä¸å›¾ç‰‡åŸå§‹å°ºå¯¸ä¸€è‡´
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        canvas.style.width = img.width + 'px';
        canvas.style.height = img.height + 'px';

        const ctx = canvas.getContext('2d');

        // ç»˜åˆ¶æ£€æµ‹æ¡†
        bboxesData.forEach((det, i) => {
            if (!det.bbox || det.bbox.length < 4) return;

            const [x1, y1, x2, y2] = det.bbox;
            const width = x2 - x1;
            const height = y2 - y1;

            const isSelected = i === selectedIndex;

            // æ ¹æ®æ¨¡æ¿æ¯”å¯¹ç»“æœç¡®å®šé¢œè‰²
            const detCenterX = det.centerX || det.bbox[0] + (det.bbox[2] - det.bbox[0]) / 2;
            const detCenterY = det.centerY || det.bbox[1] + (det.bbox[3] - det.bbox[1]) / 2;
            const compStatus = getComparisonStatus(detCenterX, detCenterY);

            let color;
            if (compStatus === 'PASSED') {
                color = '#52c41a'; // ç»¿è‰² - åˆæ ¼
            } else if (compStatus === 'DEVIATION') {
                color = '#faad14'; // é»„è‰² - åå·®
            } else if (compStatus === 'EXTRA') {
                color = '#ff4d4f'; // çº¢è‰² - é”™æ£€
            } else {
                color = getDefectTypeColor(det.label); // æœªæ¯”å¯¹ï¼Œä½¿ç”¨ç¼ºé™·ç±»å‹é¢œè‰²
            }

            // ç»˜åˆ¶çŸ©å½¢æ¡†
            ctx.strokeStyle = isSelected ? '#FFFFFF' : color;
            ctx.lineWidth = isSelected ? 4 : 2;
            ctx.strokeRect(x1, y1, width, height);

            // ç»˜åˆ¶æ ‡ç­¾èƒŒæ™¯
            ctx.fillStyle = isSelected ? '#FFFFFF' : color;
            const labelText = `${det.label} (${(det.confidence * 100).toFixed(0)}%)`;
            ctx.font = 'bold 16px Arial';
            const textWidth = ctx.measureText(labelText).width;
            ctx.fillRect(x1, y1 - 26, textWidth + 10, 26);

            // ç»˜åˆ¶æ ‡ç­¾æ–‡å­—
            ctx.fillStyle = isSelected ? '#000000' : '#000000';
            ctx.fillText(labelText, x1 + 5, y1 - 7);
        });

        // ç»˜åˆ¶æ¨¡æ¿æ¯”å¯¹ç»“æœï¼ˆæ¼æ£€å’Œé”™æ£€æ ‡æ³¨ï¼‰
        if (templateComparisonsData.length > 0) {
            templateComparisonsData.forEach((comp, i) => {
                const detX = comp.detectedPosition?.x ?? comp.detected_position?.x;
                const detY = comp.detectedPosition?.y ?? comp.detected_position?.y;
                const status = comp.status;
                const featureName = comp.featureName || comp.feature_name || 'unknown';

                if (status === 'MISSING') {
                    // æ¼æ£€ï¼šçº¢è‰²è™šçº¿æ¡† + åå­— + æ–‡å­—
                    if (detX != null && detY != null) {
                        drawMissingAnnotation(ctx, detX, detY, featureName);
                    }
                } else if (status === 'EXTRA') {
                    // é”™æ£€ï¼šçº¢è‰²X + åœ†åœˆ + æ–‡å­—
                    if (detX != null && detY != null) {
                        drawExtraAnnotation(ctx, detX, detY, featureName);
                    }
                } else if (comp.withinTolerance) {
                    // åˆæ ¼ï¼šç»¿è‰²å°æ–¹å—æ ‡è®°
                    if (detX != null && detY != null) {
                        drawPassedAnnotation(ctx, detX, detY);
                    }
                } else if (status === 'DEVIATION_EXCEEDED' || (!comp.withinTolerance && status !== 'MISSING' && status !== 'EXTRA')) {
                    // åå·®è¿‡å¤§ï¼šé»„è‰²ç©ºå¿ƒæ¡†
                    if (detX != null && detY != null) {
                        drawDeviationAnnotation(ctx, detX, detY);
                    }
                }
            });
        }
    }

    function closeImagePreview() {
        const modal = document.getElementById('imagePreviewModal');
        if (modal) {
            modal.remove();
        }
    }

    // --- ç³»ç»Ÿè®¾ç½® ---
    let currentTab = 'stitch';
    let templatesData = [];
    let currentTemplate = null;

    // æ¨¡æ¿ç®¡ç†ç›¸å…³
    async function loadTemplates() {
        console.log('loadTemplates called');
        try {
            const res = await fetch(`${API_BASE}/api/templates`);
            const data = await res.json();
            console.log('Templates data:', data);
            if (Array.isArray(data)) {
                templatesData = data;
                renderTemplates();
            }
        } catch(e) {
            console.error('Failed to load templates', e);
        }
    }

    function renderTemplates() {
        const container = document.getElementById('templatesContainer');
        container.innerHTML = '';

        if (templatesData.length === 0) {
            container.innerHTML = '<div style="color: #888; padding: 20px; text-align: center;">æš‚æ— æ¨¡æ¿ï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ„å»ºæ–°æ¨¡æ¿</div>';
            return;
        }

        templatesData.forEach(template => {
            const templateItem = document.createElement('div');
            templateItem.className = 'part-type-item';

            const partType = template.metadata?.partType || 'æœªå…³è”';
            const featureCount = template.features?.length || 0;
            const isCurrent = currentTemplate?.templateId === template.templateId;

            templateItem.innerHTML = `
                <div class="part-type-header" style="${isCurrent ? 'background: #e8f5e9;' : ''}">
                    <span class="part-type-name">${template.templateId} ${isCurrent ? '<span style="color: #4caf50; font-size: 11px;">(å½“å‰)</span>' : ''}</span>
                    <div>
                        ${!isCurrent ? `<button class="btn btn-success" style="font-size: 10px; padding: 2px 8px; margin-right: 5px;" onclick="activateTemplate('${template.templateId}')">æ¿€æ´»</button>` : ''}
                        <button class="btn-icon" onclick="viewTemplateDetails('${template.templateId}')">ğŸ“‹</button>
                        <button class="btn-icon" onclick="deleteTemplate('${template.templateId}')">&times;</button>
                    </div>
                </div>
                <div style="padding: 10px; font-size: 12px; color: #666;">
                    <div>å…³è”å·¥ä»¶: ${partType}</div>
                    <div>ç‰¹å¾æ•°é‡: ${featureCount}</div>
                    <div>å›¾ç‰‡å°ºå¯¸: ${template.imageSize?.width}x${template.imageSize?.height}</div>
                    <div>å®¹å·®: X=${template.toleranceX}, Y=${template.toleranceY}</div>
                </div>
            `;
            container.appendChild(templateItem);
        });

        // åŠ è½½å½“å‰æ¨¡æ¿
        loadCurrentTemplate();
    }

    async function loadCurrentTemplate() {
        try {
            const res = await fetch(`${API_BASE}/api/templates/current`);
            if (res.ok) {
                currentTemplate = await res.json();
                // ä¸å†è°ƒç”¨ renderTemplates()ï¼Œé¿å…æ— é™å¾ªç¯
            }
        } catch(e) {
            console.error('Failed to load current template', e);
        }
    }

    async function activateTemplate(templateId) {
        try {
            const res = await fetch(`${API_BASE}/api/templates/${encodeURIComponent(templateId)}/activate`, {
                method: 'POST'
            });
            const data = await res.json();
            if (data.success === true) {
                currentTemplate = data.template;
                renderTemplates();
                showToast('æ¨¡æ¿å·²æ¿€æ´»');
            } else {
                showToast('æ¿€æ´»å¤±è´¥: ' + data.message, 'error');
            }
        } catch(e) {
            console.error('Activate template error:', e);
            showToast('æ¿€æ´»å¤±è´¥', 'error');
        }
    }

    async function deleteTemplate(templateId) {
        if (!confirm(`ç¡®å®šè¦åˆ é™¤æ¨¡æ¿ "${templateId}" å—ï¼Ÿ`)) return;
        try {
            const res = await fetch(`${API_BASE}/api/templates/${encodeURIComponent(templateId)}`, {
                method: 'DELETE'
            });
            if (res.ok) {
                await loadTemplates();
                showToast('æ¨¡æ¿å·²åˆ é™¤');
            }
        } catch(e) {
            console.error('Delete template error:', e);
            showToast('åˆ é™¤å¤±è´¥', 'error');
        }
    }

    function viewTemplateDetails(templateId) {
        const template = templatesData.find(t => t.templateId === templateId);
        if (!template) return;

        let details = `æ¨¡æ¿ ID: ${template.templateId}\n\n`;
        details += `å›¾ç‰‡å°ºå¯¸: ${template.imageSize?.width}x${template.imageSize?.height}\n`;
        details += `å®¹å·®: X=${template.toleranceX}, Y=${template.toleranceY}\n`;
        details += `å…³è”å·¥ä»¶: ${template.metadata?.partType || 'æœªå…³è”'}\n`;
        details += `ç‰¹å¾æ•°é‡: ${template.features?.length || 0}\n`;
        details += `é”šç‚¹æ•°é‡: ${template.anchorPoints?.length || 0}\n\n`;

        if (template.features && template.features.length > 0) {
            details += 'ç‰¹å¾åˆ—è¡¨:\n';
            template.features.forEach((f, idx) => {
                const name = f.name || f.className || 'class_' + f.classId;
                const x = f.position?.x || f.relativePosition?.x || 0;
                const y = f.position?.y || f.relativePosition?.y || 0;
                details += `  ${idx + 1}. ${name} (classId: ${f.classId}) at (${x.toFixed(1)}, ${y.toFixed(1)})\n`;
            });
        }

        alert(details);
    }

    // ä¿å­˜é¢„è§ˆçš„æ£€æµ‹ç»“æœ
    let previewDetectionData = null;

    // æ˜¾ç¤ºä¸€é”®å»ºæ¨¡å¯¹è¯æ¡†
    function showOneClickBuildModal() {
        const html = `
            <div id="oneClickBuildModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 2000;">
                <div style="background: #fff; padding: 24px; border-radius: 8px; width: 600px; max-width: 95%; max-height: 95vh; overflow-y: auto;">
                    <h3 style="margin-top: 0;">âš¡ ä¸€é”®å»ºæ¨¡</h3>
                    <p style="color: #666; font-size: 13px; margin-bottom: 20px;">
                        å…ˆé¢„è§ˆè¯†åˆ«ç»“æœï¼Œç¡®è®¤æ— è¯¯åå†åˆ›å»ºæ¨¡æ¿
                    </p>

                    <!-- æ­¥éª¤1: è®¾ç½®å‚æ•° -->
                    <div id="buildStep1">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: bold;">å·¥ä»¶ç±»å‹ *</label>
                            <input type="text" id="oneClickPartType" placeholder="ä¾‹å¦‚: CX756601" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                            <div style="font-size: 11px; color: #888; margin-top: 4px;">ç”¨äºæ ‡è¯†æ¨¡æ¿åç§°</div>
                        </div>

                        <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                            <div style="flex: 1;">
                                <label style="display: block; margin-bottom: 6px; font-weight: bold;">X è½´å®¹å·® (åƒç´ )</label>
                                <input type="number" id="oneClickToleranceX" value="20" min="1" max="500" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <div style="font-size: 11px; color: #888; margin-top: 4px;">é»˜è®¤: 20</div>
                            </div>
                            <div style="flex: 1;">
                                <label style="display: block; margin-bottom: 6px; font-weight: bold;">Y è½´å®¹å·® (åƒç´ )</label>
                                <input type="number" id="oneClickToleranceY" value="20" min="1" max="500" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <div style="font-size: 11px; color: #888; margin-top: 4px;">é»˜è®¤: 20</div>
                            </div>
                        </div>

                        <div style="padding: 12px; background: #f0f9ff; border-left: 3px solid #1890ff; border-radius: 4px; margin-bottom: 15px; font-size: 12px;">
                            <strong style="color: #1890ff;">æ“ä½œè¯´æ˜ï¼š</strong><br>
                            1. ç¡®ä¿æ‘„åƒå¤´å·²å¯åŠ¨<br>
                            2. ç¡®ä¿å½“å‰ç”»é¢ä¸­æœ‰å®Œæ•´çš„å·¥ä»¶<br>
                            3. ç‚¹å‡»"é¢„è§ˆè¯†åˆ«ç»“æœ"æŸ¥çœ‹æ£€æµ‹æ•ˆæœ
                        </div>

                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button class="btn btn-secondary" onclick="closeOneClickBuildModal()">å–æ¶ˆ</button>
                            <button class="btn btn-primary" onclick="previewDetection()">é¢„è§ˆè¯†åˆ«ç»“æœ</button>
                        </div>
                    </div>

                    <!-- æ­¥éª¤2: é¢„è§ˆç»“æœ -->
                    <div id="buildStep2" style="display: none;">
                        <div style="margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0;">è¯†åˆ«ç»“æœ</h4>
                            <div id="previewImageContainer" style="text-align: center; margin-bottom: 15px;">
                                <div style="color: #999; padding: 40px;">åŠ è½½ä¸­...</div>
                            </div>
                            <div id="detectionInfo" style="font-size: 13px; color: #666;"></div>
                        </div>

                        <div id="detectionList" style="max-height: 200px; overflow-y: auto; margin-bottom: 15px; border: 1px solid #eee; border-radius: 4px; padding: 10px;">
                        </div>

                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button class="btn btn-secondary" onclick="backToStep1()">è¿”å›</button>
                            <button class="btn btn-success" onclick="confirmBuild()">ç¡®è®¤å¹¶åˆ›å»ºæ¨¡æ¿</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', html);

        // è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
        setTimeout(() => {
            const input = document.getElementById('oneClickPartType');
            if (input) input.focus();
        }, 100);
    }

    function closeOneClickBuildModal() {
        const modal = document.getElementById('oneClickBuildModal');
        if (modal) modal.remove();
        previewDetectionData = null;
    }

    // é¢„è§ˆè¯†åˆ«ç»“æœ
    async function previewDetection() {
        const partType = document.getElementById('oneClickPartType').value.trim();
        const toleranceX = parseFloat(document.getElementById('oneClickToleranceX').value) || 20;
        const toleranceY = parseFloat(document.getElementById('oneClickToleranceY').value) || 20;

        if (!partType) {
            showToast('è¯·è¾“å…¥å·¥ä»¶ç±»å‹', 'error');
            return;
        }

        try {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('buildStep1').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 40px; margin-bottom: 10px;">ğŸ”</div>
                    <div style="color: #666;">æ­£åœ¨è¯†åˆ«ç”»é¢...</div>
                </div>
            `;

            const res = await fetch(`${API_BASE}/api/templates/preview-detection`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });

            const data = await res.json();

            if (data.success) {
                // ä¿å­˜é¢„è§ˆæ•°æ®
                previewDetectionData = {
                    partType: partType,
                    toleranceX: toleranceX,
                    toleranceY: toleranceY,
                    detections: data.detections,
                    imageWidth: data.imageWidth,
                    imageHeight: data.imageHeight
                };

                // æ˜¾ç¤ºæ­¥éª¤2
                showPreviewResult(data);
            } else {
                showToast('è¯†åˆ«å¤±è´¥: ' + data.message, 'error');
                // æ¢å¤æ­¥éª¤1
                backToStep1();
            }
        } catch(e) {
            console.error('Preview error:', e);
            showToast('è¯†åˆ«å¤±è´¥: ' + e.message, 'error');
            backToStep1();
        }
    }

    // æ˜¾ç¤ºé¢„è§ˆç»“æœ
    function showPreviewResult(data) {
        document.getElementById('buildStep1').style.display = 'none';
        document.getElementById('buildStep2').style.display = 'block';

        // æ˜¾ç¤ºå›¾åƒ
        const imgHtml = `<img src="${data.image}" style="max-width: 100%; max-height: 350px; border: 1px solid #ddd; border-radius: 4px;">`;
        document.getElementById('previewImageContainer').innerHTML = imgHtml;

        // æ˜¾ç¤ºæ£€æµ‹ä¿¡æ¯
        document.getElementById('detectionInfo').innerHTML = `
            <strong>æ£€æµ‹åˆ° ${data.count} ä¸ªç‰¹å¾</strong>
        `;

        // æ˜¾ç¤ºæ£€æµ‹åˆ—è¡¨
        const listHtml = data.detections.map((d, i) => `
            <div style="padding: 6px 0; border-bottom: 1px solid #f5f5f5; font-size: 12px;">
                <span style="color: #1890ff; font-weight: bold;">${d.className || 'class_' + d.classId}</span>
                <span style="color: #999;">ç½®ä¿¡åº¦:</span> ${(d.confidence * 100).toFixed(1)}%
                <span style="color: #999;">ä½ç½®:</span> (${d.centerX.toFixed(0)}, ${d.centerY.toFixed(0)})
            </div>
        `).join('');
        document.getElementById('detectionList').innerHTML = listHtml;
    }

    // è¿”å›æ­¥éª¤1
    function backToStep1() {
        // ä¿å­˜ä¹‹å‰çš„è¾“å…¥å€¼
        const prevPartType = previewDetectionData ? previewDetectionData.partType : '';
        const prevToleranceX = previewDetectionData ? previewDetectionData.toleranceX : 20;
        const prevToleranceY = previewDetectionData ? previewDetectionData.toleranceY : 20;

        // é‡æ–°æ¸²æŸ“æ­¥éª¤1
        document.getElementById('buildStep1').innerHTML = `
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 6px; font-weight: bold;">å·¥ä»¶ç±»å‹ *</label>
                <input type="text" id="oneClickPartType" placeholder="ä¾‹å¦‚: CX756601" value="${prevPartType}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                <div style="font-size: 11px; color: #888; margin-top: 4px;">ç”¨äºæ ‡è¯†æ¨¡æ¿åç§°</div>
            </div>

            <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                <div style="flex: 1;">
                    <label style="display: block; margin-bottom: 6px; font-weight: bold;">X è½´å®¹å·® (åƒç´ )</label>
                    <input type="number" id="oneClickToleranceX" value="${prevToleranceX}" min="1" max="500" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <div style="font-size: 11px; color: #888; margin-top: 4px;">é»˜è®¤: 20</div>
                </div>
                <div style="flex: 1;">
                    <label style="display: block; margin-bottom: 6px; font-weight: bold;">Y è½´å®¹å·® (åƒç´ )</label>
                    <input type="number" id="oneClickToleranceY" value="${prevToleranceY}" min="1" max="500" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <div style="font-size: 11px; color: #888; margin-top: 4px;">é»˜è®¤: 20</div>
                </div>
            </div>

            <div style="padding: 12px; background: #f0f9ff; border-left: 3px solid #1890ff; border-radius: 4px; margin-bottom: 15px; font-size: 12px;">
                <strong style="color: #1890ff;">æ“ä½œè¯´æ˜ï¼š</strong><br>
                1. ç¡®ä¿æ‘„åƒå¤´å·²å¯åŠ¨<br>
                2. ç¡®ä¿å½“å‰ç”»é¢ä¸­æœ‰å®Œæ•´çš„å·¥ä»¶<br>
                3. ç‚¹å‡»"é¢„è§ˆè¯†åˆ«ç»“æœ"æŸ¥çœ‹æ£€æµ‹æ•ˆæœ
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeOneClickBuildModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="previewDetection()">é¢„è§ˆè¯†åˆ«ç»“æœ</button>
            </div>
        `;

        document.getElementById('buildStep2').style.display = 'none';
        document.getElementById('buildStep1').style.display = 'block';
    }

    // ç¡®è®¤å¹¶åˆ›å»ºæ¨¡æ¿
    async function confirmBuild() {
        if (!previewDetectionData) {
            showToast('æ²¡æœ‰é¢„è§ˆæ•°æ®ï¼Œè¯·é‡æ–°é¢„è§ˆ', 'error');
            return;
        }

        try {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const button = document.querySelector('#buildStep2 .btn-success');
            const originalText = button.textContent;
            button.textContent = 'åˆ›å»ºä¸­...';
            button.disabled = true;

            const res = await fetch(`${API_BASE}/api/templates/one-click-build`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    partType: previewDetectionData.partType,
                    toleranceX: previewDetectionData.toleranceX,
                    toleranceY: previewDetectionData.toleranceY
                })
            });

            const data = await res.json();

            if (data.success === true || data.template) {
                closeOneClickBuildModal();
                await loadTemplates();
                showToast(`æ¨¡æ¿åˆ›å»ºæˆåŠŸï¼æ£€æµ‹åˆ° ${data.template?.featureCount || 0} ä¸ªç‰¹å¾`);
            } else {
                showToast('åˆ›å»ºå¤±è´¥: ' + data.message, 'error');
            }
        } catch(e) {
            console.error('Build error:', e);
            showToast('åˆ›å»ºå¤±è´¥: ' + e.message, 'error');
        } finally {
            const button = document.querySelector('#buildStep2 .btn-success');
            if (button) {
                button.textContent = 'ç¡®è®¤å¹¶åˆ›å»ºæ¨¡æ¿';
                button.disabled = false;
            }
        }
    }

    // ========== è£å‰ªåŒºåŸŸå»ºæ¨¡ ==========
    let cropAreaPreviewData = null;

    // åŠ è½½æ¨¡æ¿åˆ—è¡¨ç”¨äºè£å‰ªåŒºåŸŸå»ºæ¨¡
    async function loadTemplatesForCropArea() {
        try {
            const res = await fetch(`${API_BASE}/api/templates`);
            const data = await res.json();
            if (data && Array.isArray(data)) {
                // å»¶è¿Ÿå¡«å……ï¼Œå› ä¸ºDOMè¿˜æ²¡åˆ›å»º
                setTimeout(() => {
                    const select = document.getElementById('cropAreaObjectTemplate');
                    if (select) {
                        select.innerHTML = '<option value="">-- é€‰æ‹©å·²å­˜åœ¨çš„æ¨¡æ¿ --</option>';
                        data.forEach(t => {
                            const option = document.createElement('option');
                            option.value = t.imagePath;
                            option.textContent = `${t.templateId} (${t.partType || 'æœªåˆ†ç±»'})`;
                            select.appendChild(option);
                        });
                    }
                }, 100);
            }
        } catch(e) {
            console.error('Failed to load templates:', e);
        }
    }

    // æ˜¾ç¤ºè£å‰ªåŒºåŸŸå»ºæ¨¡å¯¹è¯æ¡†
    async function showCropAreaBuildModal() {
        // å…ˆåŠ è½½æ¨¡æ¿åˆ—è¡¨
        await loadTemplatesForCropArea();

        const html = `
            <div id="cropAreaBuildModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 2000;">
                <div style="background: #fff; padding: 24px; border-radius: 8px; width: 700px; max-width: 95%; max-height: 95vh; overflow-y: auto;">
                    <h3 style="margin-top: 0;">âœ‚ï¸ è£å‰ªåŒºåŸŸå»ºæ¨¡</h3>
                    <p style="color: #666; font-size: 13px; margin-bottom: 20px;">
                        ç”¨äºå·¥ä»¶ä½ç½®å¯èƒ½å˜åŒ–ï¼Œä½†å¯ä»¥é€šè¿‡æ•´ä½“æ£€æµ‹å®šä½çš„åœºæ™¯
                    </p>

                    <!-- æ­¥éª¤1: è®¾ç½®å‚æ•° -->
                    <div id="cropAreaStep1">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: bold;">å·¥ä»¶ç±»å‹ *</label>
                            <input type="text" id="cropAreaPartType" placeholder="ä¾‹å¦‚: CX756601" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        </div>

                        <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                            <div style="flex: 1;">
                                <label style="display: block; margin-bottom: 6px; font-weight: bold;">X è½´å®¹å·® (åƒç´ )</label>
                                <input type="number" id="cropAreaToleranceX" value="5" min="1" max="500" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="flex: 1;">
                                <label style="display: block; margin-bottom: 6px; font-weight: bold;">Y è½´å®¹å·® (åƒç´ )</label>
                                <input type="number" id="cropAreaToleranceY" value="5" min="1" max="500" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: bold;">å·¥ä»¶æ•´ä½“æ£€æµ‹æ¨¡æ¿ (å¯é€‰)</label>
                            <select id="cropAreaObjectTemplate" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                <option value="">-- é€‰æ‹©å·²å­˜åœ¨çš„æ¨¡æ¿ --</option>
                            </select>
                            <div style="font-size: 11px; color: #888; margin-top: 4px;">ç”¨äºæ£€æµ‹å·¥ä»¶æ•´ä½“ä½ç½®ï¼Œå¦‚æœä¸ºç©ºå°†ç›´æ¥å¯¹åŸå›¾è¿›è¡Œæ£€æµ‹</div>
                        </div>

                        <div style="padding: 12px; background: #f0f9ff; border-left: 3px solid #1890ff; border-radius: 4px; margin-bottom: 15px; font-size: 12px;">
                            <strong style="color: #1890ff;">æ“ä½œè¯´æ˜ï¼š</strong><br>
                            1. ç¡®ä¿æ‘„åƒå¤´å·²å¯åŠ¨<br>
                            2. ç¡®ä¿å½“å‰ç”»é¢ä¸­æœ‰å®Œæ•´çš„å·¥ä»¶<br>
                            3. ç‚¹å‡»"è·å–æˆªå›¾"è·å–å½“å‰ç”»é¢<br>
                            4. åœ¨æˆªå›¾ä¸Šæ¡†å‡ºå››ä¸ªè§’ï¼Œå®šä¹‰è£å‰ªåŒºåŸŸ<br>
                            5. é¢„è§ˆå¹¶ç¡®è®¤
                        </div>

                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button class="btn btn-secondary" onclick="closeCropAreaBuildModal()">å–æ¶ˆ</button>
                            <button class="btn btn-primary" onclick="captureCropAreaImage()">è·å–æˆªå›¾</button>
                        </div>
                    </div>

                    <!-- æ­¥éª¤2: æ¡†é€‰å››è§’ -->
                    <div id="cropAreaStep2" style="display: none;">
                        <div style="margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0;">æ¡†é€‰è£å‰ªåŒºåŸŸ</h4>
                            <div id="cropAreaCanvasContainer" style="text-align: center; margin-bottom: 15px; position: relative;">
                                <canvas id="cropAreaCanvas" style="max-width: 100%; border: 1px solid #ddd; cursor: crosshair;"></canvas>
                            </div>
                            <div style="font-size: 12px; color: #666; text-align: center;">
                                è¯·æŒ‰é¡ºåºç‚¹å‡»å››ä¸ªè§’ï¼ˆå·¦ä¸Šã€å³ä¸Šã€å³ä¸‹ã€å·¦ä¸‹ï¼‰
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button class="btn btn-secondary" onclick="backToCropAreaStep1()">è¿”å›</button>
                            <button class="btn btn-primary" onclick="previewCropArea()">é¢„è§ˆè¯†åˆ«ç»“æœ</button>
                        </div>
                    </div>

                    <!-- æ­¥éª¤3: é¢„è§ˆç»“æœ -->
                    <div id="cropAreaStep3" style="display: none;">
                        <div style="margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0;">è£å‰ªåŒºåŸŸé¢„è§ˆ</h4>
                            <div id="cropAreaPreviewContainer" style="text-align: center; margin-bottom: 15px;">
                                <div style="color: #999; padding: 40px;">åŠ è½½ä¸­...</div>
                            </div>
                            <div id="cropAreaDetectionInfo" style="font-size: 13px; color: #666;"></div>
                        </div>

                        <div id="cropAreaFeatureList" style="max-height: 200px; overflow-y: auto; margin-bottom: 15px; border: 1px solid #eee; border-radius: 4px; padding: 10px;">
                        </div>

                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button class="btn btn-secondary" onclick="backToCropAreaStep2()">è¿”å›</button>
                            <button class="btn btn-success" onclick="confirmCropAreaBuild()">ç¡®è®¤å¹¶åˆ›å»ºæ¨¡æ¿</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', html);

        // è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
        setTimeout(() => {
            const input = document.getElementById('cropAreaPartType');
            if (input) input.focus();
        }, 100);
    }

    function closeCropAreaBuildModal() {
        const modal = document.getElementById('cropAreaBuildModal');
        if (modal) modal.remove();
        cropAreaPreviewData = null;
    }

    // è·å–è£å‰ªåŒºåŸŸæˆªå›¾
    async function captureCropAreaImage() {
        const partType = document.getElementById('cropAreaPartType').value.trim();
        if (!partType) {
            showToast('è¯·è¾“å…¥å·¥ä»¶ç±»å‹', 'error');
            return;
        }

        try {
            // è°ƒç”¨ capture æ¥å£ï¼Œä¼ é€’å·¥ä»¶ç±»å‹
            const res = await fetch(`${API_BASE}/api/crop-area-template/capture`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ partType: partType })
            });
            const data = await res.json();

            if (data.success && data.data) {
                cropAreaPreviewData = {
                    partType: partType,
                    templateId: data.data.templateId,  // ä¿å­˜ templateId
                    imageBase64: data.data.imageUrl
                };

                // åŠ è½½å›¾ç‰‡å¹¶æ˜¾ç¤ºåœ¨ canvas ä¸Š
                const img = new Image();
                img.onload = function() {
                    const canvas = document.getElementById('cropAreaCanvas');
                    const ctx = canvas.getContext('2d');

                    // è®¾ç½® canvas å°ºå¯¸
                    const maxWidth = 650;
                    const scale = Math.min(maxWidth / img.width, 1);
                    canvas.width = img.width * scale;
                    canvas.height = img.height * scale;

                    // ç»˜åˆ¶å›¾ç‰‡
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                    // ä¿å­˜ corners æ•°ç»„
                    canvas.corners = [];

                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    canvas.onclick = function(e) {
                        const rect = canvas.getBoundingClientRect();
                        const x = e.clientX - rect.left;
                        const y = e.clientY - rect.top;

                        // è½¬æ¢å›åŸå›¾åæ ‡
                        const originalX = x / scale;
                        const originalY = y / scale;

                        canvas.corners.push({ x: originalX, y: originalY });

                        // ç»˜åˆ¶ç‚¹
                        ctx.fillStyle = '#ff0000';
                        ctx.beginPath();
                        ctx.arc(x, y, 5, 0, 2 * Math.PI);
                        ctx.fill();

                        // ç»˜åˆ¶åºå·
                        ctx.fillStyle = '#ffffff';
                        ctx.font = '12px Arial';
                        ctx.fillText(canvas.corners.length, x + 8, y - 8);

                        // å¦‚æœæœ‰4ä¸ªç‚¹ï¼Œç»˜åˆ¶è¿æ¥çº¿
                        if (canvas.corners.length === 4) {
                            ctx.strokeStyle = '#00ff00';
                            ctx.lineWidth = 2;
                            ctx.beginPath();
                            for (let i = 0; i < 4; i++) {
                                const scaledX = canvas.corners[i].x * scale;
                                const scaledY = canvas.corners[i].y * scale;
                                if (i === 0) {
                                    ctx.moveTo(scaledX, scaledY);
                                } else {
                                    ctx.lineTo(scaledX, scaledY);
                                }
                            }
                            ctx.closePath();
                            ctx.stroke();
                        }
                    };
                };
                img.src = data.data.imageUrl;  // ä½¿ç”¨è¿”å›çš„ imageUrl å­—æ®µ

                // æ˜¾ç¤ºæ­¥éª¤2
                document.getElementById('cropAreaStep1').style.display = 'none';
                document.getElementById('cropAreaStep2').style.display = 'block';
            } else {
                showToast('è·å–æˆªå›¾å¤±è´¥: ' + data.message, 'error');
            }
        } catch(e) {
            console.error('Capture error:', e);
            showToast('è·å–æˆªå›¾å¤±è´¥: ' + e.message, 'error');
        }
    }

    function backToCropAreaStep1() {
        document.getElementById('cropAreaStep2').style.display = 'none';
        document.getElementById('cropAreaStep1').style.display = 'block';
    }

    function backToCropAreaStep2() {
        // ç§»é™¤åŠ è½½æç¤ºï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        const loading = document.getElementById('cropAreaLoading');
        if (loading) loading.remove();

        document.getElementById('cropAreaStep3').style.display = 'none';
        document.getElementById('cropAreaStep2').style.display = 'block';
    }

    // é¢„è§ˆè£å‰ªåŒºåŸŸè¯†åˆ«ç»“æœ
    async function previewCropArea() {
        const canvas = document.getElementById('cropAreaCanvas');
        if (!canvas.corners || canvas.corners.length !== 4) {
            showToast('è¯·å…ˆæ¡†é€‰å››ä¸ªè§’', 'error');
            return;
        }

        const toleranceX = parseFloat(document.getElementById('cropAreaToleranceX').value) || 5;
        const toleranceY = parseFloat(document.getElementById('cropAreaToleranceY').value) || 5;

        // è½¬æ¢ corners ä¸º [x1,y1,x2,y2,...] æ ¼å¼
        const corners = [];
        canvas.corners.forEach(c => {
            corners.push(c.x, c.y);
        });

        // ä¿å­˜cornersåˆ°cropAreaPreviewData
        cropAreaPreviewData.corners = canvas.corners;

        try {
            // æ˜¾ç¤ºåŠ è½½æç¤ºï¼ˆä¸ç ´åHTMLï¼‰
            const loadingHtml = `
                <div id="cropAreaLoading" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10;">
                    <div style="font-size: 40px; margin-bottom: 10px;">ğŸ”</div>
                    <div style="color: #666;">æ­£åœ¨è¯†åˆ«è£å‰ªåŒºåŸŸ...</div>
                </div>
            `;
            document.getElementById('cropAreaCanvasContainer').innerHTML += loadingHtml;

            const res = await fetch(`${API_BASE}/api/crop-area-template/preview`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    templateId: cropAreaPreviewData.templateId,
                    corners: corners,
                    toleranceX: toleranceX,
                    toleranceY: toleranceY
                })
            });

            const data = await res.json();

            if (data.success) {
                // æ˜¾ç¤ºæ­¥éª¤3
                showCropAreaPreviewResult(data);
            } else {
                showToast('é¢„è§ˆå¤±è´¥: ' + data.message, 'error');
                backToCropAreaStep2();
            }
        } catch(e) {
            console.error('Preview error:', e);
            showToast('é¢„è§ˆå¤±è´¥: ' + e.message, 'error');
            backToCropAreaStep2();
        }
    }

    function showCropAreaPreviewResult(data) {
        // ç§»é™¤åŠ è½½æç¤º
        const loading = document.getElementById('cropAreaLoading');
        if (loading) loading.remove();

        // ä¸è¦é‡æ–°ç”Ÿæˆæ­¥éª¤2çš„HTMLï¼Œä¿æŒcanvasçŠ¶æ€
        document.getElementById('cropAreaStep2').style.display = 'none';
        document.getElementById('cropAreaStep3').style.display = 'block';

        // ä¿å­˜å½“å‰cornersæ•°æ®
        const canvas = document.getElementById('cropAreaCanvas');
        if (canvas && canvas.corners) {
            cropAreaPreviewData.corners = canvas.corners;
        }

        // æ˜¾ç¤ºè£å‰ªå›¾åƒ
        const imgHtml = `<img src="${data.imageUrl}" style="max-width: 100%; max-height: 300px; border: 1px solid #ddd; border-radius: 4px;">`;
        document.getElementById('cropAreaPreviewContainer').innerHTML = imgHtml;

        // æ˜¾ç¤ºæ£€æµ‹ä¿¡æ¯
        const featureCount = data.features ? data.features.length : 0;
        document.getElementById('cropAreaDetectionInfo').innerHTML = `
            è£å‰ªåŒºåŸŸå°ºå¯¸: ${data.cropWidth || 0} x ${data.cropHeight || 0} |
            æ£€æµ‹åˆ° ${featureCount} ä¸ªç‰¹å¾
        `;

        // æ˜¾ç¤ºç‰¹å¾åˆ—è¡¨
        let featureListHtml = '<div style="font-size: 12px;"><strong>æ£€æµ‹åˆ°çš„ç‰¹å¾ï¼š</strong></div>';
        if (data.features && data.features.length > 0) {
            data.features.forEach((f, idx) => {
                featureListHtml += `<div style="font-size: 11px; color: #666; padding: 2px 0;">
                    ${idx + 1}. ${f.featureName || f.name} (${f.className || '-'}) - ç½®ä¿¡åº¦: ${(f.confidence * 100).toFixed(1)}%
                </div>`;
            });
        }
        document.getElementById('cropAreaFeatureList').innerHTML = featureListHtml;

        // ä¿å­˜å®¹å·®å€¼
        cropAreaPreviewData.toleranceX = parseFloat(document.getElementById('cropAreaToleranceX').value) || 5;
        cropAreaPreviewData.toleranceY = parseFloat(document.getElementById('cropAreaToleranceY').value) || 5;
    }

    // ç¡®è®¤å¹¶åˆ›å»ºè£å‰ªåŒºåŸŸæ¨¡æ¿
    async function confirmCropAreaBuild() {
        if (!cropAreaPreviewData || !cropAreaPreviewData.corners) {
            showToast('æ²¡æœ‰é¢„è§ˆæ•°æ®ï¼Œè¯·é‡æ–°æ“ä½œ', 'error');
            return;
        }

        try {
            // è½¬æ¢ corners ä¸º [x1,y1,x2,y2,...] æ ¼å¼
            const corners = [];
            cropAreaPreviewData.corners.forEach(c => {
                corners.push(c.x, c.y);
            });

            const res = await fetch(`${API_BASE}/api/crop-area-template/save`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    templateId: cropAreaPreviewData.templateId,
                    objectTemplatePath: document.getElementById('cropAreaObjectTemplate').value,
                    corners: corners,
                    toleranceX: cropAreaPreviewData.toleranceX,
                    toleranceY: cropAreaPreviewData.toleranceY
                })
            });

            const data = await res.json();

            if (data.success) {
                closeCropAreaBuildModal();
                await loadTemplates();
                showToast('è£å‰ªåŒºåŸŸæ¨¡æ¿åˆ›å»ºæˆåŠŸï¼');
            } else {
                showToast('åˆ›å»ºå¤±è´¥: ' + data.message, 'error');
            }
        } catch(e) {
            console.error('Build error:', e);
            showToast('åˆ›å»ºå¤±è´¥: ' + e.message, 'error');
        }
    }

    // æ ‡ç­¾é¡µåˆ‡æ¢
    function switchTab(tabName) {
        console.log('switchTab called with:', tabName);
        currentTab = tabName;
        console.log('currentTab is now:', currentTab);

        // æ›´æ–°æ ‡ç­¾é¡µå¤´éƒ¨æ ·å¼
        document.querySelectorAll('.tab-option').forEach(el => {
            el.classList.toggle('active', el.dataset.tab === tabName);
        });

        // æ›´æ–°å†…å®¹æ˜¾ç¤º
        document.querySelectorAll('.tab-content').forEach(el => {
            el.classList.remove('active');
        });
        const targetContent = document.getElementById(tabName + 'TabContent');
        if (targetContent) {
            targetContent.classList.add('active');
        }

        // åŠ è½½å¯¹åº”æ ‡ç­¾é¡µçš„æ•°æ®
        if (tabName === 'template') {
            loadTemplates();
        }
    }

    // --- æ‹¼æ¥é…ç½® ---
    async function updateStitchStatus() {
        try {
            const res = await fetch(`${API_BASE}/api/stitch/config`);
            const data = await res.json();
            if(data.status === 'success') {
                const strategyEl = document.getElementById('currentStrategy');
                strategyEl.textContent = 'MANUAL';
                document.getElementById('stitchStatus').classList.add('manual');
            }
        } catch(e) {}
    }

    async function openSystemConfigModal() {
        document.getElementById('systemConfigModal').style.display = 'block';
        isPreviewMode = true;

        // é‡ç½®ä¸ºæ‹¼æ¥è®¾ç½®æ ‡ç­¾é¡µ
        currentTab = 'stitch';
        switchTab('stitch');

        // åŠ è½½æ‰‹åŠ¨é…ç½®
        loadManualConfigs();
    }

    function closeSystemConfigModal() {
        document.getElementById('systemConfigModal').style.display = 'none';
        isPreviewMode = false;
    }

    async function loadManualConfigs() {
        try {
            const res = await fetch(`${API_BASE}/api/stitch/manual`);
            const data = await res.json();
            if(data.status === 'success' && data.data.cameras) {
                renderCameraConfigs(data.data.cameras);
            }
        } catch(e) {}
    }

    function renderCameraConfigs(cameras) {
        const container = document.getElementById('cameraConfigsContainer');
        container.innerHTML = '';

        cameras.forEach(cam => {
            const config = manualConfigs[cam.index] || {
                x1: cam.x1 !== undefined ? cam.x1 : 0,
                x2: cam.x2 !== undefined ? cam.x2 : 1368,
                y: cam.y !== undefined ? cam.y : 0,
                h: cam.h !== undefined ? cam.h : 912
            };
            manualConfigs[cam.index] = config;

            const item = document.createElement('div');
            item.className = 'camera-config-item';
            item.innerHTML = `
                <div class="camera-title">æ‘„åƒå¤´ ${cam.index}</div>
                <div class="param-grid">
                    <div class="param-item">
                        <label>ğŸ”ª å·¦åˆ‡å‰²çº¿ (x1)</label>
                        <div class="range-wrapper">
                            <input type="range" min="0" max="1500" value="${config.x1}"
                                oninput="updateParam(${cam.index}, 'x1', parseInt(this.value)); updateRangeDisplay(this)">
                            <span class="range-value">${config.x1}</span>
                        </div>
                        <small style="color: #999; font-size: 10px;">ä¿ç•™ä» x1 åˆ°å³ä¾§çš„åŒºåŸŸï¼ˆå·¦è¾¹ç•Œï¼‰</small>
                    </div>
                    <div class="param-item">
                        <label>ğŸ”ª å³åˆ‡å‰²çº¿ (x2)</label>
                        <div class="range-wrapper">
                            <input type="range" min="0" max="1500" value="${config.x2}"
                                oninput="updateParam(${cam.index}, 'x2', parseInt(this.value)); updateRangeDisplay(this)">
                            <span class="range-value">${config.x2}</span>
                        </div>
                        <small style="color: #999; font-size: 10px;">ä¿ç•™ä»å·¦ä¾§åˆ° x2 çš„åŒºåŸŸï¼ˆå³è¾¹ç•Œï¼‰</small>
                    </div>
                    <div class="param-item">
                        <label>â¬‡ï¸ èµ·å§‹è¡Œ (y)</label>
                        <div class="range-wrapper">
                            <input type="range" min="0" max="1000" value="${config.y}"
                                oninput="updateParam(${cam.index}, 'y', parseInt(this.value)); updateRangeDisplay(this)">
                            <span class="range-value">${config.y}</span>
                        </div>
                        <small style="color: #999; font-size: 10px;">ä»é¡¶éƒ¨å¼€å§‹è£åˆ‡çš„è¡Œæ•°ï¼ˆå¤„ç†ä¸Šä¸‹åç§»ï¼‰</small>
                    </div>
                    <div class="param-item">
                        <label="ğŸ“ æˆªå–é«˜åº¦ (h)</label>
                        <div class="range-wrapper">
                            <input type="range" min="100" max="4000" value="${config.h}"
                                oninput="updateParam(${cam.index}, 'h', parseInt(this.value)); updateRangeDisplay(this)">
                            <span class="range-value">${config.h}</span>
                        </div>
                        <small style="color: #999; font-size: 10px;">ä»èµ·å§‹è¡Œå¼€å§‹å‘ä¸‹æˆªå–çš„åƒç´ æ•°</small>
                    </div>
                </div>
            `;
            container.appendChild(item);
        });
    }

    function updateRangeDisplay(input) {
        const display = input.nextElementSibling;
        const val = input.type === 'range' && input.step === '0.01' ? parseFloat(input.value).toFixed(2) : input.value;
        display.textContent = val;
    }

    function updateParam(cameraIndex, param, value) {
        if(!manualConfigs[cameraIndex]) {
            manualConfigs[cameraIndex] = {
                x1: 0,
                x2: 1368,
                y: 0,
                h: 912
            };
        }
        manualConfigs[cameraIndex][param] = value;
    }

    async function saveStitchConfig() {
        try {
            const configs = Object.entries(manualConfigs).map(([index, config]) => ({
                index: parseInt(index),
                x1: config.x1,
                x2: config.x2,
                y: config.y,
                h: config.h
            }));

            const res = await fetch(`${API_BASE}/api/stitch/manual/batch`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cameras: configs })
            });

            const data = await res.json();
            if(data.status === 'success') {
                showToast('æ‹¼æ¥é…ç½®å·²ä¿å­˜');
            } else {
                showToast(data.message, 'error');
            }
        } catch(e) {
            showToast('ä¿å­˜å¤±è´¥: ' + e.message, 'error');
        }
    }

    async function saveCurrentConfig() {
        console.log('saveCurrentConfig called, currentTab =', currentTab);
        if (currentTab === 'stitch') {
            console.log('Saving stitch config');
            await saveStitchConfig();
        } else {
            console.warn('Unknown tab:', currentTab);
        }
    }

    async function resetManualConfig() {
        try {
            const res = await fetch(`${API_BASE}/api/stitch/manual/reset`, { method: 'POST' });
            const data = await res.json();
            if(data.status === 'success') {
                manualConfigs = {};
                loadManualConfigs();
                showToast('æ‹¼æ¥é…ç½®å·²é‡ç½®');
            }
        } catch(e) { showToast('é‡ç½®å¤±è´¥', 'error'); }
    }

    async function resetCurrentConfig() {
        if (currentTab === 'stitch') {
            await resetManualConfig();
        } else if (currentTab === 'template') {
            // Template tab doesn't have a reset function
            showToast('æ¨¡æ¿ç®¡ç†ä¸éœ€è¦é‡ç½®', 'warning');
        }
    }

    // é¡µé¢åŠ è½½æ—¶æ›´æ–°æ‹¼æ¥çŠ¶æ€
    updateStitchStatus();

    // é¡µé¢åŠ è½½æ—¶åŠ è½½å½“å‰å»ºæ¨¡æ–¹å¼
    loadMatchStrategy();

    // ESC å…³é—­æ¨¡æ€æ¡†
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeModal();
            closeSystemConfigModal();
            closeImagePreview();
        }
    });
</script>
</body>
</html>
