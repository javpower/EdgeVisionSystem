<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¾¹ç¼˜è§†è§‰æ£€æµ‹ç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        h1 { text-align: center; color: white; margin-bottom: 30px; font-size: 2.5rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .control-panel { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }
        .btn { padding: 12px 24px; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-block; text-align: center; }
        .btn-primary { background: #4CAF50; color: white; }
        .btn-primary:hover { background: #45a049; }
        .btn-secondary { background: #2196F3; color: white; }
        .btn-secondary:hover { background: #1976D2; }
        .btn-danger { background: #f44336; color: white; }
        .btn-danger:hover { background: #da190b; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .status { padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600; }
        .status.running { background: #d4edda; color: #155724; }
        .status.stopped { background: #f8d7da; color: #721c24; }
        .video-container { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .video-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-top: 15px; }
        .video-item { border: 2px solid #e0e0e0; border-radius: 8px; overflow: hidden; background: #f5f5f5; }
        .video-item img { width: 100%; height: 300px; object-fit: cover; }
        .video-label { padding: 10px; background: #333; color: white; text-align: center; font-weight: 600; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 5% auto; padding: 0; border-radius: 10px; width: 90%; max-width: 600px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); animation: modalSlideIn 0.3s ease; }
        @keyframes modalSlideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { background: #667eea; color: white; padding: 20px; border-radius: 10px 10px 0 0; }
        .modal-body { padding: 30px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-group input { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 16px; transition: border-color 0.3s ease; }
        .form-group input:focus { outline: none; border-color: #667eea; }
        .preview-image { width: 100%; max-height: 300px; object-fit: contain; border: 2px solid #e0e0e0; border-radius: 6px; margin-bottom: 20px; }
        .result-section { background: white; border-radius: 10px; padding: 20px; margin-top: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none; }
        .quality-status { font-size: 24px; font-weight: bold; text-align: center; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .quality-status.pass { background: #d4edda; color: #155724; }
        .quality-status.fail { background: #f8d7da; color: #721c24; }
        .defect-list { list-style: none; padding: 0; }
        .defect-item { background: #f8f9fa; padding: 15px; margin-bottom: 10px; border-radius: 6px; border-left: 4px solid #dc3545; }
        .defect-item .defect-name { font-weight: 600; color: #dc3545; }
        .defect-item .defect-score { color: #666; font-size: 14px; }
        .loading { display: none; text-align: center; padding: 40px; }
        .loading::after { content: ""; display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .stat-value { font-size: 2rem; font-weight: bold; color: #667eea; }
        .stat-label { color: #666; margin-top: 5px; }
    </style>
</head>
<body>
<div class="container">
    <h1>è¾¹ç¼˜è§†è§‰æ£€æµ‹ç³»ç»Ÿ</h1>

    <div class="control-panel">
        <button class="btn btn-primary" onclick="startCamera()" id="startBtn">å¯åŠ¨æ‘„åƒå¤´</button>
        <button class="btn btn-danger" onclick="stopCamera()" id="stopBtn" disabled>åœæ­¢æ‘„åƒå¤´</button>
        <button class="btn btn-secondary" onclick="startPreCheck()" id="inspectBtn" disabled>å¼€å§‹æ£€æµ‹</button>
        <div class="status stopped" id="cameraStatus">æ‘„åƒå¤´å·²åœæ­¢</div>
    </div>

    <div class="video-container">
        <h2>å®æ—¶è§†é¢‘é¢„è§ˆ</h2>
        <div class="video-grid" id="videoGrid">
        </div>
    </div>

    <div class="loading" id="loading">æ­£åœ¨å¤„ç†...</div>

    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>è¯·ç¡®è®¤å·¥ä»¶ä¿¡æ¯</h2>
            </div>
            <div class="modal-body">
                <img id="preview-image" class="preview-image" src="" alt="é¢„è§ˆå›¾">

                <div class="form-group">
                    <label for="part-name">å·¥ä»¶åç§°</label>
                    <input type="text" id="part-name" placeholder="è¯·è¾“å…¥å·¥ä»¶åç§°">
                </div>

                <div class="form-group">
                    <label for="batch-id">æ‰¹æ¬¡å·</label>
                    <input type="text" id="batch-id" placeholder="è¯·è¾“å…¥æ‰¹æ¬¡å·">
                </div>

                <div class="form-group">
                    <label for="operator">æ“ä½œå‘˜</label>
                    <input type="text" id="operator" placeholder="è¯·è¾“å…¥æ“ä½œå‘˜å§“å">
                </div>

                <div style="display: flex; gap: 15px; margin-top: 30px;">
                    <button class="btn btn-primary" onclick="confirmInspection()" style="flex: 1;">ç¡®è®¤å¹¶æ£€æµ‹</button>
                    <button class="btn btn-secondary" onclick="closeModal()" style="flex: 1;">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <div class="result-section" id="resultSection">
        <h2>æ£€æµ‹ç»“æœ</h2>
        <div class="quality-status" id="qualityStatus"></div>
        <img id="result-image" style="width: 100%; max-height: 500px; object-fit: contain; border-radius: 8px; margin-bottom: 20px;" src="" alt="ç»“æœå›¾">
        <div id="defect-details"></div>
        <button class="btn btn-secondary" onclick="resetInspection()" style="margin-top: 20px;">é‡æ–°æ£€æµ‹</button>
    </div>

    <div class="stats">
        <div class="stat-card">
            <div class="stat-value" id="cameraCount">0</div>
            <div class="stat-label">æ‘„åƒå¤´æ•°é‡</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="totalRecords">0</div>
            <div class="stat-label">æ€»æ£€æµ‹è®°å½•</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="uploadedRecords">0</div>
            <div class="stat-label">å·²ä¸Šä¼ è®°å½•</div>
        </div>
    </div>
</div>

<script>
        const API_BASE = '';
        let requestId = null;
        let streamInterval = null;

        // é¡µé¢åŠ è½½æ—¶è·å–çŠ¶æ€
        window.onload = function() {
            updateStats();
            setInterval(updateStats, 5000); // æ¯5ç§’æ›´æ–°ä¸€æ¬¡ç»Ÿè®¡
        };

        // å¯åŠ¨æ‘„åƒå¤´
        async function startCamera() {
            try {
                document.getElementById('loading').style.display = 'block';

                const response = await fetch(`${API_BASE}/api/camera/start`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.status === 'success') {
                    document.getElementById('cameraStatus').textContent = `æ‘„åƒå¤´è¿è¡Œä¸­ (${data.cameraCount}ä¸ª)`;
                    document.getElementById('cameraStatus').className = 'status running';
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                    document.getElementById('inspectBtn').disabled = false;
                    document.getElementById('cameraCount').textContent = data.cameraCount;

                    // å¼€å§‹æ˜¾ç¤ºè§†é¢‘æµ
                    startVideoStream();
                } else {
                    alert('å¯åŠ¨å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                alert('å¯åŠ¨æ‘„åƒå¤´å¤±è´¥: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // åœæ­¢æ‘„åƒå¤´
        async function stopCamera() {
            try {
                const response = await fetch(`${API_BASE}/api/camera/stop`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.status === 'success') {
                    document.getElementById('cameraStatus').textContent = 'æ‘„åƒå¤´å·²åœæ­¢';
                    document.getElementById('cameraStatus').className = 'status stopped';
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('stopBtn').disabled = true;
                    document.getElementById('inspectBtn').disabled = true;

                    // åœæ­¢è§†é¢‘æµ
                    stopVideoStream();
                }
            } catch (error) {
                alert('åœæ­¢æ‘„åƒå¤´å¤±è´¥: ' + error.message);
            }
        }

        // å¼€å§‹è§†é¢‘æµ - åŠ¨æ€åˆ›å»ºå¤šä¸ªæ‘„åƒå¤´è§†é¢‘æµ
        async function startVideoStream() {
            try {
                // è·å–æ‘„åƒå¤´çŠ¶æ€
                const statusResponse = await fetch(`${API_BASE}/api/camera/status`);
                const statusData = await statusResponse.json();

                if (statusData.status === 'success') {
                    const cameraCount = statusData.data.cameraCount;
                    const videoGrid = document.getElementById('videoGrid');
                    videoGrid.innerHTML = ''; // æ¸…ç©ºç°æœ‰å†…å®¹

                    // æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
                    const timestamp = new Date().getTime();

                    // ä¸ºæ¯ä¸ªæ‘„åƒå¤´åˆ›å»ºè§†é¢‘æµ
                    for (let i = 0; i < cameraCount; i++) {
                        const videoItem = document.createElement('div');
                        videoItem.className = 'video-item';

                        const img = document.createElement('img');
                        img.id = `camera-stream-${i}`;
                        img.src = `${API_BASE}/api/camera/stream/${i}?t=${timestamp}`;
                        img.alt = `æ‘„åƒå¤´ ${i}`;
                        img.style.display = 'block';

                        img.onerror = function() {
                            console.log(`Camera ${i} stream connection lost`);
                        };

                        const label = document.createElement('div');
                        label.className = 'video-label';
                        label.textContent = `æ‘„åƒå¤´ ${i}`;

                        videoItem.appendChild(img);
                        videoItem.appendChild(label);
                        videoGrid.appendChild(videoItem);
                    }
                }
            } catch (error) {
                console.error('Failed to start video streams:', error);
            }
        }

        // åœæ­¢è§†é¢‘æµ
        function stopVideoStream() {
            const videoGrid = document.getElementById('videoGrid');
            videoGrid.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">æ‘„åƒå¤´å·²åœæ­¢</p>';
        }

        // å¼€å§‹é¢„æ£€
        async function startPreCheck() {
            try {
                document.getElementById('loading').style.display = 'block';

                const response = await fetch(`${API_BASE}/api/inspect/pre-check`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.status === 'success') {
                    const preCheckData = data.data;
                    requestId = preCheckData.requestId;

                    // æ˜¾ç¤ºé¢„è§ˆå›¾
                    document.getElementById('preview-image').src = preCheckData.preview_image;

                    // å¦‚æœè¯†åˆ«å‡ºäº†ç±»å‹ï¼Œè‡ªåŠ¨å¡«å……
                    if (preCheckData.suggested_type) {
                        document.getElementById('part-name').value = preCheckData.suggested_type;
                    }

                    // æ˜¾ç¤ºæ¨¡æ€æ¡†
                    document.getElementById('confirmModal').style.display = 'block';
                } else {
                    alert('é¢„æ£€å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                alert('é¢„æ£€å¤±è´¥: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // ç¡®è®¤æ£€æµ‹
        async function confirmInspection() {
            const partName = document.getElementById('part-name').value.trim();
            const batchId = document.getElementById('batch-id').value.trim();
            const operator = document.getElementById('operator').value.trim();

            if (!partName || !batchId) {
                alert('è¯·å¡«å†™å·¥ä»¶åç§°å’Œæ‰¹æ¬¡å·');
                return;
            }

            try {
                document.getElementById('loading').style.display = 'block';

                const response = await fetch(`${API_BASE}/api/inspect/confirm`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        request_id: requestId,
                        confirmed_part_name: partName,
                        batch_id: batchId,
                        operator: operator
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    closeModal();
                    showResults(data.data);
                } else {
                    alert('æ£€æµ‹å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                alert('æ£€æµ‹å¤±è´¥: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // === ğŸ”´ æ ¸å¿ƒä¿®å¤ï¼šä¿®å¤å­—æ®µåä¸åŒ¹é…çš„é—®é¢˜ ===
        function showResults(data) {
            const resultSection = document.getElementById('resultSection');
            const qualityStatus = document.getElementById('qualityStatus');
            const resultImage = document.getElementById('result-image');
            const defectDetails = document.getElementById('defect-details');

            // 1. çŠ¶æ€åˆ¤æ–­
            const isPass = data.analysis.quality_status === 'PASS';
            qualityStatus.textContent = isPass ? 'è´¨æ£€é€šè¿‡' : 'è´¨æ£€ä¸é€šè¿‡';
            qualityStatus.className = 'quality-status ' + (isPass ? 'pass' : 'fail');

            // 2. æ˜¾ç¤ºç»“æœå›¾
            resultImage.src = data.result_image;

            // 3. æ„å»ºè¯¦ç»†ä¿¡æ¯
            let detailsHtml = `
                <h3>æ£€æµ‹è¯¦æƒ…</h3>
                <p><strong>å·¥ä»¶åç§°:</strong> ${data.batch_info.part_name}</p>
                <p><strong>æ‰¹æ¬¡å·:</strong> ${data.batch_info.batch_id}</p>
                <p><strong>æ“ä½œå‘˜:</strong> ${data.batch_info.operator || 'æœªå¡«å†™'}</p>
                <p><strong>ç¼ºé™·æ•°é‡:</strong> ${data.analysis.defect_count}</p>
            `;

            // 4. æ„å»ºç¼ºé™·åˆ—è¡¨ (ä¿®å¤ undefined é—®é¢˜)
            if (data.analysis.details && data.analysis.details.length > 0) {
                detailsHtml += '<h4 style="margin-top: 20px;">ç¼ºé™·åˆ—è¡¨:</h4><ul class="defect-list">';
                data.analysis.details.forEach(defect => {
                    // åç«¯è¿”å›çš„æ˜¯: label å’Œ confidence
                    // ä¹‹å‰çš„ä»£ç å†™æˆäº†: class_name å’Œ score
                    const labelName = defect.label || 'Unknown';
                    const scoreVal = defect.confidence !== undefined ? defect.confidence : 0;

                    detailsHtml += `
                        <li class="defect-item">
                            <div class="defect-name">${labelName}</div>
                            <div class="defect-score">ç½®ä¿¡åº¦: ${(scoreVal * 100).toFixed(1)}%</div>
                        </li>
                    `;
                });
                detailsHtml += '</ul>';
            } else if (!isPass) {
                // å¦‚æœFAILä½†æ²¡æœ‰details (å¯èƒ½å¼‚å¸¸æƒ…å†µ)
                detailsHtml += '<p style="color:red; margin-top:10px;">æ£€æµ‹åˆ°å¼‚å¸¸ï¼Œä½†æœªè·å–åˆ°è¯¦ç»†ç¼ºé™·ä¿¡æ¯ã€‚</p>';
            }

            defectDetails.innerHTML = detailsHtml;

            // 5. æ˜¾ç¤ºåŒºåŸŸå¹¶æ»šåŠ¨
            resultSection.style.display = 'block';
            resultSection.scrollIntoView({ behavior: 'smooth' });

            // 6. æ›´æ–°ç»Ÿè®¡
            updateStats();
        }

        // é‡ç½®æ£€æµ‹
        function resetInspection() {
            document.getElementById('resultSection').style.display = 'none';
            document.getElementById('part-name').value = '';
            document.getElementById('batch-id').value = '';
            document.getElementById('operator').value = '';
            requestId = null;
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('confirmModal').style.display = 'none';
            document.getElementById('part-name').value = '';
            document.getElementById('batch-id').value = '';
            document.getElementById('operator').value = '';
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        async function updateStats() {
            try {
                const response = await fetch(`${API_BASE}/api/inspect/stats`);
                const data = await response.json();

                if (data.status === 'success') {
                    document.getElementById('cameraCount').textContent = data.data.cameraCount || 0;
                    document.getElementById('totalRecords').textContent = data.data.totalRecords || 0;
                    document.getElementById('uploadedRecords').textContent = data.data.uploadedRecords || 0;
                }
            } catch (error) {
                console.error('Failed to update stats:', error);
            }
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('confirmModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // é”®ç›˜äº‹ä»¶
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });
    </script>
</body>
</html>