<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EdgeVision Pro | 智能视觉工作台</title>
    <style>
        :root {
            --sidebar-bg: #001529;
            --sidebar-width: 220px;
            --primary-color: #1890ff;
            --bg-body: #f0f2f5;
            --header-height: 48px;
            --card-radius: 8px;
            --success-color: #52c41a;
            --warning-color: #faad14;
            --danger-color: #ff4d4f;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-body);
            height: 100vh;
            display: flex;
            overflow: hidden;
            color: #333;
        }

        aside {
            width: var(--sidebar-width);
            background: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
            color: rgba(255,255,255,0.65);
            z-index: 10;
            box-shadow: 2px 0 8px rgba(0,0,0,0.15);
        }

        .brand {
            height: 60px;
            display: flex;
            align-items: center;
            padding-left: 20px;
            font-size: 18px;
            font-weight: 700;
            color: white;
            letter-spacing: 1px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .brand span { color: var(--primary-color); }

        .menu { flex: 1; padding: 20px 10px; display: flex; flex-direction: column; gap: 12px; overflow-y: auto; }
        .menu-label { font-size: 12px; margin-bottom: 5px; padding-left: 10px; text-transform: uppercase; opacity: 0.5; }

        .ctrl-btn {
            background: rgba(255,255,255,0.08);
            border: none;
            color: white;
            padding: 12px 15px;
            border-radius: 6px;
            cursor: pointer;
            text-align: left;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }
        .ctrl-btn:hover:not(:disabled) { background: var(--primary-color); color: white; transform: translateX(5px); }
        .ctrl-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .ctrl-btn.stop:hover:not(:disabled) { background: #ff4d4f; }

        .stitch-status {
            background: rgba(255,255,255,0.05);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 12px;
        }
        .stitch-status .status-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .stitch-status .status-label { opacity: 0.7; }
        .stitch-status .status-value { color: var(--primary-color); font-weight: 600; }
        .stitch-status.manual .status-value { color: var(--warning-color); }

        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        header {
            height: var(--header-height);
            background: white;
            border-bottom: 1px solid #e8e8e8;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            font-size: 13px;
            color: #666;
            flex-shrink: 0;
        }

        .workspace {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow: hidden;
            min-height: 0;
        }

        /* 全景 Canvas 监控区 (前端拼接) */
        .panorama-section {
            background: black;
            border-radius: var(--card-radius);
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid #333;
            flex: 0 0 calc((100vh - var(--header-height) - 40px - 40px) * 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 300px;
        }

        .panorama-canvas {
            max-width: 100%;
            max-height: 60vh;
            object-fit: contain;
        }

        .panorama-overlay {
            position: absolute; top: 15px; left: 15px;
            background: rgba(0,0,0,0.7); color: #fff;
            padding: 8px 15px; border-radius: 6px; font-size: 13px;
            display: flex; align-items: center; gap: 10px;
            backdrop-filter: blur(5px);
            z-index: 10;
        }
        .rec-dot { width: 10px; height: 10px; background: #52c41a; border-radius: 50%; box-shadow: 0 0 8px #52c41a; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .panorama-placeholder {
            color: #666; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .panorama-placeholder span { font-size: 28px; opacity: 0.4; }
        .panorama-placeholder p { font-size: 13px; margin-top: 10px; opacity: 0.3; }

        /* 结果面板 */
        .result-section {
            flex: 1;
            background: white;
            border-radius: var(--card-radius);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #e8e8e8;
            min-height: 0;
        }

        .panel-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            min-height: 0;
        }

        .panel-header {
            padding: 15px 24px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fafafa;
        }

        .btn-complete {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s;
        }
        .btn-complete:hover {
            background: #73d13d;
        }

        .panel-title {
            font-size: 16px;
            font-weight: 700;
            color: #333;
            border-left: 4px solid var(--primary-color);
            padding-left: 12px;
        }

        /* 质检状态标签 */
        .status-tag {
            font-size: 16px;
            font-weight: 700;
            padding: 8px 20px;
            border-radius: 24px;
            letter-spacing: 0.5px;
        }
        .status-tag.waiting {
            background: #f5f5f5;
            color: #999;
        }
        .status-tag.pass {
            background: linear-gradient(135deg, #52c41a 0%, #73d13d 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(82, 196, 26, 0.3);
        }
        .status-tag.fail {
            background: linear-gradient(135deg, #ff4d4f 0%, #ff7875 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(255, 77, 79, 0.3);
            animation: pulse-fail 1.5s infinite;
        }
        @keyframes pulse-fail {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* 模板比对状态样式 */
        .status-pass {
            color: #52c41a;
            font-weight: 600;
        }
        .status-fail {
            color: #ff4d4f;
            font-weight: 600;
        }
        .status-missing {
            color: #faad14;
            font-weight: 600;
        }
        .status-extra {
            color: #722ed1;
            font-weight: 600;
        }
        .status-type-mismatch {
            color: #eb2f96;
            font-weight: 600;
        }

        .result-view {
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }

        .result-image {
            flex: 0 0 auto;
            background: #f7f9fa;
            border-radius: 8px;
            padding: 10px;
            display: inline-block;
            max-width: 240px;
        }

        .result-image img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 4px;
            cursor: zoom-in;
            box-shadow: 0 2px 12px rgba(0,0,0,0.15);
            display: block;
        }

        .result-info {
            flex: 1;
            min-width: 0;
        }

        .batch-info-bar {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 15px;
        }
        .info-card {
            background: #f8faff;
            border: 1px solid #d6e4ff;
            padding: 10px 12px;
            border-radius: 6px;
        }
        .info-card label {
            display: block;
            font-size: 11px;
            color: #85a5ff;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .info-card .val {
            font-size: 14px;
            font-weight: 700;
            color: #003a8c;
        }

        /* 统计信息样式 */
        .summary-stats {
            margin-bottom: 20px;
        }
        .summary-title {
            font-size: 13px;
            color: #999;
            font-weight: 500;
            margin-bottom: 12px;
        }
        .summary-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .summary-card {
            display: flex;
            align-items: baseline;
            gap: 6px;
            padding: 8px 14px;
            background: #f5f5f5;
            border-radius: 20px;
            border: 1px solid #e8e8e8;
        }
        .summary-type {
            font-size: 13px;
            color: #666;
        }
        .summary-count {
            font-size: 18px;
            font-weight: 700;
            color: #1890ff;
        }
        .no-defects {
            color: #52c41a;
            font-size: 14px;
            padding: 8px 14px;
            background: #f6ffed;
            border-radius: 20px;
            border: 1px solid #b7eb8f;
            display: inline-block;
        }

        .table-container { border: 1px solid #f0f0f0; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; padding: 10px 12px; color: #999; font-weight: 500; font-size: 11px; background: #fafafa; border-bottom: 1px solid #eee; }
        td { padding: 8px 12px; border-bottom: 1px solid #f5f5f5; }
        tr:hover td { background: #fff7e6; }
        tr[data-index] td { transition: background 0.2s; }

        .empty-state {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 40px; color: #999; font-size: 13px;
        }

        /* Modal - 底部滑入，更宽更低（拼接设置用） */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .modal-card.bottom-panel {
            background: white;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            max-height: 40vh;
            border-radius: 12px;
            box-shadow: 0 -5px 40px rgba(0,0,0,0.2);
            overflow: hidden;
            animation: slideInUp 0.3s;
            display: flex;
            flex-direction: column;
            width: 90%;
            max-width: 900px;
        }
        @keyframes slideInUp { from { transform: translate(-50%, 100%); } to { transform: translate(-50%, 0); } }

        /* 检测确认模态框 - 居中大尺寸 */
        .modal-card.center-dialog {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 500px;
            background: white;
            max-height: 90vh;
            border-radius: 8px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
            overflow: hidden;
            animation: fadeIn 0.3s;
            display: flex;
            flex-direction: column;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translate(-50%, -50%) scale(0.95); } to { opacity: 1; transform: translate(-50%, -50%) scale(1); } }

        .modal-header {
            padding: 16px 20px;
            background: #fbfbfb;
            border-bottom: 1px solid #eee;
            font-weight: 600;
            font-size: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .modal-close {
            background: none; border: none;
            font-size: 24px; cursor: pointer;
            color: #999; width: 30px; height: 30px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 4px;
        }
        .modal-close:hover { background: #f0f0f0; }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
            max-height: calc(40vh - 100px);
        }
        .modal-card.center-dialog .modal-body {
            max-height: none;
            overflow-y: visible;
        }
        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid #eee;
            background: #fbfbfb;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            flex-shrink: 0;
        }

        /* 小屏幕适配 */
        @media (max-width: 768px) {
            .modal-card.bottom-panel {
                width: 95%;
                max-height: 60vh;
                bottom: 10px;
            }
            .modal-card.bottom-panel .modal-body {
                max-height: calc(60vh - 100px);
            }
            .modal-card.center-dialog {
                width: 90%;
            }
        }

        .form-item { margin-bottom: 15px; }
        .form-item label { display: block; font-size: 12px; color: #666; margin-bottom: 5px; }
        .form-item input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }

        /* 拼接配置样式 */
        .strategy-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        .strategy-option {
            flex: 1;
            padding: 10px 8px;
            border: 2px solid #e8e8e8;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .strategy-option:hover { border-color: var(--primary-color); background: #f0f9ff; }
        .strategy-option.active {
            border-color: var(--primary-color);
            background: #e6f7ff;
        }
        .strategy-option .name { font-weight: 600; font-size: 13px; }
        .strategy-option .desc { font-size: 10px; color: #999; }

        .manual-config-section {
            background: #fffbf0;
            border: 1px solid #ffe58f;
            border-radius: 6px;
            padding: 14px;
            margin-bottom: 16px;
        }
        .manual-config-section .section-title {
            font-size: 13px;
            font-weight: 600;
            color: #d46b08;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .manual-config-section .section-title .live-indicator {
            width: 8px; height: 8px;
            background: #52c41a;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        .camera-config-item {
            background: white;
            border: 1px solid #e8e8e8;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
        }
        .camera-config-item .camera-title {
            font-weight: 600;
            font-size: 12px;
            color: #333;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f0f0f0;
        }

        .param-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .param-item label {
            font-size: 11px;
            color: #999;
            margin-bottom: 4px;
            display: block;
        }
        .param-item input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e8e8e8;
            outline: none;
            -webkit-appearance: none;
        }
        .param-item input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
        }

        .range-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .range-wrapper input[type="range"] { flex: 1; }
        .range-wrapper .range-value {
            min-width: 45px;
            text-align: right;
            font-size: 11px;
            color: #666;
            font-weight: 600;
        }

        .preview-note {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            border-radius: 6px;
            padding: 10px 12px;
            font-size: 12px;
            color: #0050b3;
            margin-bottom: 15px;
        }

        .btn {
            padding: 10px 18px; border: none; border-radius: 4px; cursor: pointer;
            font-size: 14px; font-weight: 500; transition: all 0.3s;
        }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-primary:hover { background: #40a9ff; }
        .btn-secondary { background: #f5f5f5; color: #666; }
        .btn-secondary:hover { background: #e8e8e8; }
        .btn-success { background: var(--success-color); color: white; }
        .btn-success:hover { background: #73d13d; }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 12px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 3000;
            display: none;
        }
        .toast.success { border-left: 4px solid var(--success-color); }
        .toast.error { border-left: 4px solid var(--danger-color); }
        .toast.warning { border-left: 4px solid var(--warning-color); }

        .hidden { display: none !important; }

        /* 系统设置标签页样式 */
        .tab-header {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            border-bottom: 1px solid #e8e8e8;
        }
        .tab-option {
            flex: 1;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 2px solid transparent;
            font-weight: 500;
            color: #666;
        }
        .tab-option:hover {
            color: var(--primary-color);
        }
        .tab-option.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* 质检标准配置样式 */
        .quality-standards-section {
            background: #f0f9ff;
            border: 1px solid #91d5ff;
            border-radius: 6px;
            padding: 14px;
            margin-bottom: 16px;
        }
        .quality-standards-section .section-title {
            font-size: 13px;
            font-weight: 600;
            color: #0050b3;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .part-type-item {
            background: white;
            border: 1px solid #e8e8e8;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
        }
        .part-type-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f0f0f0;
        }
        .part-type-name {
            font-weight: 600;
            font-size: 13px;
            color: #333;
        }
        .defect-standard-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #fafafa;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        .defect-type-input {
            flex: 2;
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }
        .operator-select {
            flex: 1;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            background: white;
        }
        .threshold-input {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            width: 60px;
        }
        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #999;
            padding: 4px 8px;
            border-radius: 4px;
        }
        .btn-icon:hover {
            color: #ff4d4f;
            background: #fff1f0;
        }
        .btn-add {
            font-size: 12px;
            padding: 6px 12px;
            background: #e6f7ff;
            color: #1890ff;
            border: 1px dashed #1890ff;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
        }
        .btn-add:hover {
            background: #bae7ff;
        }
    </style>
</head>
<body>

<aside>
    <div class="brand">
        EDGE<span>VISION</span>
    </div>

    <div class="menu">
        <div class="menu-label">Device Control</div>
        <button class="ctrl-btn" onclick="startCamera()" id="startBtn">
            ▶ 启动监控
        </button>
        <button class="ctrl-btn stop" onclick="stopCamera()" id="stopBtn" disabled>
            ⏹ 停止监控
        </button>

        <div class="stitch-status" id="stitchStatus">
            <div class="status-row">
                <span class="status-label">拼接策略:</span>
                <span class="status-value" id="currentStrategy">-</span>
            </div>
        </div>

        <div class="menu-label" style="margin-top: 20px;">Inspection</div>
        <button class="ctrl-btn" onclick="startPreCheck()" id="inspectBtn" disabled>
            ◎ 开始检测
        </button>
    </div>

    <div style="padding: 20px; margin-top: auto;">
        <button class="ctrl-btn" onclick="openSystemConfigModal()" id="systemConfigBtn" style="width: 100%; opacity: 0.5;">
            ⚙ 系统设置
        </button>
    </div>
</aside>

<main>
    <header>
        <div><b>工作台</b> / 实时监控与分析</div>
        <div id="clock">00:00:00</div>
    </header>

    <div class="workspace">
        <!-- 全景 Canvas 监控区 (前端拼接) -->
        <div class="panorama-section">
            <div class="panorama-placeholder" id="panoramaPlaceholder">
                <span>OFFLINE</span>
                <p>点击左侧"启动监控"查看拼接画面</p>
            </div>
            <canvas id="panoramaCanvas" class="panorama-canvas" style="display: none;"></canvas>
            <div class="panorama-overlay" id="panoramaOverlay" style="display: none;">
                <div class="rec-dot"></div>
                <span>实时画面</span>
            </div>
        </div>

        <!-- 检测结果区 -->
        <div class="result-section">
            <div class="panel-header">
                <div class="panel-title">检测结果分析</div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div id="status-tag" class="status-tag waiting">等待检测</div>
                    <button id="completeBtn" class="btn-complete" style="display: none;" onclick="clearResults()">检查完成</button>
                </div>
            </div>
            <div class="panel-body" id="result-panel-body">
                <div class="empty-state">
                    <p>暂无检测数据，请点击左侧 "开始检测"</p>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- 检测确认模态框 -->
<div id="confirmModal" class="modal">
    <div class="modal-card center-dialog">
        <div class="modal-header">
            <span>检测参数确认</span>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <img id="preview-image" style="width: 100%; height: 180px; object-fit: contain; background: #333; border-radius: 4px; margin-bottom: 20px;" src="">
            <div class="form-item">
                <label>工件名称</label>
                <input type="text" id="part-name" style="padding: 12px; font-size: 14px;">
            </div>
            <div class="form-item">
                <label>生产批次</label>
                <input type="text" id="batch-id" style="padding: 12px; font-size: 14px;">
            </div>
            <div class="form-item">
                <label>操作员</label>
                <input type="text" id="operator" value="Admin" style="padding: 12px; font-size: 14px;">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">取消</button>
            <button class="btn btn-primary" onclick="confirmInspection()">开始分析</button>
        </div>
    </div>
</div>

<!-- 系统设置模态框 -->
<div id="systemConfigModal" class="modal">
    <div class="modal-card bottom-panel">
        <div class="modal-header">
            <span>系统设置</span>
            <button class="modal-close" onclick="closeSystemConfigModal()">&times;</button>
        </div>
        <div class="modal-body">
            <!-- 标签页头部 -->
            <div class="tab-header">
                <div class="tab-option active" data-tab="stitch" onclick="switchTab('stitch')">拼接设置</div>
                <div class="tab-option" data-tab="template" onclick="switchTab('template')">模板管理</div>
            </div>

            <!-- 拼接设置标签内容 -->
            <div class="tab-content active" id="stitchTabContent">
                <div style="margin-bottom: 15px;">
                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 8px;">拼接策略</label>
                    <div class="strategy-selector">
                        <div class="strategy-option" data-strategy="simple" onclick="selectStrategy('simple')">
                            <div class="name">Simple</div>
                            <div class="desc">简单拼接</div>
                        </div>
                        <div class="strategy-option" data-strategy="auto" onclick="selectStrategy('auto')">
                            <div class="name">Auto</div>
                            <div class="desc">自动拼接</div>
                        </div>
                        <div class="strategy-option" data-strategy="manual" onclick="selectStrategy('manual')">
                            <div class="name">Manual</div>
                            <div class="desc">手动调节</div>
                        </div>
                    </div>
                </div>

                <div class="manual-config-section" id="manualConfigSection" style="display: none;">
                    <div class="section-title">
                        <div class="live-indicator"></div>
                        实时参数调节
                    </div>

                    <div class="preview-note">
                        拖动滑块实时预览拼接效果，满意后点击保存
                    </div>

                    <div id="cameraConfigsContainer">
                        <!-- 动态生成 -->
                    </div>
                </div>
            </div>

            <!-- 模板管理标签内容 -->
            <div class="tab-content" id="templateTabContent">
                <div class="quality-standards-section">
                    <div class="section-title">
                        <span>模板管理</span>
                        <button class="btn btn-success" style="font-size: 11px; padding: 4px 10px;" onclick="showOneClickBuildModal()">⚡ 一键建模</button>
                    </div>

                    <div class="preview-note" style="margin-bottom: 12px;">
                        截取当前画面，AI 自动识别特征并生成模板
                    </div>

                    <div id="templatesContainer">
                        <!-- 动态生成模板列表 -->
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="resetCurrentConfig()">重置</button>
            <button class="btn btn-success" onclick="saveCurrentConfig()">保存配置</button>
        </div>
    </div>
</div>

<!-- Toast 提示 -->
<div id="toast" class="toast"></div>

<script>
    const API_BASE = '';
    let requestId = null;
    let inspectionStartTime = null; // 检测开始时间

    // 拼接配置相关
    let currentStrategy = 'simple';
    let manualConfigs = {};
    let cameraCount = 2;
    let isManualModeAvailable = false;
    let isPreviewMode = false;

    // Canvas 拼接相关
    let panoramaCanvas = null;
    let panoramaCtx = null;
    let offscreenCanvas = null; // 离屏 Canvas 用于双缓冲
    let offscreenCtx = null;
    let cameraStreams = []; // 隐藏的 img 元素用于加载 MJPEG 流
    let animationId = null;
    let lastFetchTime = 0;
    let lastCanvasWidth = 0;
    let lastCanvasHeight = 0;

    setInterval(() => {
        document.getElementById('clock').innerText = new Date().toLocaleTimeString();
    }, 1000);

    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = `toast ${type}`;
        toast.style.display = 'block';
        setTimeout(() => { toast.style.display = 'none'; }, 3000);
    }

    // --- 摄像头控制 ---
    async function startCamera() {
        try {
            const res = await fetch(`${API_BASE}/api/camera/start`, { method: 'POST' });
            const data = await res.json();
            if (data.status === 'success') {
                cameraCount = data.cameraCount;
                toggleState(true);
                initPanoramaCanvas();
                updateStitchStatus();
                startCanvasStitch();
                showToast('摄像头启动成功');
            }
        } catch(e) { alert('启动失败: ' + e.message); }
    }

    function initPanoramaCanvas() {
        panoramaCanvas = document.getElementById('panoramaCanvas');
        panoramaCtx = panoramaCanvas.getContext('2d', { alpha: false }); // 优化：关闭透明通道

        // 创建离屏 Canvas 用于双缓冲
        offscreenCanvas = document.createElement('canvas');
        offscreenCtx = offscreenCanvas.getContext('2d', { alpha: false });

        document.getElementById('panoramaPlaceholder').style.display = 'none';
        panoramaCanvas.style.display = 'block';
        document.getElementById('panoramaOverlay').style.display = 'flex';

        // 创建隐藏的 img 元素加载 MJPEG 流
        const hiddenContainer = document.createElement('div');
        hiddenContainer.style.position = 'absolute';
        hiddenContainer.style.visibility = 'hidden';
        hiddenContainer.style.width = '0';
        hiddenContainer.style.height = '0';
        hiddenContainer.style.overflow = 'hidden';

        for (let i = 0; i < cameraCount; i++) {
            const img = document.createElement('img');
            img.crossOrigin = 'anonymous'; // 允许跨域
            img.src = `${API_BASE}/api/camera/stream/${i}?t=${Date.now()}`;
            hiddenContainer.appendChild(img);
            cameraStreams.push(img);
        }

        document.body.appendChild(hiddenContainer);

        lastCanvasWidth = 0;
        lastCanvasHeight = 0;
    }

    // Canvas 拼接主循环
    async function startCanvasStitch() {
        const fetchInterval = 50; // 约 20fps，避免过于频繁

        async function stitchLoop() {
            if (!document.getElementById('stopBtn').disabled) {
                const now = Date.now();
                if (now - lastFetchTime >= fetchInterval) {
                    stitchFromStreams();
                    lastFetchTime = now;
                }
            }
            animationId = requestAnimationFrame(stitchLoop);
        }

        // 等待图片加载完成后再开始循环
        setTimeout(() => {
            stitchLoop();
        }, 1000);
    }

    // 从 MJPEG 流截取画面并拼接
    function stitchFromStreams() {
        // 检查所有流是否已加载
        const loadedImages = cameraStreams.filter(img => img.complete && img.naturalWidth > 0);

        if (loadedImages.length === cameraCount) {
            stitchImagesOnCanvas(loadedImages);
        }
    }

    function stitchImagesOnCanvas(images) {
        if (!offscreenCtx || images.length === 0) return;

        // 根据策略设置画布尺寸
        let canvasWidth, canvasHeight;

        if (currentStrategy === 'manual' && Object.keys(manualConfigs).length > 0) {
            // 手动模式：根据参数计算画布大小
            let totalWidth = 0;
            let maxHeight = 0;

            images.forEach((img, index) => {
                const config = manualConfigs[index] || {
                    offset: [0, 0],
                    scale: 1.0
                };
                // 使用 naturalWidth/Height 获取图像的实际尺寸
                const scaledWidth = img.naturalWidth * config.scale;
                const scaledHeight = img.naturalHeight * config.scale;
                const overlapWidth = config.overlapWidth || 0;

                totalWidth += scaledWidth - overlapWidth;
                maxHeight = Math.max(maxHeight, scaledHeight + Math.abs(config.offset[1]));
            });

            canvasWidth = Math.round(totalWidth);
            canvasHeight = Math.round(maxHeight);
        } else {
            // Simple/Auto 模式：简单水平拼接
            canvasWidth = images.reduce((sum, img) => sum + img.naturalWidth, 0);
            canvasHeight = Math.max(...images.map(img => img.naturalHeight));
        }

        // 只有尺寸真正变化时才调整 Canvas（避免频繁重置）
        if (canvasWidth !== lastCanvasWidth || canvasHeight !== lastCanvasHeight) {
            offscreenCanvas.width = canvasWidth;
            offscreenCanvas.height = canvasHeight;
            panoramaCanvas.width = canvasWidth;
            panoramaCanvas.height = canvasHeight;
            lastCanvasWidth = canvasWidth;
            lastCanvasHeight = canvasHeight;
        }

        // 在离屏 Canvas 上绘制背景
        offscreenCtx.fillStyle = '#000';
        offscreenCtx.fillRect(0, 0, canvasWidth, canvasHeight);

        // 绘制图像
        let offsetX = 0;

        images.forEach((img, index) => {
            let drawX, drawY, drawWidth, drawHeight;

            if (currentStrategy === 'manual' && manualConfigs[index]) {
                const config = manualConfigs[index];
                drawWidth = img.naturalWidth * config.scale;
                drawHeight = img.naturalHeight * config.scale;
                drawX = offsetX + config.offset[0];
                drawY = (canvasHeight - drawHeight) / 2 + config.offset[1];

                const overlapWidth = config.overlapWidth || 0;
                offsetX += drawWidth - overlapWidth;
            } else {
                drawWidth = img.naturalWidth;
                drawHeight = img.naturalHeight;
                drawX = offsetX;
                drawY = (canvasHeight - img.naturalHeight) / 2;
                offsetX += img.naturalWidth;
            }

            // 绘制到离屏 Canvas
            try {
                offscreenCtx.drawImage(img, drawX, drawY, drawWidth, drawHeight);
            } catch(e) {
                // 忽略绘制错误
            }
        });

        // 一次性将离屏 Canvas 复制到主 Canvas（避免闪烁）
        panoramaCtx.drawImage(offscreenCanvas, 0, 0);
    }

    async function stopCamera() {
        try {
            await fetch(`${API_BASE}/api/camera/stop`, { method: 'POST' });
            toggleState(false);

            // 停止 Canvas 循环
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }

            // 清理隐藏的流容器
            cameraStreams.forEach(img => {
                img.src = '';
            });
            cameraStreams = [];

            // 重置显示
            document.getElementById('panoramaPlaceholder').style.display = 'flex';
            panoramaCanvas.style.display = 'none';
            document.getElementById('panoramaOverlay').style.display = 'none';

            showToast('摄像头已停止', 'warning');
        } catch(e) {}
    }

    function toggleState(isOn) {
        document.getElementById('startBtn').disabled = isOn;
        document.getElementById('stopBtn').disabled = !isOn;
        document.getElementById('inspectBtn').disabled = !isOn;
    }

    // --- 检测逻辑 ---
    async function startPreCheck() {
        try {
            const res = await fetch(`${API_BASE}/api/inspect/pre-check`, { method: 'POST' });
            const data = await res.json();
            if(data.status === 'success') {
                requestId = data.data.requestId;
                document.getElementById('preview-image').src = data.data.preview_image;
                if(data.data.suggested_type) document.getElementById('part-name').value = data.data.suggested_type;
                document.getElementById('confirmModal').style.display = 'block';
            }
        } catch(e) {}
    }

    async function confirmInspection() {
        const part = document.getElementById('part-name').value;
        const batch = document.getElementById('batch-id').value;
        const op = document.getElementById('operator').value;
        if(!part || !batch) return showToast('请完善信息', 'error');

        closeModal();

        // 记录检测开始时间（发起请求前）
        inspectionStartTime = new Date();

        try {
            const res = await fetch(`${API_BASE}/api/inspect/confirm`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ request_id: requestId, confirmed_part_name: part, batch_id: batch, operator: op })
            });
            const data = await res.json();
            if(data.status === 'success') showResults(data.data);
            else showToast(data.message, 'error');
        } catch(e) { showToast(e.message, 'error'); }
    }

    function showResults(data) {
        const panelBody = document.getElementById('result-panel-body');

        // 计算每种类型的统计数量
        const typeCounts = {};
        const details = data.analysis.details || [];
        details.forEach(det => {
            typeCounts[det.label] = (typeCounts[det.label] || 0) + 1;
        });

        // 计算检查时间和耗费时间
        const inspectionEndTime = new Date();
        const checkTime = inspectionEndTime.toLocaleTimeString('zh-CN', { hour12: false });
        let duration = '-';
        if (inspectionStartTime) {
            const durationMs = inspectionEndTime - inspectionStartTime;
            const seconds = (durationMs / 1000).toFixed(2);
            duration = `${seconds} 秒`;
        }

        panelBody.innerHTML = `
            <div class="result-view">
                <div class="result-image">
                    <div class="image-wrapper" style="position: relative; display: inline-block;">
                        <img id="resultImage" src="${data.result_image}" onclick="showImagePreview(this.src)" style="cursor: pointer;" title="点击放大查看">
                        <canvas id="bboxCanvas" style="position: absolute; top: 0; left: 0; pointer-events: none;"></canvas>
                    </div>
                </div>
                <div class="result-info">
                    <div class="batch-info-bar">
                        <div class="info-card">
                            <label>工件名称</label>
                            <div class="val">${data.batch_info.part_name}</div>
                        </div>
                        <div class="info-card">
                            <label>批次号</label>
                            <div class="val">${data.batch_info.batch_id}</div>
                        </div>
                        <div class="info-card">
                            <label>操作员</label>
                            <div class="val">${data.batch_info.operator}</div>
                        </div>
                    </div>

                    <!-- 检查时间和耗费时间 -->
                    <div class="batch-info-bar">
                        <div class="info-card" style="background: #fffbe6; border-color: #ffe58f;">
                            <label style="color: #d48806;">检查时间</label>
                            <div class="val" style="color: #d46b08;">${checkTime}</div>
                        </div>
                        <div class="info-card" style="background: #fffbe6; border-color: #ffe58f;">
                            <label style="color: #d48806;">耗费时间</label>
                            <div class="val" style="color: #d46b08;">${duration}</div>
                        </div>
                    </div>

                    <!-- 统计信息 -->
                    <div class="summary-stats">
                        <div class="summary-title">类型统计</div>
                        <div class="summary-cards">
                            ${Object.entries(typeCounts).map(([type, count]) => `
                                <div class="summary-card">
                                    <div class="summary-type">${type}</div>
                                    <div class="summary-count">${count}</div>
                                </div>
                            `).join('')}
                            ${Object.keys(typeCounts).length === 0 ? '<div class="no-defects">无缺陷检出</div>' : ''}
                        </div>
                    </div>

                    <!-- 模板比对结果表格 -->
                    ${data.analysis.templateComparisons && data.analysis.templateComparisons.length > 0 ? `
                        <div class="table-container">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                                <div class="summary-title">模板比对结果</div>
                                <div style="font-size: 12px; color: #666;">
                                    总计: ${data.analysis.templateComparisons.length} 个特征
                                </div>
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>状态</th>
                                        <th>类型</th>
                                        <th>模板位置</th>
                                        <th>检测位置</th>
                                        <th>X偏差</th>
                                        <th>Y偏差</th>
                                        <th>总偏差</th>
                                        <th>容差</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.analysis.templateComparisons.map((comp, i) => {
                                        const statusClass = comp.withinTolerance ? 'status-pass' :
                                            comp.status === 'MISSING' ? 'status-missing' :
                                            comp.status === 'EXTRA' ? 'status-extra' :
                                            comp.status === 'TYPE_MISMATCH' ? 'status-type-mismatch' : 'status-fail';
                                        const statusText = comp.withinTolerance ? '合格' :
                                            comp.status === 'MISSING' ? '漏检' :
                                            comp.status === 'EXTRA' ? '错检' :
                                            comp.status === 'TYPE_MISMATCH' ? '类型错误' : '偏差';
                                        const tplX = comp.templatePosition?.x ?? comp.template_position?.x;
                                        const tplY = comp.templatePosition?.y ?? comp.template_position?.y;
                                        const detX = comp.detectedPosition?.x ?? comp.detected_position?.x;
                                        const detY = comp.detectedPosition?.y ?? comp.detected_position?.y;
                                        const xError = comp.xError ?? comp.x_error;
                                        const yError = comp.yError ?? comp.y_error;
                                        const totalError = comp.totalError ?? comp.total_error;
                                        const toleranceX = comp.toleranceX ?? comp.tolerance_x;
                                        const toleranceY = comp.toleranceY ?? comp.tolerance_y;
                                        // 类型错误或错检时显示格式: "模板: nut -> 检测: hole"
                                        let displayType = comp.className || comp.featureName || comp.feature_name || 'class_' + comp.classId;
                                        if ((comp.status === 'TYPE_MISMATCH' || comp.status === 'EXTRA') && comp.expectedClassName && comp.className) {
                                            displayType = `模板: ${comp.expectedClassName} &rarr; 检测: ${comp.className}`;
                                        }
                                        // 类型错误时，模板位置就是预期的特征位置
                                        let displayTplX = tplX;
                                        let displayTplY = tplY;
                                        if (comp.status === 'TYPE_MISMATCH' && comp.expectedPosition) {
                                            displayTplX = comp.expectedPosition.x ?? comp.expected_position?.x;
                                            displayTplY = comp.expectedPosition.y ?? comp.expected_position?.y;
                                        }
                                        // 错检时使用预期位置作为模板位置
                                        if (comp.status === 'EXTRA' && comp.expectedPosition) {
                                            displayTplX = comp.expectedPosition.x ?? comp.expected_position?.x;
                                            displayTplY = comp.expectedPosition.y ?? comp.expected_position?.y;
                                        }
                                        return `
                                            <tr data-index="${i}" onclick="${comp.status !== 'MISSING' ? `highlightBBox(${i})` : ''}" style="cursor: ${comp.status !== 'MISSING' ? 'pointer' : 'default'}; ${!comp.withinTolerance ? 'background: #fff1f0;' : ''}">
                                                <td><span class="${statusClass}">${statusText}</span></td>
                                                <td>${displayType}</td>
                                                <td>(${displayTplX != null ? Math.round(displayTplX) : '-'}, ${displayTplY != null ? Math.round(displayTplY) : '-'})</td>
                                                <td>${detX != null ? `(${Math.round(detX)}, ${Math.round(detY)})` : '-'}</td>
                                                <td style="color: ${xError != null && xError !== undefined && xError !== 0 && Math.abs(xError) > toleranceX ? '#ff4d4f' : 'inherit'}">
                                                    ${xError != null && xError !== undefined && xError !== 0 ? xError.toFixed(2) : '-'}
                                                </td>
                                                <td style="color: ${yError != null && yError !== undefined && yError !== 0 && Math.abs(yError) > toleranceY ? '#ff4d4f' : 'inherit'}">
                                                    ${yError != null && yError !== undefined && yError !== 0 ? yError.toFixed(2) : '-'}
                                                </td>
                                                <td style="color: ${totalError != null && totalError !== undefined && totalError !== 0 && totalError > Math.max(toleranceX, toleranceY) ? '#ff4d4f' : 'inherit'}">
                                                    ${totalError != null && totalError !== undefined && totalError !== 0 ? totalError.toFixed(2) : '-'}
                                                </td>
                                                <td>X≤${toleranceX}, Y≤${toleranceY}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : `
                        <!-- 没有模板比对结果时显示原始检测列表 -->
                        <div class="table-container">
                            <table>
                                <thead><tr><th>ID</th><th>类型</th><th>坐标</th><th>置信度</th></tr></thead>
                                <tbody id="resultTableBody">
                                    ${details.map((det, i) => `
                                        <tr data-index="${i}" onclick="highlightBBox(${i})" style="cursor: pointer;">
                                            <td>${i + 1}</td>
                                            <td>${det.label}</td>
                                            <td>${det.bbox ? `[${det.bbox.map(v => Math.round(v)).join(', ')}]` : '-'}</td>
                                            <td>${(det.confidence * 100).toFixed(0)}%</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `}
                </div>
            </div>
        `;

        // 绘制检测框
        setTimeout(() => {
            drawBBoxes(details);
        }, 100);

        const statusTag = document.getElementById('status-tag');
        const isPass = data.analysis.quality_status === 'PASS';
        statusTag.className = 'status-tag ' + (isPass ? 'pass' : 'fail');
        statusTag.innerText = isPass ? '✓ 质检合格' : '✗ 质检不合格';

        // 显示"检查完成"按钮
        document.getElementById('completeBtn').style.display = 'block';
    }

    // 清空检测结果，恢复到检查前的状态
    function clearResults() {
        // 清空结果显示区域
        const panelBody = document.getElementById('result-panel-body');
        panelBody.innerHTML = `
            <div class="empty-state">
                <p>暂无检测数据，请点击左侧 "开始检测"</p>
            </div>
        `;

        // 重置状态标签
        const statusTag = document.getElementById('status-tag');
        statusTag.className = 'status-tag waiting';
        statusTag.innerText = '等待检测';

        // 隐藏"检查完成"按钮
        document.getElementById('completeBtn').style.display = 'none';

        // 清空检测框数据
        bboxesData = [];
        selectedIndex = -1;
        canvasCtx = null;

        // 清空颜色映射
        for (const key in defectTypeColors) {
            delete defectTypeColors[key];
        }

        // 清空检测开始时间
        inspectionStartTime = null;

        showToast('检测结果已清空');
    }

    // 全局变量用于存储检测框数据
    let bboxesData = [];
    let canvasCtx = null;
    let selectedIndex = -1;

    // 缺陷类型颜色映射
    const defectTypeColors = {};
    const colorPalette = [
        '#00FF00', '#FF0000', '#00FFFF', '#FF00FF', '#FFFF00',
        '#FF8800', '#0088FF', '#FF0088', '#88FF00', '#8800FF',
        '#00FF88', '#FF8888', '#88FFFF', '#FF88FF', '#FFFF88'
    ];

    // 获取缺陷类型的颜色
    function getDefectTypeColor(defectType) {
        if (!defectTypeColors[defectType]) {
            const usedColors = Object.values(defectTypeColors);
            const availableColor = colorPalette.find(c => !usedColors.includes(c));
            defectTypeColors[defectType] = availableColor || colorPalette[Object.keys(defectTypeColors).length % colorPalette.length];
        }
        return defectTypeColors[defectType];
    }

    function drawBBoxes(details) {
        const img = document.getElementById('resultImage');
        const canvas = document.getElementById('bboxCanvas');
        if (!img || !canvas) return;

        bboxesData = details;
        selectedIndex = -1;

        // 设置 canvas 尺寸与图片一致
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        canvas.style.width = img.width + 'px';
        canvas.style.height = img.height + 'px';

        canvasCtx = canvas.getContext('2d');

        // 绘制所有检测框
        redrawBBoxes();
    }

    function redrawBBoxes() {
        if (!canvasCtx) return;

        canvasCtx.clearRect(0, 0, canvasCtx.canvas.width, canvasCtx.canvas.height);

        bboxesData.forEach((det, i) => {
            if (!det.bbox || det.bbox.length < 4) return;

            const [x1, y1, x2, y2] = det.bbox;
            const width = x2 - x1;
            const height = y2 - y1;

            const isSelected = i === selectedIndex;
            const color = getDefectTypeColor(det.label);

            // 绘制矩形框
            canvasCtx.strokeStyle = isSelected ? '#FFFFFF' : color;
            canvasCtx.lineWidth = isSelected ? 4 : 2;
            canvasCtx.strokeRect(x1, y1, width, height);

            // 绘制标签背景
            canvasCtx.fillStyle = isSelected ? '#FFFFFF' : color;
            const labelText = `${det.label} (${(det.confidence * 100).toFixed(0)}%)`;
            canvasCtx.font = 'bold 14px Arial';
            const textWidth = canvasCtx.measureText(labelText).width;
            canvasCtx.fillRect(x1, y1 - 24, textWidth + 8, 24);

            // 绘制标签文字
            canvasCtx.fillStyle = isSelected ? '#000000' : '#000000';
            canvasCtx.fillText(labelText, x1 + 4, y1 - 6);
        });
    }

    function highlightBBox(index) {
        // 更新表格行样式
        const rows = document.querySelectorAll('#resultTableBody tr');
        rows.forEach((row, i) => {
            if (i === index) {
                row.style.background = '#e6f7ff';
            } else {
                row.style.background = '';
            }
        });

        // 更新 Canvas 高亮
        selectedIndex = index;
        redrawBBoxes();
    }

    function closeModal() {
        document.getElementById('confirmModal').style.display = 'none';
    }

    // 图片预览功能
    function showImagePreview(src) {
        // 创建预览模态框
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.id = 'imagePreviewModal';
        modal.innerHTML = `
            <div class="modal-card center-dialog" style="width: 1400px; max-width: 95vw; max-height: 90vh;">
                <div class="modal-header">
                    <span>检测结果图片</span>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button class="btn btn-success" onclick="downloadAnnotatedImage()" style="padding: 6px 12px; font-size: 13px;">⬇ 下载图片</button>
                        <button class="modal-close" onclick="closeImagePreview()">&times;</button>
                    </div>
                </div>
                <div class="modal-body" style="display: flex; align-items: center; justify-content: center; background: #f5f5f5; padding: 20px;">
                    <div class="preview-image-wrapper" style="position: relative; display: inline-block;">
                        <img id="previewImage" src="${src}" style="max-width: 100%; max-height: 75vh; object-fit: contain; border-radius: 4px; display: block;">
                        <canvas id="previewCanvas" style="position: absolute; top: 0; left: 0; pointer-events: none;"></canvas>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        // 图片加载后绘制检测框
        const img = document.getElementById('previewImage');
        img.onload = () => {
            drawPreviewBBoxes(img);
        };

        // 点击背景关闭
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeImagePreview();
            }
        });
    }

    // 下载带标注的图片
    function downloadAnnotatedImage() {
        const img = document.getElementById('previewImage');
        const canvas = document.getElementById('previewCanvas');

        if (!img || !canvas) return;

        // 创建一个新的 canvas，将图片和检测框合并
        const mergedCanvas = document.createElement('canvas');
        mergedCanvas.width = img.naturalWidth;
        mergedCanvas.height = img.naturalHeight;
        const ctx = mergedCanvas.getContext('2d');

        // 绘制原图
        ctx.drawImage(img, 0, 0);

        // 绘制检测框
        ctx.drawImage(canvas, 0, 0);

        // 导出为图片并下载
        const link = document.createElement('a');
        link.download = `检测结果_${new Date().toLocaleString('zh-CN', { hour12: false }).replace(/[/:]/g, '-')}.png`;
        link.href = mergedCanvas.toDataURL('image/png');
        link.click();
    }

    function drawPreviewBBoxes(img) {
        const canvas = document.getElementById('previewCanvas');
        if (!canvas || !bboxesData.length) return;

        // 设置 canvas 尺寸与图片原始尺寸一致
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        canvas.style.width = img.width + 'px';
        canvas.style.height = img.height + 'px';

        const ctx = canvas.getContext('2d');

        bboxesData.forEach((det, i) => {
            if (!det.bbox || det.bbox.length < 4) return;

            const [x1, y1, x2, y2] = det.bbox;
            const width = x2 - x1;
            const height = y2 - y1;

            const isSelected = i === selectedIndex;
            const color = getDefectTypeColor(det.label);

            // 绘制矩形框
            ctx.strokeStyle = isSelected ? '#FFFFFF' : color;
            ctx.lineWidth = isSelected ? 4 : 2;
            ctx.strokeRect(x1, y1, width, height);

            // 绘制标签背景
            ctx.fillStyle = isSelected ? '#FFFFFF' : color;
            const labelText = `${det.label} (${(det.confidence * 100).toFixed(0)}%)`;
            ctx.font = 'bold 16px Arial';
            const textWidth = ctx.measureText(labelText).width;
            ctx.fillRect(x1, y1 - 26, textWidth + 10, 26);

            // 绘制标签文字
            ctx.fillStyle = isSelected ? '#000000' : '#000000';
            ctx.fillText(labelText, x1 + 5, y1 - 7);
        });
    }

    function closeImagePreview() {
        const modal = document.getElementById('imagePreviewModal');
        if (modal) {
            modal.remove();
        }
    }

    // --- 系统设置 ---
    let currentTab = 'stitch';
    let templatesData = [];
    let currentTemplate = null;

    // 模板管理相关
    async function loadTemplates() {
        console.log('loadTemplates called');
        try {
            const res = await fetch(`${API_BASE}/api/templates`);
            const data = await res.json();
            console.log('Templates data:', data);
            if (Array.isArray(data)) {
                templatesData = data;
                renderTemplates();
            }
        } catch(e) {
            console.error('Failed to load templates', e);
        }
    }

    function renderTemplates() {
        const container = document.getElementById('templatesContainer');
        container.innerHTML = '';

        if (templatesData.length === 0) {
            container.innerHTML = '<div style="color: #888; padding: 20px; text-align: center;">暂无模板，请点击上方按钮构建新模板</div>';
            return;
        }

        templatesData.forEach(template => {
            const templateItem = document.createElement('div');
            templateItem.className = 'part-type-item';

            const partType = template.metadata?.partType || '未关联';
            const featureCount = template.features?.length || 0;
            const isCurrent = currentTemplate?.templateId === template.templateId;

            templateItem.innerHTML = `
                <div class="part-type-header" style="${isCurrent ? 'background: #e8f5e9;' : ''}">
                    <span class="part-type-name">${template.templateId} ${isCurrent ? '<span style="color: #4caf50; font-size: 11px;">(当前)</span>' : ''}</span>
                    <div>
                        ${!isCurrent ? `<button class="btn btn-success" style="font-size: 10px; padding: 2px 8px; margin-right: 5px;" onclick="activateTemplate('${template.templateId}')">激活</button>` : ''}
                        <button class="btn-icon" onclick="viewTemplateDetails('${template.templateId}')">📋</button>
                        <button class="btn-icon" onclick="deleteTemplate('${template.templateId}')">&times;</button>
                    </div>
                </div>
                <div style="padding: 10px; font-size: 12px; color: #666;">
                    <div>关联工件: ${partType}</div>
                    <div>特征数量: ${featureCount}</div>
                    <div>图片尺寸: ${template.imageSize?.width}x${template.imageSize?.height}</div>
                    <div>容差: X=${template.toleranceX}, Y=${template.toleranceY}</div>
                </div>
            `;
            container.appendChild(templateItem);
        });

        // 加载当前模板
        loadCurrentTemplate();
    }

    async function loadCurrentTemplate() {
        try {
            const res = await fetch(`${API_BASE}/api/templates/current`);
            if (res.ok) {
                currentTemplate = await res.json();
                // 不再调用 renderTemplates()，避免无限循环
            }
        } catch(e) {
            console.error('Failed to load current template', e);
        }
    }

    async function activateTemplate(templateId) {
        try {
            const res = await fetch(`${API_BASE}/api/templates/${encodeURIComponent(templateId)}/activate`, {
                method: 'POST'
            });
            const data = await res.json();
            if (data.success === true) {
                currentTemplate = data.template;
                renderTemplates();
                showToast('模板已激活');
            } else {
                showToast('激活失败: ' + data.message, 'error');
            }
        } catch(e) {
            console.error('Activate template error:', e);
            showToast('激活失败', 'error');
        }
    }

    async function deleteTemplate(templateId) {
        if (!confirm(`确定要删除模板 "${templateId}" 吗？`)) return;
        try {
            const res = await fetch(`${API_BASE}/api/templates/${encodeURIComponent(templateId)}`, {
                method: 'DELETE'
            });
            if (res.ok) {
                await loadTemplates();
                showToast('模板已删除');
            }
        } catch(e) {
            console.error('Delete template error:', e);
            showToast('删除失败', 'error');
        }
    }

    function viewTemplateDetails(templateId) {
        const template = templatesData.find(t => t.templateId === templateId);
        if (!template) return;

        let details = `模板 ID: ${template.templateId}\n\n`;
        details += `图片尺寸: ${template.imageSize?.width}x${template.imageSize?.height}\n`;
        details += `容差: X=${template.toleranceX}, Y=${template.toleranceY}\n`;
        details += `关联工件: ${template.metadata?.partType || '未关联'}\n`;
        details += `特征数量: ${template.features?.length || 0}\n`;
        details += `锚点数量: ${template.anchorPoints?.length || 0}\n\n`;

        if (template.features && template.features.length > 0) {
            details += '特征列表:\n';
            template.features.forEach((f, idx) => {
                const name = f.name || f.className || 'class_' + f.classId;
                const x = f.position?.x || f.relativePosition?.x || 0;
                const y = f.position?.y || f.relativePosition?.y || 0;
                details += `  ${idx + 1}. ${name} (classId: ${f.classId}) at (${x.toFixed(1)}, ${y.toFixed(1)})\n`;
            });
        }

        alert(details);
    }

    // 保存预览的检测结果
    let previewDetectionData = null;

    // 显示一键建模对话框
    function showOneClickBuildModal() {
        const html = `
            <div id="oneClickBuildModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 2000;">
                <div style="background: #fff; padding: 24px; border-radius: 8px; width: 600px; max-width: 95%; max-height: 95vh; overflow-y: auto;">
                    <h3 style="margin-top: 0;">⚡ 一键建模</h3>
                    <p style="color: #666; font-size: 13px; margin-bottom: 20px;">
                        先预览识别结果，确认无误后再创建模板
                    </p>

                    <!-- 步骤1: 设置参数 -->
                    <div id="buildStep1">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: bold;">工件类型 *</label>
                            <input type="text" id="oneClickPartType" placeholder="例如: CX756601" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                            <div style="font-size: 11px; color: #888; margin-top: 4px;">用于标识模板名称</div>
                        </div>

                        <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                            <div style="flex: 1;">
                                <label style="display: block; margin-bottom: 6px; font-weight: bold;">X 轴容差 (像素)</label>
                                <input type="number" id="oneClickToleranceX" value="20" min="1" max="500" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <div style="font-size: 11px; color: #888; margin-top: 4px;">默认: 20</div>
                            </div>
                            <div style="flex: 1;">
                                <label style="display: block; margin-bottom: 6px; font-weight: bold;">Y 轴容差 (像素)</label>
                                <input type="number" id="oneClickToleranceY" value="20" min="1" max="500" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <div style="font-size: 11px; color: #888; margin-top: 4px;">默认: 20</div>
                            </div>
                        </div>

                        <div style="padding: 12px; background: #f0f9ff; border-left: 3px solid #1890ff; border-radius: 4px; margin-bottom: 15px; font-size: 12px;">
                            <strong style="color: #1890ff;">操作说明：</strong><br>
                            1. 确保摄像头已启动<br>
                            2. 确保当前画面中有完整的工件<br>
                            3. 点击"预览识别结果"查看检测效果
                        </div>

                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button class="btn btn-secondary" onclick="closeOneClickBuildModal()">取消</button>
                            <button class="btn btn-primary" onclick="previewDetection()">预览识别结果</button>
                        </div>
                    </div>

                    <!-- 步骤2: 预览结果 -->
                    <div id="buildStep2" style="display: none;">
                        <div style="margin-bottom: 15px;">
                            <h4 style="margin: 0 0 10px 0;">识别结果</h4>
                            <div id="previewImageContainer" style="text-align: center; margin-bottom: 15px;">
                                <div style="color: #999; padding: 40px;">加载中...</div>
                            </div>
                            <div id="detectionInfo" style="font-size: 13px; color: #666;"></div>
                        </div>

                        <div id="detectionList" style="max-height: 200px; overflow-y: auto; margin-bottom: 15px; border: 1px solid #eee; border-radius: 4px; padding: 10px;">
                        </div>

                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button class="btn btn-secondary" onclick="backToStep1()">返回</button>
                            <button class="btn btn-success" onclick="confirmBuild()">确认并创建模板</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', html);

        // 自动聚焦到输入框
        setTimeout(() => {
            const input = document.getElementById('oneClickPartType');
            if (input) input.focus();
        }, 100);
    }

    function closeOneClickBuildModal() {
        const modal = document.getElementById('oneClickBuildModal');
        if (modal) modal.remove();
        previewDetectionData = null;
    }

    // 预览识别结果
    async function previewDetection() {
        const partType = document.getElementById('oneClickPartType').value.trim();
        const toleranceX = parseFloat(document.getElementById('oneClickToleranceX').value) || 20;
        const toleranceY = parseFloat(document.getElementById('oneClickToleranceY').value) || 20;

        if (!partType) {
            showToast('请输入工件类型', 'error');
            return;
        }

        try {
            // 显示加载状态
            document.getElementById('buildStep1').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 40px; margin-bottom: 10px;">🔍</div>
                    <div style="color: #666;">正在识别画面...</div>
                </div>
            `;

            const res = await fetch(`${API_BASE}/api/templates/preview-detection`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });

            const data = await res.json();

            if (data.success) {
                // 保存预览数据
                previewDetectionData = {
                    partType: partType,
                    toleranceX: toleranceX,
                    toleranceY: toleranceY,
                    detections: data.detections,
                    imageWidth: data.imageWidth,
                    imageHeight: data.imageHeight
                };

                // 显示步骤2
                showPreviewResult(data);
            } else {
                showToast('识别失败: ' + data.message, 'error');
                // 恢复步骤1
                backToStep1();
            }
        } catch(e) {
            console.error('Preview error:', e);
            showToast('识别失败: ' + e.message, 'error');
            backToStep1();
        }
    }

    // 显示预览结果
    function showPreviewResult(data) {
        document.getElementById('buildStep1').style.display = 'none';
        document.getElementById('buildStep2').style.display = 'block';

        // 显示图像
        const imgHtml = `<img src="${data.image}" style="max-width: 100%; max-height: 350px; border: 1px solid #ddd; border-radius: 4px;">`;
        document.getElementById('previewImageContainer').innerHTML = imgHtml;

        // 显示检测信息
        document.getElementById('detectionInfo').innerHTML = `
            <strong>检测到 ${data.count} 个特征</strong>
        `;

        // 显示检测列表
        const listHtml = data.detections.map((d, i) => `
            <div style="padding: 6px 0; border-bottom: 1px solid #f5f5f5; font-size: 12px;">
                <span style="color: #1890ff; font-weight: bold;">${d.className || 'class_' + d.classId}</span>
                <span style="color: #999;">置信度:</span> ${(d.confidence * 100).toFixed(1)}%
                <span style="color: #999;">位置:</span> (${d.centerX.toFixed(0)}, ${d.centerY.toFixed(0)})
            </div>
        `).join('');
        document.getElementById('detectionList').innerHTML = listHtml;
    }

    // 返回步骤1
    function backToStep1() {
        // 保存之前的输入值
        const prevPartType = previewDetectionData ? previewDetectionData.partType : '';
        const prevToleranceX = previewDetectionData ? previewDetectionData.toleranceX : 20;
        const prevToleranceY = previewDetectionData ? previewDetectionData.toleranceY : 20;

        // 重新渲染步骤1
        document.getElementById('buildStep1').innerHTML = `
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 6px; font-weight: bold;">工件类型 *</label>
                <input type="text" id="oneClickPartType" placeholder="例如: CX756601" value="${prevPartType}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                <div style="font-size: 11px; color: #888; margin-top: 4px;">用于标识模板名称</div>
            </div>

            <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                <div style="flex: 1;">
                    <label style="display: block; margin-bottom: 6px; font-weight: bold;">X 轴容差 (像素)</label>
                    <input type="number" id="oneClickToleranceX" value="${prevToleranceX}" min="1" max="500" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <div style="font-size: 11px; color: #888; margin-top: 4px;">默认: 20</div>
                </div>
                <div style="flex: 1;">
                    <label style="display: block; margin-bottom: 6px; font-weight: bold;">Y 轴容差 (像素)</label>
                    <input type="number" id="oneClickToleranceY" value="${prevToleranceY}" min="1" max="500" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <div style="font-size: 11px; color: #888; margin-top: 4px;">默认: 20</div>
                </div>
            </div>

            <div style="padding: 12px; background: #f0f9ff; border-left: 3px solid #1890ff; border-radius: 4px; margin-bottom: 15px; font-size: 12px;">
                <strong style="color: #1890ff;">操作说明：</strong><br>
                1. 确保摄像头已启动<br>
                2. 确保当前画面中有完整的工件<br>
                3. 点击"预览识别结果"查看检测效果
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeOneClickBuildModal()">取消</button>
                <button class="btn btn-primary" onclick="previewDetection()">预览识别结果</button>
            </div>
        `;

        document.getElementById('buildStep2').style.display = 'none';
        document.getElementById('buildStep1').style.display = 'block';
    }

    // 确认并创建模板
    async function confirmBuild() {
        if (!previewDetectionData) {
            showToast('没有预览数据，请重新预览', 'error');
            return;
        }

        try {
            // 显示加载状态
            const button = document.querySelector('#buildStep2 .btn-success');
            const originalText = button.textContent;
            button.textContent = '创建中...';
            button.disabled = true;

            const res = await fetch(`${API_BASE}/api/templates/one-click-build`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    partType: previewDetectionData.partType,
                    toleranceX: previewDetectionData.toleranceX,
                    toleranceY: previewDetectionData.toleranceY
                })
            });

            const data = await res.json();

            if (data.success === true || data.template) {
                closeOneClickBuildModal();
                await loadTemplates();
                showToast(`模板创建成功！检测到 ${data.template?.featureCount || 0} 个特征`);
            } else {
                showToast('创建失败: ' + data.message, 'error');
            }
        } catch(e) {
            console.error('Build error:', e);
            showToast('创建失败: ' + e.message, 'error');
        } finally {
            const button = document.querySelector('#buildStep2 .btn-success');
            if (button) {
                button.textContent = '确认并创建模板';
                button.disabled = false;
            }
        }
    }

    // 标签页切换
    function switchTab(tabName) {
        console.log('switchTab called with:', tabName);
        currentTab = tabName;
        console.log('currentTab is now:', currentTab);

        // 更新标签页头部样式
        document.querySelectorAll('.tab-option').forEach(el => {
            el.classList.toggle('active', el.dataset.tab === tabName);
        });

        // 更新内容显示
        document.querySelectorAll('.tab-content').forEach(el => {
            el.classList.remove('active');
        });
        const targetContent = document.getElementById(tabName + 'TabContent');
        if (targetContent) {
            targetContent.classList.add('active');
        }

        // 加载对应标签页的数据
        if (tabName === 'template') {
            loadTemplates();
        }
    }

    // --- 拼接配置 ---
    async function updateStitchStatus() {
        try {
            const res = await fetch(`${API_BASE}/api/stitch/config`);
            const data = await res.json();
            if(data.status === 'success') {
                currentStrategy = data.data.currentStrategy;
                const strategyEl = document.getElementById('currentStrategy');

                strategyEl.textContent = currentStrategy.toUpperCase();
                document.getElementById('stitchStatus').classList.toggle('manual', currentStrategy === 'manual');
            }
        } catch(e) {}
    }

    async function openSystemConfigModal() {
        document.getElementById('systemConfigModal').style.display = 'block';
        isPreviewMode = true;

        // 重置为拼接设置标签页
        currentTab = 'stitch';
        switchTab('stitch');

        try {
            const res = await fetch(`${API_BASE}/api/stitch/strategy`);
            const data = await res.json();
            if(data.status === 'success') {
                currentStrategy = data.data.strategy;
                updateStrategyUI();
            }
        } catch(e) {}
    }

    function closeSystemConfigModal() {
        document.getElementById('systemConfigModal').style.display = 'none';
        isPreviewMode = false;
    }

    function selectStrategy(strategy) {
        currentStrategy = strategy;
        updateStrategyUI();
    }

    function updateStrategyUI() {
        document.querySelectorAll('.strategy-option').forEach(el => {
            el.classList.toggle('active', el.dataset.strategy === currentStrategy);
        });

        const manualSection = document.getElementById('manualConfigSection');
        if(currentStrategy === 'manual') {
            manualSection.style.display = 'block';
            loadManualConfigs();
        } else {
            manualSection.style.display = 'none';
        }
    }

    async function loadManualConfigs() {
        try {
            const res = await fetch(`${API_BASE}/api/stitch/manual`);
            const data = await res.json();
            if(data.status === 'success' && data.data.cameras) {
                renderCameraConfigs(data.data.cameras);
            }
        } catch(e) {}
    }

    function renderCameraConfigs(cameras) {
        const container = document.getElementById('cameraConfigsContainer');
        container.innerHTML = '';

        cameras.forEach(cam => {
            const config = manualConfigs[cam.index] || {
                offset: cam.offset || [0, 0],
                scale: cam.scale || 1.0,
                rotation: cam.rotation || 0,
                flip: cam.flip || [false, false],
                overlapWidth: cam.overlapWidth || 100
            };
            manualConfigs[cam.index] = config;

            const item = document.createElement('div');
            item.className = 'camera-config-item';
            item.innerHTML = `
                <div class="camera-title">摄像头 ${cam.index}</div>
                <div class="param-grid">
                    <div class="param-item">
                        <label>X 偏移</label>
                        <div class="range-wrapper">
                            <input type="range" min="-2000" max="2000" value="${config.offset[0]}"
                                oninput="updateParam(${cam.index}, 'offset', [parseInt(this.value), manualConfigs[${cam.index}].offset[1]]); updateRangeDisplay(this)">
                            <span class="range-value">${config.offset[0]}</span>
                        </div>
                    </div>
                    <div class="param-item">
                        <label>Y 偏移</label>
                        <div class="range-wrapper">
                            <input type="range" min="-2000" max="2000" value="${config.offset[1]}"
                                oninput="updateParam(${cam.index}, 'offset', [manualConfigs[${cam.index}].offset[0], parseInt(this.value)]); updateRangeDisplay(this)">
                            <span class="range-value">${config.offset[1]}</span>
                        </div>
                    </div>
                    <div class="param-item">
                        <label>缩放</label>
                        <div class="range-wrapper">
                            <input type="range" min="0.5" max="1.5" step="0.01" value="${config.scale}"
                                oninput="updateParam(${cam.index}, 'scale', parseFloat(this.value)); updateRangeDisplay(this)">
                            <span class="range-value">${config.scale.toFixed(2)}</span>
                        </div>
                    </div>
                    <div class="param-item">
                        <label>重叠宽度</label>
                        <div class="range-wrapper">
                            <input type="range" min="0" max="300" value="${config.overlapWidth}"
                                oninput="updateParam(${cam.index}, 'overlapWidth', parseInt(this.value)); updateRangeDisplay(this)">
                            <span class="range-value">${config.overlapWidth}</span>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(item);
        });
    }

    function updateRangeDisplay(input) {
        const display = input.nextElementSibling;
        const val = input.type === 'range' && input.step === '0.01' ? parseFloat(input.value).toFixed(2) : input.value;
        display.textContent = val;
    }

    function updateParam(cameraIndex, param, value) {
        if(!manualConfigs[cameraIndex]) {
            manualConfigs[cameraIndex] = {
                offset: [0, 0],
                scale: 1.0,
                rotation: 0,
                flip: [false, false],
                overlapWidth: 100
            };
        }
        manualConfigs[cameraIndex][param] = value;
    }

    async function saveStitchConfig() {
        try {
            const strategyRes = await fetch(`${API_BASE}/api/stitch/strategy`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ strategy: currentStrategy })
            });

            const strategyData = await strategyRes.json();
            if(strategyData.status !== 'success') {
                showToast(strategyData.message, 'error');
                return;
            }

            if(currentStrategy === 'manual') {
                const configs = Object.entries(manualConfigs).map(([index, config]) => ({
                    index: parseInt(index),
                    offset: config.offset.map(v => typeof v === 'number' ? v : parseInt(v)),
                    scale: config.scale,
                    rotation: config.rotation,
                    flip: config.flip,
                    overlapWidth: config.overlapWidth
                }));

                const res = await fetch(`${API_BASE}/api/stitch/manual/batch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cameras: configs })
                });

                const data = await res.json();
                if(data.status === 'success') {
                    showToast('拼接配置已保存');
                    updateStitchStatus();
                } else {
                    showToast(data.message, 'error');
                }
            } else {
                showToast('拼接策略已切换');
                updateStitchStatus();
            }
        } catch(e) {
            showToast('保存失败: ' + e.message, 'error');
        }
    }

    async function saveCurrentConfig() {
        console.log('saveCurrentConfig called, currentTab =', currentTab);
        if (currentTab === 'stitch') {
            console.log('Saving stitch config');
            await saveStitchConfig();
        } else {
            console.warn('Unknown tab:', currentTab);
        }
    }

    async function resetManualConfig() {
        try {
            const res = await fetch(`${API_BASE}/api/stitch/manual/reset`, { method: 'POST' });
            const data = await res.json();
            if(data.status === 'success') {
                manualConfigs = {};
                loadManualConfigs();
                showToast('拼接配置已重置');
            }
        } catch(e) { showToast('重置失败', 'error'); }
    }

    async function resetCurrentConfig() {
        if (currentTab === 'stitch') {
            await resetManualConfig();
        } else if (currentTab === 'template') {
            // Template tab doesn't have a reset function
            showToast('模板管理不需要重置', 'warning');
        }
    }

    // 页面加载时更新拼接状态
    updateStitchStatus();

    // ESC 关闭模态框
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeModal();
            closeSystemConfigModal();
            closeImagePreview();
        }
    });
</script>
</body>
</html>
